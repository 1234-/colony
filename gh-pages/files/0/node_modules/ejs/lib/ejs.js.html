<h1>ejs</h1>
<pre><code class="lang-js"><span class="comment">/*!
 * EJS
 * Copyright(c) 2012 TJ Holowaychuk &lt;tj@vision-media.ca>
 * MIT Licensed
 */</span>

<span class="comment">/**
 * Module dependencies.
 */</span>

<span class="keyword">var</span> utils = require(<span class="string">'./utils'</span>)
  , path = require(<span class="string">'path'</span>)
  , basename = path.basename
  , dirname = path.dirname
  , extname = path.extname
  , join = path.join
  , fs = require(<span class="string">'fs'</span>)
  , read = fs.readFileSync;

<span class="comment">/**
 * Filters.
 * 
 * @type Object
 */</span>

<span class="keyword">var</span> filters = exports.filters = require(<span class="string">'./filters'</span>);

<span class="comment">/**
 * Intermediate js cache.
 * 
 * @type Object
 */</span>

<span class="keyword">var</span> cache = {};

<span class="comment">/**
 * Clear intermediate js cache.
 *
 * @api public
 */</span>

exports.clearCache = <span class="keyword">function</span>(){
  cache = {};
};

<span class="comment">/**
 * Translate filtered code into function calls.
 *
 * @param {String} js
 * @return {String}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">filtered</span><span class="params">(js)</span> {</span>
  <span class="keyword">return</span> js.substr(<span class="number">1</span>).split(<span class="string">'|'</span>).reduce(<span class="keyword">function</span>(js, filter){
    <span class="keyword">var</span> parts = filter.split(<span class="string">':'</span>)
      , name = parts.shift()
      , args = parts.shift() || <span class="string">''</span>;
    <span class="keyword">if</span> (args) args = <span class="string">', '</span> + args;
    <span class="keyword">return</span> <span class="string">'filters.'</span> + name + <span class="string">'('</span> + js + args + <span class="string">')'</span>;
  });
};

<span class="comment">/**
 * Re-throw the given `err` in context to the
 * `str` of ejs, `filename`, and `lineno`.
 *
 * @param {Error} err
 * @param {String} str
 * @param {String} filename
 * @param {String} lineno
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">rethrow</span><span class="params">(err, str, filename, lineno)</span>{</span>
  <span class="keyword">var</span> lines = str.split(<span class="string">'\n'</span>)
    , start = Math.max(lineno - <span class="number">3</span>, <span class="number">0</span>)
    , end = Math.min(lines.length, lineno + <span class="number">3</span>);

  <span class="comment">// Error context</span>
  <span class="keyword">var</span> context = lines.slice(start, end).map(<span class="keyword">function</span>(line, i){
    <span class="keyword">var</span> curr = i + start + <span class="number">1</span>;
    <span class="keyword">return</span> (curr == lineno ? <span class="string">' >> '</span> : <span class="string">'    '</span>)
      + curr
      + <span class="string">'| '</span>
      + line;
  }).join(<span class="string">'\n'</span>);

  <span class="comment">// Alter exception message</span>
  err.path = filename;
  err.message = (filename || <span class="string">'ejs'</span>) + <span class="string">':'</span> 
    + lineno + <span class="string">'\n'</span> 
    + context + <span class="string">'\n\n'</span> 
    + err.message;
  
  <span class="keyword">throw</span> err;
}

<span class="comment">/**
 * Parse the given `str` of ejs, returning the function body.
 *
 * @param {String} str
 * @return {String}
 * @api public
 */</span>

<span class="keyword">var</span> parse = exports.parse = <span class="keyword">function</span>(str, options){
  <span class="keyword">var</span> options = options || {}
    , open = options.open || exports.open || <span class="string">'&lt;%'</span>
    , close = options.close || exports.close || <span class="string">'%>'</span>
    , filename = options.filename
    , compileDebug = options.compileDebug !== <span class="literal">false</span>
    , buf = [];

  buf.push(<span class="string">'var buf = [];'</span>);
  <span class="keyword">if</span> (<span class="literal">false</span> !== options._<span class="keyword">with</span>) buf.push(<span class="string">'\nwith (locals || {}) {'</span>);
  buf.push(<span class="string">'\n buf.push(\''</span>);

  <span class="keyword">var</span> lineno = <span class="number">1</span>;

  <span class="keyword">var</span> consumeEOL = <span class="literal">false</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = str.length; i &lt; len; ++i) {
    <span class="keyword">if</span> (str.slice(i, open.length + i) == open) {
      i += open.length
  
      <span class="keyword">var</span> prefix, postfix, line = (compileDebug ? <span class="string">'__stack.lineno='</span> : <span class="string">''</span>) + lineno;
      <span class="keyword">switch</span> (str.substr(i, <span class="number">1</span>)) {
        <span class="keyword">case</span> <span class="string">'='</span>:
          prefix = <span class="string">"', escape(("</span> + line + <span class="string">', '</span>;
          postfix = <span class="string">")), '"</span>;
          ++i;
          <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="string">'-'</span>:
          prefix = <span class="string">"', ("</span> + line + <span class="string">', '</span>;
          postfix = <span class="string">"), '"</span>;
          ++i;
          <span class="keyword">break</span>;
        <span class="keyword">default</span>:
          prefix = <span class="string">"');"</span> + line + <span class="string">';'</span>;
          postfix = <span class="string">"; buf.push('"</span>;
      }

      <span class="keyword">var</span> end = str.indexOf(close, i)
        , js = str.substring(i, end)
        , start = i
        , include = <span class="literal">null</span>
        , n = <span class="number">0</span>;

      <span class="keyword">if</span> (<span class="string">'-'</span> == js[js.length-<span class="number">1</span>]){
        js = js.substring(<span class="number">0</span>, js.length - <span class="number">2</span>);
        consumeEOL = <span class="literal">true</span>;
      }

      <span class="keyword">if</span> (<span class="number">0</span> == js.trim().indexOf(<span class="string">'include'</span>)) {
        <span class="keyword">var</span> name = js.trim().slice(<span class="number">7</span>).trim();
        <span class="keyword">if</span> (!filename) <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'filename option is required for includes'</span>);
        <span class="keyword">var</span> path = resolveInclude(name, filename);
        include = read(path, <span class="string">'utf8'</span>);
        include = exports.parse(include, { filename: path, _<span class="keyword">with</span>: <span class="literal">false</span>, open: open, close: close });
        buf.push(<span class="string">"' + (function(){"</span> + include + <span class="string">"})() + '"</span>);
        js = <span class="string">''</span>;
      }

      <span class="keyword">while</span> (~(n = js.indexOf(<span class="string">"\n"</span>, n))) n++, lineno++;
      <span class="keyword">if</span> (js.substr(<span class="number">0</span>, <span class="number">1</span>) == <span class="string">':'</span>) js = filtered(js);
      <span class="keyword">if</span> (js) {
        <span class="keyword">if</span> (js.lastIndexOf(<span class="string">'//'</span>) > js.lastIndexOf(<span class="string">'\n'</span>)) js += <span class="string">'\n'</span>;
        buf.push(prefix, js, postfix);
      }
      i += end - start + close.length - <span class="number">1</span>;

    } <span class="keyword">else</span> <span class="keyword">if</span> (str.substr(i, <span class="number">1</span>) == <span class="string">"\\"</span>) {
      buf.push(<span class="string">"\\\\"</span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (str.substr(i, <span class="number">1</span>) == <span class="string">"'"</span>) {
      buf.push(<span class="string">"\\'"</span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (str.substr(i, <span class="number">1</span>) == <span class="string">"\r"</span>) {
      buf.push(<span class="string">" "</span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (str.substr(i, <span class="number">1</span>) == <span class="string">"\n"</span>) {
      <span class="keyword">if</span> (consumeEOL) {
        consumeEOL = <span class="literal">false</span>;
      } <span class="keyword">else</span> {
        buf.push(<span class="string">"\\n"</span>);
        lineno++;
      }
    } <span class="keyword">else</span> {
      buf.push(str.substr(i, <span class="number">1</span>));
    }
  }

  <span class="keyword">if</span> (<span class="literal">false</span> !== options._<span class="keyword">with</span>) buf.push(<span class="string">"');\n}\nreturn buf.join('');"</span>)
  <span class="keyword">else</span> buf.push(<span class="string">"');\nreturn buf.join('');"</span>);

  <span class="keyword">return</span> buf.join(<span class="string">''</span>);
};

<span class="comment">/**
 * Compile the given `str` of ejs into a `Function`.
 *
 * @param {String} str
 * @param {Object} options
 * @return {Function}
 * @api public
 */</span>

<span class="keyword">var</span> compile = exports.compile = <span class="keyword">function</span>(str, options){
  options = options || {};
  
  <span class="keyword">var</span> input = JSON.stringify(str)
    , compileDebug = options.compileDebug !== <span class="literal">false</span>
    , client = options.client
    , filename = options.filename
        ? JSON.stringify(options.filename)
        : <span class="string">'undefined'</span>;
  
  <span class="keyword">if</span> (compileDebug) {
    <span class="comment">// Adds the fancy stack trace meta info</span>
    str = [
      <span class="string">'var __stack = { lineno: 1, input: '</span> + input + <span class="string">', filename: '</span> + filename + <span class="string">' };'</span>,
      rethrow.toString(),
      <span class="string">'try {'</span>,
      exports.parse(str, options),
      <span class="string">'} catch (err) {'</span>,
      <span class="string">'  rethrow(err, __stack.input, __stack.filename, __stack.lineno);'</span>,
      <span class="string">'}'</span>
    ].join(<span class="string">"\n"</span>);
  } <span class="keyword">else</span> {
    str = exports.parse(str, options);
  }
  
  <span class="keyword">if</span> (options.debug) console.log(str);
  <span class="keyword">if</span> (client) str = <span class="string">'escape = escape || '</span> + utils.escape.toString() + <span class="string">';\n'</span> + str;

  <span class="keyword">var</span> fn = <span class="keyword">new</span> Function(<span class="string">'locals, filters, escape'</span>, str);

  <span class="keyword">if</span> (client) <span class="keyword">return</span> fn;

  <span class="keyword">return</span> <span class="keyword">function</span>(locals){
    <span class="keyword">return</span> fn.call(<span class="keyword">this</span>, locals, filters, utils.escape);
  }
};

<span class="comment">/**
 * Render the given `str` of ejs.
 *
 * Options:
 *
 *   - `locals`          Local variables object
 *   - `cache`           Compiled functions are cached, requires `filename`
 *   - `filename`        Used by `cache` to key caches
 *   - `scope`           Function execution context
 *   - `debug`           Output generated function body
 *   - `open`            Open tag, defaulting to "&lt;%"
 *   - `close`           Closing tag, defaulting to "%>"
 *
 * @param {String} str
 * @param {Object} options
 * @return {String}
 * @api public
 */</span>

exports.render = <span class="keyword">function</span>(str, options){
  <span class="keyword">var</span> fn
    , options = options || {};

  <span class="keyword">if</span> (options.cache) {
    <span class="keyword">if</span> (options.filename) {
      fn = cache[options.filename] || (cache[options.filename] = compile(str, options));
    } <span class="keyword">else</span> {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'"cache" option requires "filename".'</span>);
    }
  } <span class="keyword">else</span> {
    fn = compile(str, options);
  }

  options.__proto__ = options.locals;
  <span class="keyword">return</span> fn.call(options.scope, options);
};

<span class="comment">/**
 * Render an EJS file at the given `path` and callback `fn(err, str)`.
 *
 * @param {String} path
 * @param {Object|Function} options or callback
 * @param {Function} fn
 * @api public
 */</span>

exports.renderFile = <span class="keyword">function</span>(path, options, fn){
  <span class="keyword">var</span> key = path + <span class="string">':string'</span>;

  <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> options) {
    fn = options, options = {};
  }

  options.filename = path;

  <span class="keyword">try</span> {
    <span class="keyword">var</span> str = options.cache
      ? cache[key] || (cache[key] = read(path, <span class="string">'utf8'</span>))
      : read(path, <span class="string">'utf8'</span>);

    fn(<span class="literal">null</span>, exports.render(str, options));
  } <span class="keyword">catch</span> (err) {
    fn(err);
  }
};

<span class="comment">/**
 * Resolve include `name` relative to `filename`.
 *
 * @param {String} name
 * @param {String} filename
 * @return {String}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">resolveInclude</span><span class="params">(name, filename)</span> {</span>
  <span class="keyword">var</span> path = join(dirname(filename), name);
  <span class="keyword">var</span> ext = extname(name);
  <span class="keyword">if</span> (!ext) path += <span class="string">'.ejs'</span>;
  <span class="keyword">return</span> path;
}

<span class="comment">// express support</span>

exports.__express = exports.renderFile;

<span class="comment">/**
 * Expose to require().
 */</span>

<span class="keyword">if</span> (require.extensions) {
  require.extensions[<span class="string">'.ejs'</span>] = <span class="keyword">function</span>(module, filename) {
    source = require(<span class="string">'fs'</span>).readFileSync(filename, <span class="string">'utf-8'</span>);
    module._compile(compile(source, {}), filename);
  };
} <span class="keyword">else</span> <span class="keyword">if</span> (require.registerExtension) {
  require.registerExtension(<span class="string">'.ejs'</span>, <span class="keyword">function</span>(src) {
    <span class="keyword">return</span> compile(src, {});
  });
}
</code></pre>