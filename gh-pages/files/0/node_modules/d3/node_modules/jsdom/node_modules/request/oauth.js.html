<h1>oauth.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> crypto = require(<span class="string">'crypto'</span>)
  , qs = require(<span class="string">'querystring'</span>)
  ;

<span class="function"><span class="keyword">function</span> <span class="title">sha1</span> <span class="params">(key, body)</span> {</span>
  <span class="keyword">return</span> crypto.createHmac(<span class="string">'sha1'</span>, key).update(body).digest(<span class="string">'base64'</span>)
}

<span class="function"><span class="keyword">function</span> <span class="title">rfc3986</span> <span class="params">(str)</span> {</span>
  <span class="keyword">return</span> encodeURIComponent(str)
    .replace(<span class="regexp">/!/g</span>,<span class="string">'%21'</span>)
    .replace(<span class="regexp">/\*/g</span>,<span class="string">'%2A'</span>)
    .replace(<span class="regexp">/\(/g</span>,<span class="string">'%28'</span>)
    .replace(<span class="regexp">/\)/g</span>,<span class="string">'%29'</span>)
    .replace(<span class="regexp">/'/g</span>,<span class="string">'%27'</span>)
    ;
}

<span class="function"><span class="keyword">function</span> <span class="title">hmacsign</span> <span class="params">(httpMethod, base_uri, params, consumer_secret, token_secret, body)</span> {</span>
  <span class="comment">// adapted from https://dev.twitter.com/docs/auth/oauth</span>
  <span class="keyword">var</span> base = 
    (httpMethod || <span class="string">'GET'</span>) + <span class="string">"&amp;"</span> +
    encodeURIComponent(  base_uri ) + <span class="string">"&amp;"</span> +
    Object.keys(params).sort().map(<span class="function"><span class="keyword">function</span> <span class="params">(i)</span> {</span>
      <span class="comment">// big WTF here with the escape + encoding but it's what twitter wants</span>
      <span class="keyword">return</span> escape(rfc3986(i)) + <span class="string">"%3D"</span> + escape(rfc3986(params[i]))
    }).join(<span class="string">"%26"</span>)
  <span class="keyword">var</span> key = encodeURIComponent(consumer_secret) + <span class="string">'&amp;'</span>
  <span class="keyword">if</span> (token_secret) key += encodeURIComponent(token_secret)
  <span class="keyword">return</span> sha1(key, base)
}

exports.hmacsign = hmacsign
exports.rfc3986 = rfc3986</code></pre>