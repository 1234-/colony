<h1>bindings</h1>
<pre><code class="lang-js"><span class="comment">/**
 * Module dependencies.
 */</span>

<span class="keyword">var</span> fs = require(<span class="string">'fs'</span>)
  , path = require(<span class="string">'path'</span>)
  , join = path.join
  , dirname = path.dirname
  , exists = fs.existsSync || path.existsSync
  , defaults = {
        arrow: process.env.NODE_BINDINGS_ARROW || <span class="string">' â†’ '</span>
      , compiled: process.env.NODE_BINDINGS_COMPILED_DIR || <span class="string">'compiled'</span>
      , platform: process.platform
      , arch: process.arch
      , version: process.versions.node
      , bindings: <span class="string">'bindings.node'</span>
      , <span class="keyword">try</span>: [
          <span class="comment">// node-gyp's linked version in the "build" dir</span>
          [ <span class="string">'module_root'</span>, <span class="string">'build'</span>, <span class="string">'bindings'</span> ]
          <span class="comment">// node-waf and gyp_addon (a.k.a node-gyp)</span>
        , [ <span class="string">'module_root'</span>, <span class="string">'build'</span>, <span class="string">'Debug'</span>, <span class="string">'bindings'</span> ]
        , [ <span class="string">'module_root'</span>, <span class="string">'build'</span>, <span class="string">'Release'</span>, <span class="string">'bindings'</span> ]
          <span class="comment">// Debug files, for development (legacy behavior, remove for node v0.9)</span>
        , [ <span class="string">'module_root'</span>, <span class="string">'out'</span>, <span class="string">'Debug'</span>, <span class="string">'bindings'</span> ]
        , [ <span class="string">'module_root'</span>, <span class="string">'Debug'</span>, <span class="string">'bindings'</span> ]
          <span class="comment">// Release files, but manually compiled (legacy behavior, remove for node v0.9)</span>
        , [ <span class="string">'module_root'</span>, <span class="string">'out'</span>, <span class="string">'Release'</span>, <span class="string">'bindings'</span> ]
        , [ <span class="string">'module_root'</span>, <span class="string">'Release'</span>, <span class="string">'bindings'</span> ]
          <span class="comment">// Legacy from node-waf, node &lt;= 0.4.x</span>
        , [ <span class="string">'module_root'</span>, <span class="string">'build'</span>, <span class="string">'default'</span>, <span class="string">'bindings'</span> ]
          <span class="comment">// Production "Release" buildtype binary (meh...)</span>
        , [ <span class="string">'module_root'</span>, <span class="string">'compiled'</span>, <span class="string">'version'</span>, <span class="string">'platform'</span>, <span class="string">'arch'</span>, <span class="string">'bindings'</span> ]
        ]
    }

<span class="comment">/**
 * The main `bindings()` function loads the compiled bindings for a given module.
 * It uses V8's Error API to determine the parent filename that this function is
 * being invoked from, which is then used to find the root directory.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">bindings</span> <span class="params">(opts)</span> {</span>

  <span class="comment">// Argument surgery</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> opts == <span class="string">'string'</span>) {
    opts = { bindings: opts }
  } <span class="keyword">else</span> <span class="keyword">if</span> (!opts) {
    opts = {}
  }
  opts.__proto__ = defaults

  <span class="comment">// Get the module root</span>
  <span class="keyword">if</span> (!opts.module_root) {
    opts.module_root = exports.getRoot(exports.getFileName())
  }

  <span class="comment">// Ensure the given bindings name ends with .node</span>
  <span class="keyword">if</span> (path.extname(opts.bindings) != <span class="string">'.node'</span>) {
    opts.bindings += <span class="string">'.node'</span>
  }

  <span class="keyword">var</span> tries = []
    , i = <span class="number">0</span>
    , l = opts.<span class="keyword">try</span>.length
    , n

  <span class="keyword">for</span> (; i&lt;l; i++) {
    n = join.apply(<span class="literal">null</span>, opts.<span class="keyword">try</span>[i].map(<span class="function"><span class="keyword">function</span> <span class="params">(p)</span> {</span>
      <span class="keyword">return</span> opts[p] || p
    }))
    tries.push(n)
    <span class="keyword">try</span> {
      <span class="keyword">var</span> b = require(n)
      b.path = n
      <span class="keyword">return</span> b
    } <span class="keyword">catch</span> (e) {
      <span class="keyword">if</span> (!<span class="regexp">/not find/i</span>.test(e.message)) {
        <span class="keyword">throw</span> e
      }
    }
  }

  <span class="keyword">var</span> err = <span class="keyword">new</span> Error(<span class="string">'Could not load the bindings file. Tried:\n'</span>
    + tries.map(<span class="function"><span class="keyword">function</span> <span class="params">(a)</span> {</span> <span class="keyword">return</span> opts.arrow + a }).join(<span class="string">'\n'</span>))
  err.tries = tries
  <span class="keyword">throw</span> err
}
module.exports = exports = bindings


<span class="comment">/**
 * Gets the filename of the JavaScript file that invokes this function.
 * Used to help find the root directory of a module.
 */</span>

exports.getFileName = <span class="function"><span class="keyword">function</span> <span class="title">getFileName</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> origPST = Error.prepareStackTrace
    , dummy = {}
    , fileName

  Error.prepareStackTrace = <span class="function"><span class="keyword">function</span> <span class="params">(e, st)</span> {</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>, l=st.length; i&lt;l; i++) {
      fileName = st[i].getFileName()
      <span class="keyword">if</span> (fileName !== __filename) {
        <span class="keyword">return</span>
      }
    }
  }

  <span class="comment">// run the 'prepareStackTrace' function above</span>
  Error.captureStackTrace(dummy)
  dummy.stack

  <span class="comment">// cleanup</span>
  Error.prepareStackTrace = origPST

  <span class="keyword">return</span> fileName
}

<span class="comment">/**
 * Gets the root directory of a module, given an arbitrary filename
 * somewhere in the module tree. The "root directory" is the directory
 * containing the `package.json` file.
 *
 *   In:  /home/nate/node-native-module/lib/index.js
 *   Out: /home/nate/node-native-module
 */</span>

exports.getRoot = <span class="function"><span class="keyword">function</span> <span class="title">getRoot</span> <span class="params">(file)</span> {</span>
  <span class="keyword">var</span> dir = dirname(file)
    , prev
  <span class="keyword">while</span> (<span class="literal">true</span>) {
    <span class="keyword">if</span> (dir === <span class="string">'.'</span>) {
      <span class="comment">// Avoids an infinite loop in rare cases, like the REPL</span>
      dir = process.cwd()
    }
    <span class="keyword">if</span> (exists(join(dir, <span class="string">'package.json'</span>)) || exists(join(dir, <span class="string">'node_modules'</span>))) {
      <span class="comment">// Found the 'package.json' file or 'node_modules' dir; we're done</span>
      <span class="keyword">return</span> dir
    }
    <span class="keyword">if</span> (prev === dir) {
      <span class="comment">// Got to the top</span>
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Could not find module root given file: "'</span> + file
                    + <span class="string">'". Do you have a `package.json` file? '</span>)
    }
    <span class="comment">// Try the parent dir next</span>
    prev = dir
    dir = join(dir, <span class="string">'..'</span>)
  }
}
</code></pre>