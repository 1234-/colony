<h1>jar.js</h1>
<pre><code class="lang-js"><span class="comment">/*!
* Tobi - CookieJar
* Copyright(c) 2010 LearnBoost &lt;dev@learnboost.com>
* MIT Licensed
*/</span>

<span class="comment">/**
* Module dependencies.
*/</span>

<span class="keyword">var</span> url = require(<span class="string">'url'</span>);

<span class="comment">/**
* Initialize a new `CookieJar`.
*
* @api private
*/</span>

<span class="keyword">var</span> CookieJar = exports = module.exports = <span class="function"><span class="keyword">function</span> <span class="title">CookieJar</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>.cookies = [];
};

<span class="comment">/**
* Add the given `cookie` to the jar.
*
* @param {Cookie} cookie
* @api private
*/</span>

CookieJar.prototype.add = <span class="keyword">function</span>(cookie){
  <span class="keyword">this</span>.cookies = <span class="keyword">this</span>.cookies.filter(<span class="keyword">function</span>(c){
    <span class="comment">// Avoid duplication (same path, same name)</span>
    <span class="keyword">return</span> !(c.name == cookie.name &amp;&amp; c.path == cookie.path);
  });
  <span class="keyword">this</span>.cookies.push(cookie);
};

<span class="comment">/**
* Get cookies for the given `req`.
*
* @param {IncomingRequest} req
* @return {Array}
* @api private
*/</span>

CookieJar.prototype.get = <span class="keyword">function</span>(req){
  <span class="keyword">var</span> path = url.parse(req.url).pathname
    , now = <span class="keyword">new</span> Date
    , specificity = {};
  <span class="keyword">return</span> <span class="keyword">this</span>.cookies.filter(<span class="keyword">function</span>(cookie){
    <span class="keyword">if</span> (<span class="number">0</span> == path.indexOf(cookie.path) &amp;&amp; now &lt; cookie.expires
      &amp;&amp; cookie.path.length > (specificity[cookie.name] || <span class="number">0</span>))
      <span class="keyword">return</span> specificity[cookie.name] = cookie.path.length;
  });
};

<span class="comment">/**
* Return Cookie string for the given `req`.
*
* @param {IncomingRequest} req
* @return {String}
* @api private
*/</span>

CookieJar.prototype.cookieString = <span class="keyword">function</span>(req){
  <span class="keyword">var</span> cookies = <span class="keyword">this</span>.get(req);
  <span class="keyword">if</span> (cookies.length) {
    <span class="keyword">return</span> cookies.map(<span class="keyword">function</span>(cookie){
      <span class="keyword">return</span> cookie.name + <span class="string">'='</span> + cookie.value;
    }).join(<span class="string">'; '</span>);
  }
};
</code></pre>