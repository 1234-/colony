<h1>core.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> core                     = require(<span class="string">"../level1/core"</span>).dom.level1.core;

<span class="comment">// modify cloned instance for more info check: https://github.com/tmpvar/jsdom/issues/325</span>
core = Object.create(core);

<span class="keyword">var</span> INVALID_STATE_ERR        = core.INVALID_STATE_ERR        = <span class="number">11</span>,
    SYNTAX_ERR               = core.SYNTAX_ERR               = <span class="number">12</span>,
    INVALID_MODIFICATION_ERR = core.INVALID_MODIFICATION_ERR = <span class="number">13</span>,
    NAMESPACE_ERR            = core.NAMESPACE_ERR            = <span class="number">14</span>,
    INVALID_ACCESS_ERR       = core.INVALID_ACCESS_ERR       = <span class="number">15</span>,
    ns = {
      validate : <span class="keyword">function</span>(ns, URI) {
        <span class="keyword">if</span> (!ns) {
          <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.INVALID_CHARACTER_ERR, <span class="string">"namespace is undefined"</span>);
        }

        <span class="keyword">if</span>(ns.match(<span class="regexp">/[^0-9a-z\.:\-_]/i</span>) !== <span class="literal">null</span>) {
          <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.INVALID_CHARACTER_ERR, ns);
        }

        <span class="keyword">var</span> msg = <span class="literal">false</span>, parts = ns.split(<span class="string">':'</span>);
        <span class="keyword">if</span> (ns === <span class="string">'xmlns'</span>                          &amp;&amp;
            URI !== <span class="string">"http://www.w3.org/2000/xmlns/"</span>)
        {
          msg = <span class="string">"localName is 'xmlns' but the namespaceURI is invalid"</span>;

        } <span class="keyword">else</span> <span class="keyword">if</span> (ns === <span class="string">"xml"</span>                                   &amp;&amp;
                   URI !== <span class="string">"http://www.w3.org/XML/1998/namespace"</span>)
        {
          msg = <span class="string">"localName is 'xml' but the namespaceURI is invalid"</span>;

        } <span class="keyword">else</span> <span class="keyword">if</span> (ns[ns.length-<span class="number">1</span>] === <span class="string">':'</span>) {
          msg = <span class="string">"Namespace seperator found with no localName"</span>;

        } <span class="keyword">else</span> <span class="keyword">if</span> (ns[<span class="number">0</span>] === <span class="string">':'</span>) {
          msg = <span class="string">"Namespace seperator found, without a prefix"</span>;

        } <span class="keyword">else</span> <span class="keyword">if</span> (parts.length > <span class="number">2</span>) {
          msg = <span class="string">"Too many namespace seperators"</span>;

        }

        <span class="keyword">if</span> (msg) {
          <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NAMESPACE_ERR, msg + <span class="string">" ("</span> + ns + <span class="string">"@"</span> + URI + <span class="string">")"</span>);
        }
      }
    };

core.exceptionMessages[<span class="string">'NAMESPACE_ERR'</span>] = <span class="string">"Invalid namespace"</span>;

core.DOMImplementation.prototype.createDocumentType = <span class="keyword">function</span>(<span class="comment">/* String */</span> qualifiedName,
                                                               <span class="comment">/* String */</span> publicId,
                                                               <span class="comment">/* String */</span> systemId)
{
  ns.validate(qualifiedName);
  <span class="keyword">var</span> doctype = <span class="keyword">new</span> core.DocumentType(<span class="literal">null</span>, qualifiedName);
  doctype._publicId = publicId ? publicId : <span class="string">''</span>;
  doctype._systemId = systemId ? systemId : <span class="string">''</span>;
  <span class="keyword">return</span> doctype;
};

<span class="comment">/**
  Creates an XML Document object of the specified type with its document element.
  HTML-only DOM implementations do not need to implement this method.
*/</span>
core.DOMImplementation.prototype.createDocument = <span class="keyword">function</span>(<span class="comment">/* String */</span>       namespaceURI,
                                                           <span class="comment">/* String */</span>       qualifiedName,
                                                           <span class="comment">/* DocumentType */</span> doctype)
{
  <span class="keyword">if</span> (qualifiedName || namespaceURI) {
    ns.validate(qualifiedName, namespaceURI);
  }

  <span class="keyword">if</span> (doctype &amp;&amp; doctype._ownerDocument !== <span class="literal">null</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.WRONG_DOCUMENT_ERR);
  }

  <span class="keyword">if</span> (qualifiedName &amp;&amp; qualifiedName.indexOf(<span class="string">':'</span>) > -<span class="number">1</span> &amp;&amp; !namespaceURI) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NAMESPACE_ERR);
  }

  <span class="keyword">var</span> document = <span class="keyword">new</span> core.Document();
  
  <span class="keyword">if</span> (doctype) {
    document.doctype = doctype;
    doctype._ownerDocument = document;
    document.appendChild(doctype);
  } <span class="keyword">else</span> {
    document.doctype = <span class="literal">null</span>;
  }

  <span class="keyword">if</span> (doctype &amp;&amp; !doctype.entities) {
    doctype.entities = <span class="keyword">new</span> dom.EntityNodeMap();
  }

  document._ownerDocument = document;

  <span class="keyword">if</span> (qualifiedName) {
    <span class="keyword">var</span> docElement = document.createElementNS(namespaceURI, qualifiedName);
    document.appendChild(docElement);
  }

  <span class="keyword">return</span> document;
};

core.Node.prototype.__defineGetter__(<span class="string">"ownerDocument"</span>, <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>._ownerDocument || <span class="literal">null</span>;
});

core.Node.prototype.isSupported = <span class="keyword">function</span>(<span class="comment">/* string */</span> feature,
                                           <span class="comment">/* string */</span> version)
{
  <span class="keyword">return</span> <span class="keyword">this</span>._ownerDocument.implementation.hasFeature(feature, version);
};

core.Node.prototype._namespaceURI = <span class="literal">null</span>;
core.Node.prototype.__defineGetter__(<span class="string">"namespaceURI"</span>, <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>._namespaceURI || <span class="literal">null</span>;
});

core.Node.prototype.__defineSetter__(<span class="string">"namespaceURI"</span>, <span class="keyword">function</span>(value) {
  <span class="keyword">this</span>._namespaceURI = value;
});

core.Node.prototype.__defineGetter__(<span class="string">"prefix"</span>, <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>._prefix || <span class="literal">null</span>;
});

core.Node.prototype.__defineSetter__(<span class="string">"prefix"</span>, <span class="keyword">function</span>(value) {

  <span class="keyword">if</span> (<span class="keyword">this</span>.readonly) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.NO_MODIFICATION_ALLOWED_ERR);
  }

  ns.validate(value, <span class="keyword">this</span>._namespaceURI);

  <span class="keyword">if</span> ((<span class="keyword">this</span>._created &amp;&amp; !<span class="keyword">this</span>._namespaceURI)  ||
      <span class="keyword">this</span>._prefix === <span class="string">"xmlns"</span>                ||
      (!<span class="keyword">this</span>._prefix &amp;&amp; <span class="keyword">this</span>._created))
  {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.NAMESPACE_ERR);
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>._localName) {
    <span class="keyword">this</span>._nodeName = value + <span class="string">':'</span> + <span class="keyword">this</span>._localName;
  }

  <span class="keyword">this</span>._prefix = value;
});

core.Node.prototype.__defineGetter__(<span class="string">"localName"</span>, <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>._localName || <span class="literal">null</span>;
});

<span class="comment">/* return boolean */</span>
core.Node.prototype.hasAttributes = <span class="keyword">function</span>() {
  <span class="keyword">return</span> (<span class="keyword">this</span>.nodeType === <span class="keyword">this</span>.ELEMENT_NODE &amp;&amp;
          <span class="keyword">this</span>._attributes                    &amp;&amp;
          <span class="keyword">this</span>._attributes.length > <span class="number">0</span>);
};

core.NamedNodeMap.prototype.getNamedItemNS = <span class="keyword">function</span>(<span class="comment">/* string */</span> namespaceURI,
                                                      <span class="comment">/* string */</span> localName)
{
  <span class="keyword">if</span> (<span class="keyword">this</span>._nsStore[namespaceURI] &amp;&amp; <span class="keyword">this</span>._nsStore[namespaceURI][localName]) {
    <span class="keyword">return</span> <span class="keyword">this</span>._nsStore[namespaceURI][localName];
  }
  <span class="keyword">return</span> <span class="literal">null</span>;
};

core.AttrNodeMap.prototype.setNamedItemNS = <span class="keyword">function</span>(<span class="comment">/* Node */</span> arg) {
  <span class="keyword">if</span> (arg.nodeType !== <span class="keyword">this</span>._ownerDocument.ATTRIBUTE_NODE) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.HIERARCHY_REQUEST_ERR);
  }

  <span class="keyword">return</span> core.NamedNodeMap.prototype.setNamedItemNS.call(<span class="keyword">this</span>, arg);
};

<span class="keyword">var</span> prevSetNamedItem = core.AttrNodeMap.prototype.setNamedItem;

core.AttrNodeMap.prototype.setNamedItem = <span class="keyword">function</span>(<span class="comment">/* Node */</span> arg) {
  <span class="keyword">if</span> (arg.nodeType !== <span class="keyword">this</span>._ownerDocument.ATTRIBUTE_NODE) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.HIERARCHY_REQUEST_ERR);
  }

  <span class="keyword">return</span> prevSetNamedItem.call(<span class="keyword">this</span>, arg);
};


core.NamedNodeMap.prototype.setNamedItemNS = <span class="keyword">function</span>(<span class="comment">/* Node */</span> arg)
{
  <span class="keyword">if</span> (<span class="keyword">this</span>._readonly) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.NO_MODIFICATION_ALLOWED_ERR);
  }

  <span class="keyword">var</span> owner = <span class="keyword">this</span>._ownerDocument;
  <span class="keyword">if</span> (<span class="keyword">this</span>._parentNode &amp;&amp;
      <span class="keyword">this</span>._parentNode._parentNode &amp;&amp;
      <span class="keyword">this</span>._parentNode._parentNode.nodeType === owner.ENTITY_NODE)
  {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.NO_MODIFICATION_ALLOWED_ERR);
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>._ownerDocument !== arg.ownerDocument) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.WRONG_DOCUMENT_ERR);
  }

  <span class="keyword">if</span> (arg._ownerElement) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.INUSE_ATTRIBUTE_ERR);
  }

  <span class="comment">// readonly</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._readonly === <span class="literal">true</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR);
  }


  <span class="keyword">if</span> (!<span class="keyword">this</span>._nsStore[arg.namespaceURI]) {
    <span class="keyword">this</span>._nsStore[arg.namespaceURI] = {};
  }
  <span class="keyword">var</span> existing = <span class="literal">null</span>;
  <span class="keyword">if</span> (<span class="keyword">this</span>._nsStore[arg.namespaceURI][arg.localName]) {
    <span class="keyword">var</span> existing = <span class="keyword">this</span>._nsStore[arg.namespaceURI][arg.localName];
  }

  <span class="keyword">this</span>._nsStore[arg.namespaceURI][arg.localName] = arg;

  arg._specified = <span class="literal">true</span>;
  arg._ownerDocument = <span class="keyword">this</span>._ownerDocument;

  <span class="keyword">return</span> <span class="keyword">this</span>.setNamedItem(arg);
};

core.NamedNodeMap.prototype.removeNamedItemNS = <span class="keyword">function</span>(<span class="comment">/*string */</span> namespaceURI,
                                                         <span class="comment">/* string */</span> localName)
{

  <span class="keyword">if</span> (<span class="keyword">this</span>.readonly) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.NO_MODIFICATION_ALLOWED_ERR);
  }


  <span class="keyword">var</span> parent = <span class="keyword">this</span>._parentNode,
      found = <span class="literal">null</span>,
      defaults,
      clone,
      defaultEl,
      defaultAttr;

  <span class="keyword">if</span> (<span class="keyword">this</span>._parentNode &amp;&amp;
      <span class="keyword">this</span>._parentNode._parentNode &amp;&amp;
      <span class="keyword">this</span>._parentNode._parentNode.nodeType === <span class="keyword">this</span>._ownerDocument.ENTITY_NODE)
  {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.NO_MODIFICATION_ALLOWED_ERR);
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>._nsStore[namespaceURI] &amp;&amp;
      <span class="keyword">this</span>._nsStore[namespaceURI][localName])
  {
    found = <span class="keyword">this</span>._nsStore[namespaceURI][localName];
    <span class="keyword">this</span>.removeNamedItem(found.qualifiedName);
    <span class="keyword">delete</span> <span class="keyword">this</span>._nsStore[namespaceURI][localName];
  }

  <span class="keyword">if</span> (!found) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.NOT_FOUND_ERR);
  }

  <span class="keyword">if</span> (parent.ownerDocument.doctype &amp;&amp; parent.ownerDocument.doctype._attributes) {
    defaults = parent.ownerDocument.doctype._attributes;
    defaultEl = defaults.getNamedItemNS(parent._namespaceURI, parent._localName);
  }

  <span class="keyword">if</span> (defaultEl) {
    defaultAttr = defaultEl._attributes.getNamedItemNS(namespaceURI, localName);

    <span class="keyword">if</span> (defaultAttr) {
      clone = defaultAttr.cloneNode(<span class="literal">true</span>);
      clone._created               = <span class="literal">false</span>;
      clone._namespaceURI          = found._namespaceURI;
      clone._nodeName              = found.name;
      clone._localName             = found._localName;
      clone._prefix                = found._prefix
      <span class="keyword">this</span>.setNamedItemNS(clone);
      clone._created               = <span class="literal">true</span>;
      clone._specified             = <span class="literal">false</span>;
    }
  }

  <span class="keyword">return</span> found;
};

core.Attr.prototype.__defineGetter__(<span class="string">"ownerElement"</span>, <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>._ownerElement || <span class="literal">null</span>;
});


core.Node.prototype._prefix = <span class="literal">false</span>;

core.Node.prototype.__defineSetter__(<span class="string">"qualifiedName"</span>, <span class="keyword">function</span>(qualifiedName) {
  ns.validate(qualifiedName, <span class="keyword">this</span>._namespaceURI);
  qualifiedName       = qualifiedName || <span class="string">""</span>;
  <span class="keyword">this</span>._localName     = qualifiedName.split(<span class="string">":"</span>)[<span class="number">1</span>] || <span class="literal">null</span>;
  <span class="keyword">this</span>.prefix         = qualifiedName.split(<span class="string">":"</span>)[<span class="number">0</span>] || <span class="literal">null</span>;
  <span class="keyword">this</span>._nodeName = qualifiedName;
});

core.Node.prototype.__defineGetter__(<span class="string">"qualifiedName"</span>, <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>._nodeName;
});

core.NamedNodeMap.prototype._map = <span class="keyword">function</span>(fn) {
  <span class="keyword">var</span> ret = [], l = <span class="keyword">this</span>.length, i = <span class="number">0</span>, node;
  <span class="keyword">for</span>(i; i&lt;l; i++) {
    node = <span class="keyword">this</span>.item(i);
    <span class="keyword">if</span> (fn &amp;&amp; fn(node)) {
      ret.push(node);
    }
  }
  <span class="keyword">return</span> ret;
};

core.Element.prototype.getAttributeNS = <span class="keyword">function</span>(<span class="comment">/* string */</span> namespaceURI,
                                                 <span class="comment">/* string */</span> localName)
{
  <span class="keyword">var</span> attr =  <span class="keyword">this</span>._attributes.getNamedItemNS(namespaceURI, localName);
  <span class="keyword">return</span> (attr) ? attr.nodeValue : <span class="string">''</span>;
};

core.Element.prototype.setAttributeNS = <span class="keyword">function</span>(<span class="comment">/* string */</span> namespaceURI,
                                                 <span class="comment">/* string */</span> qualifiedName,
                                                 <span class="comment">/* string */</span> value)
{
  <span class="keyword">var</span> s       = qualifiedName.split(<span class="string">':'</span>),
      local   = s.pop(),
      prefix  = s.pop() || <span class="literal">null</span>,
      attr;

  ns.validate(qualifiedName, namespaceURI);

  <span class="keyword">if</span> (qualifiedName.split(<span class="string">':'</span>).shift() === <span class="string">"xml"</span> &amp;&amp;
      namespaceURI !== <span class="string">"http://www.w3.org/XML/1998/namespace"</span>)
  {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.NAMESPACE_ERR);
  }

  <span class="keyword">if</span> (prefix === <span class="string">"xmlns"</span> &amp;&amp; namespaceURI !== <span class="string">"http://www.w3.org/2000/xmlns/"</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.NAMESPACE_ERR);
  }

  <span class="keyword">if</span> (qualifiedName.split(<span class="string">':'</span>).length > <span class="number">1</span> &amp;&amp; !namespaceURI) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.NAMESPACE_ERR);
  }

  attr = <span class="keyword">this</span>._attributes.getNamedItemNS(namespaceURI, local);

  <span class="keyword">if</span> (!attr) {
    attr = <span class="keyword">this</span>.ownerDocument.createAttributeNS(namespaceURI,
                                                qualifiedName,
                                                value);
    <span class="keyword">this</span>._attributes.setNamedItemNS(attr);
  }

  attr._namespaceURI = namespaceURI;
  attr._prefix    = prefix;
  attr._created = <span class="literal">true</span>;
  attr.value = value;
  attr._localName = local;
};

core.Element.prototype.removeAttributeNS = <span class="keyword">function</span>(<span class="comment">/* string */</span> namespaceURI,
                                                    <span class="comment">/* string */</span> localName)
{

  <span class="keyword">if</span> (<span class="keyword">this</span>.readonly) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.NO_MODIFICATION_ALLOWED_ERR);
  }

  <span class="keyword">var</span> ownerDoc = <span class="keyword">this</span>.ownerDocument,
      defaults,
      clone,
      defaultEl,
      defaultAttr,
      clone,
      localName;

  <span class="keyword">if</span> (ownerDoc.doctype &amp;&amp; ownerDoc.doctype._attributes) {
    defaults = ownerDoc.doctype._attributes;
    defaultEl = defaults.getNamedItemNS(namespaceURI, <span class="keyword">this</span>.localName);
  }

  <span class="keyword">if</span> (defaultEl) {
    defaultAttr = defaultEl.getAttributeNodeNS(namespaceURI, localName);
  }

  <span class="keyword">this</span>._attributes.removeNamedItemNS(namespaceURI, localName);

  <span class="keyword">if</span> (defaultAttr) {
    <span class="keyword">this</span>.setAttributeNS(defaultAttr.namespaceURI,
                                defaultAttr.name,
                                defaultAttr.value);
    localName = defaultAttr.name.split(<span class="string">':'</span>).pop();
    clone = <span class="keyword">this</span>.getAttributeNS(defaultAttr.namespaceURI, localName);
    clone._specified = <span class="literal">false</span>;
  }
};

core.Element.prototype.getAttributeNodeNS = <span class="keyword">function</span>(<span class="comment">/* string */</span> namespaceURI,
                                                     <span class="comment">/* string */</span> localName)
{
  <span class="keyword">return</span> <span class="keyword">this</span>._attributes.getNamedItemNS(namespaceURI, localName);
};
core.Element.prototype._created = <span class="literal">false</span>;

core.Element.prototype.setAttributeNodeNS = <span class="keyword">function</span>(<span class="comment">/* Attr */</span> newAttr)
{
  <span class="keyword">if</span> (newAttr.ownerElement) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.INUSE_ATTRIBUTE_ERR);
  }

  <span class="keyword">var</span> existing = <span class="literal">null</span>;
  <span class="keyword">try</span> {
    existing = <span class="keyword">this</span>._attributes.removeNamedItemNS(newAttr.namespaceURI,
                                                  newAttr.localName);
  } <span class="keyword">catch</span> (e) { <span class="comment">/* noop */</span>}

  <span class="keyword">return</span> <span class="keyword">this</span>._attributes.setNamedItemNS(newAttr) || existing;
};

core.Element.prototype.getElementsByTagNameNS = <span class="keyword">function</span>(<span class="comment">/* String */</span> namespaceURI,
                                                         <span class="comment">/* String */</span> localName)
{
  <span class="keyword">var</span> nsPrefixCache = {};

  <span class="function"><span class="keyword">function</span> <span class="title">filterByTagName</span><span class="params">(child)</span> {</span>
    <span class="keyword">if</span> (child.nodeType &amp;&amp; child.nodeType === <span class="keyword">this</span>.ENTITY_REFERENCE_NODE) {
      child = child._entity;
    }

    <span class="keyword">var</span> localMatch = child.localName === localName,
        nsMatch    = child.namespaceURI === namespaceURI;

    <span class="keyword">if</span> ((localMatch || localName === <span class="string">"*"</span>) &amp;&amp;
        (nsMatch || namespaceURI === <span class="string">"*"</span>))
    {
      <span class="keyword">if</span> (child.nodeType === child.ELEMENT_NODE) {
        <span class="keyword">return</span> <span class="literal">true</span>;
      }
    }
    <span class="keyword">return</span> <span class="literal">false</span>;
  }

  <span class="keyword">return</span> <span class="keyword">new</span> core.NodeList(<span class="keyword">this</span>.ownerDocument || <span class="keyword">this</span>,
                           core.mapper(<span class="keyword">this</span>, filterByTagName));
};

core.Element.prototype.hasAttribute = <span class="keyword">function</span>(<span class="comment">/* string */</span>name)
{
  <span class="keyword">if</span> (!<span class="keyword">this</span>._attributes) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }
  <span class="keyword">return</span> <span class="keyword">this</span>._attributes.exists(name);
};

core.Element.prototype.hasAttributeNS = <span class="keyword">function</span>(<span class="comment">/* string */</span>namespaceURI,
                                                 <span class="comment">/* string */</span>localName)
{
  <span class="keyword">if</span> (<span class="keyword">this</span>._attributes.getNamedItemNS(namespaceURI, localName)) {
    <span class="keyword">return</span> <span class="literal">true</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.hasAttribute(localName)) {
    <span class="keyword">return</span> <span class="literal">true</span>;
  }
  <span class="keyword">return</span> <span class="literal">false</span>;
};

core.DocumentType.prototype.__defineGetter__(<span class="string">"publicId"</span>, <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>._publicId || <span class="string">""</span>;
});

core.DocumentType.prototype.__defineGetter__(<span class="string">"systemId"</span>, <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>._systemId || <span class="string">""</span>;
});

core.DocumentType.prototype.__defineGetter__(<span class="string">"internalSubset"</span>, <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>._internalSubset || <span class="literal">null</span>;
});

core.Document.prototype.importNode = <span class="keyword">function</span>(<span class="comment">/* Node */</span> importedNode,
                                              <span class="comment">/* bool */</span> deep)
{
  <span class="keyword">if</span> (importedNode &amp;&amp; importedNode.nodeType) {
    <span class="keyword">if</span> (importedNode.nodeType === <span class="keyword">this</span>.DOCUMENT_NODE ||
        importedNode.nodeType === <span class="keyword">this</span>.DOCUMENT_TYPE_NODE) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.NOT_SUPPORTED_ERR);
    }
  }

  <span class="keyword">var</span> self = <span class="keyword">this</span>,
      newNode = importedNode.cloneNode(deep, <span class="keyword">function</span>(a, b) {
        b._namespaceURI  = a._namespaceURI;
        b._nodeName      = a._nodeName;
        b._localName     = a._localName;
      }),
      defaults = <span class="literal">false</span>,
      defaultEl;

  <span class="keyword">if</span> (<span class="keyword">this</span>.doctype &amp;&amp; <span class="keyword">this</span>.doctype._attributes) {
    defaults = <span class="keyword">this</span>.doctype._attributes;
  }

  <span class="function"><span class="keyword">function</span> <span class="title">lastChance</span><span class="params">(el)</span> {</span>
    <span class="keyword">var</span> attr, defaultEl;

    el._ownerDocument = self;
    <span class="keyword">if</span> (el.id) {
      <span class="keyword">if</span> (!self._ids) {self._ids = {};}
      <span class="keyword">if</span> (!self._ids[el.id]) {self._ids[el.id] = [];}
      self._ids[el.id].push(el);
    }
    <span class="keyword">if</span> (el._attributes) {
      el._attributes._ownerDocument = self;
      <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>,len=el._attributes.length; i &lt; len; i++) {
        attr = el._attributes.item(i);
        attr._ownerDocument = self;
        attr._specified = <span class="literal">true</span>;
      }
    }
    <span class="keyword">if</span> (defaults) {

      defaultEl = defaults.getNamedItemNS(el._namespaceURI,
                                          el._localName);

      <span class="comment">// TODO: This could use some love</span>
      <span class="keyword">if</span> (defaultEl) {
        defaultEl._attributes._map(<span class="keyword">function</span>(defaultAttr) {
          <span class="keyword">if</span> (!el.hasAttributeNS(defaultAttr.namespaceURL,
                                 defaultAttr.localName))
          {
            <span class="keyword">var</span> clone = defaultAttr.cloneNode(<span class="literal">true</span>);
            clone._namespaceURI = defaultAttr._namespaceURI;
            clone._prefix       = defaultAttr._prefix;
            clone._localName    = defaultAttr._localName;
            el.setAttributeNodeNS(clone);
            clone._specified = <span class="literal">false</span>;
          }
        });
      }
    }

  }

  <span class="keyword">if</span> (deep) {
    core.visitTree(newNode, lastChance);
  }
  <span class="keyword">else</span> {
    lastChance(newNode);
  }

  <span class="keyword">if</span> (newNode.nodeType == newNode.ATTRIBUTE_NODE) {
    newNode._specified = <span class="literal">true</span>;
  }

  <span class="keyword">return</span> newNode;
};

core.Document.prototype.createElementNS = <span class="keyword">function</span>(<span class="comment">/* string */</span> namespaceURI,
                                                   <span class="comment">/* string */</span> qualifiedName)
{
  <span class="keyword">var</span> parts   = qualifiedName.split(<span class="string">':'</span>),
      element, prefix;

  <span class="keyword">if</span> (parts.length > <span class="number">1</span> &amp;&amp; !namespaceURI) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.NAMESPACE_ERR);
  }

  ns.validate(qualifiedName, namespaceURI);
  element = <span class="keyword">this</span>.createElement(qualifiedName),

  element._created = <span class="literal">false</span>;

  element._namespaceURI = namespaceURI;
  element._nodeName = qualifiedName;
  element._localName = parts.pop();

  <span class="keyword">if</span> (parts.length > <span class="number">0</span>) {
    prefix = parts.pop();
    element.prefix = prefix;
  }

  element._created = <span class="literal">true</span>;
  <span class="keyword">return</span> element;
};

core.Document.prototype.createAttributeNS = <span class="keyword">function</span>(<span class="comment">/* string */</span> namespaceURI,
                                                     <span class="comment">/* string */</span> qualifiedName)
{
  <span class="keyword">var</span> attribute, parts = qualifiedName.split(<span class="string">':'</span>);

  <span class="keyword">if</span> (parts.length > <span class="number">1</span> &amp;&amp; !namespaceURI) {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(core.NAMESPACE_ERR,
                                <span class="string">"Prefix specified without namespaceURI ("</span> + qualifiedName + <span class="string">")"</span>);
  }


  ns.validate(qualifiedName, namespaceURI);

  attribute = <span class="keyword">this</span>.createAttribute(qualifiedName);
  attribute.namespaceURI = namespaceURI;
  attribute.qualifiedName = qualifiedName;

  attribute._localName = parts.pop();
  attribute._prefix = (parts.length > <span class="number">0</span>) ? parts.pop() : <span class="literal">null</span>;
  <span class="keyword">return</span> attribute;
};

core.Document.prototype.getElementsByTagNameNS = <span class="keyword">function</span>(<span class="comment">/* String */</span> namespaceURI,
                                                          <span class="comment">/* String */</span> localName)
{
  <span class="keyword">return</span> core.Element.prototype.getElementsByTagNameNS.call(<span class="keyword">this</span>,
                                                            namespaceURI,
                                                            localName);
};

core.Element.prototype.__defineSetter__(<span class="string">"id"</span>, <span class="keyword">function</span>(id) {
  <span class="keyword">this</span>.setAttribute(<span class="string">"id"</span>, id);
});

core.Element.prototype.__defineGetter__(<span class="string">"id"</span>,<span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>.getAttribute(<span class="string">"id"</span>);
});

core.Document.prototype.getElementById = <span class="keyword">function</span>(id) {
  <span class="comment">// return the first element</span>
  <span class="keyword">return</span> (<span class="keyword">this</span>._ids &amp;&amp; <span class="keyword">this</span>._ids[id] &amp;&amp; <span class="keyword">this</span>._ids[id].length > <span class="number">0</span> ? <span class="keyword">this</span>._ids[id][<span class="number">0</span>] : <span class="literal">null</span>);
};


exports.dom =
{
  level2 : {
    core : core
  }
};
</code></pre>