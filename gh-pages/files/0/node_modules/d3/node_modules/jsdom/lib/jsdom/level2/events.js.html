<h1>events.js</h1>
<pre><code class="lang-js"><span class="comment">/* DOM Level2 Events implemented as described here:
 *
 * http://www.w3.org/TR/2000/REC-DOM-Level-2-Events-20001113/events.html
 *
 */</span>
<span class="keyword">var</span> core = require(<span class="string">"./core"</span>).dom.level2.core,
    utils = require(<span class="string">"../utils"</span>);

<span class="comment">// modify cloned instance for more info check: https://github.com/tmpvar/jsdom/issues/325</span>
core = Object.create(core);

<span class="keyword">var</span> events = {};

events.EventException = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (arguments.length > <span class="number">0</span>) {
        <span class="keyword">this</span>._code = arguments[<span class="number">0</span>];
    } <span class="keyword">else</span> {
        <span class="keyword">this</span>._code = <span class="number">0</span>;
    }
    <span class="keyword">if</span> (arguments.length > <span class="number">1</span>) {
        <span class="keyword">this</span>._message = arguments[<span class="number">1</span>];
    } <span class="keyword">else</span> {
        <span class="keyword">this</span>._message = <span class="string">"Unspecified event type"</span>;
    }
    Error.call(<span class="keyword">this</span>, <span class="keyword">this</span>._message);
    <span class="keyword">if</span> (Error.captureStackTrace) {
        Error.captureStackTrace(<span class="keyword">this</span>, events.EventException);
    }
};
events.EventException.prototype = {
  UNSPECIFIED_EVENT_TYPE_ERR : <span class="number">0</span>,
  get code() { <span class="keyword">return</span> <span class="keyword">this</span>._code;}
};
events.EventException.prototype.__proto__ = Error.prototype;

events.Event = <span class="keyword">function</span>(eventType) {
    <span class="keyword">this</span>._eventType = eventType;
    <span class="keyword">this</span>._type = <span class="literal">null</span>;
    <span class="keyword">this</span>._bubbles = <span class="literal">null</span>;
    <span class="keyword">this</span>._cancelable = <span class="literal">null</span>;
    <span class="keyword">this</span>._target = <span class="literal">null</span>;
    <span class="keyword">this</span>._currentTarget = <span class="literal">null</span>;
    <span class="keyword">this</span>._eventPhase = <span class="literal">null</span>;
    <span class="keyword">this</span>._timeStamp = <span class="literal">null</span>;
    <span class="keyword">this</span>._preventDefault = <span class="literal">false</span>;
    <span class="keyword">this</span>._stopPropagation = <span class="literal">false</span>;
};
events.Event.prototype = {
    initEvent: <span class="keyword">function</span>(type, bubbles, cancelable) {
        <span class="keyword">this</span>._type = type;
        <span class="keyword">this</span>._bubbles = bubbles;
        <span class="keyword">this</span>._cancelable = cancelable;
    },
    preventDefault: <span class="keyword">function</span>() {
        <span class="keyword">if</span> (<span class="keyword">this</span>._cancelable) {
            <span class="keyword">this</span>._preventDefault = <span class="literal">true</span>;
        }
    },
    stopPropagation: <span class="keyword">function</span>() {
        <span class="keyword">this</span>._stopPropagation = <span class="literal">true</span>;
    },
    CAPTURING_PHASE : <span class="number">1</span>,
    AT_TARGET       : <span class="number">2</span>,
    BUBBLING_PHASE  : <span class="number">3</span>,
    get eventType() { <span class="keyword">return</span> <span class="keyword">this</span>._eventType; },
    get type() { <span class="keyword">return</span> <span class="keyword">this</span>._type; },
    get bubbles() { <span class="keyword">return</span> <span class="keyword">this</span>._bubbles; },
    get cancelable() { <span class="keyword">return</span> <span class="keyword">this</span>._cancelable; },
    get target() { <span class="keyword">return</span> <span class="keyword">this</span>._target; },
    get currentTarget() { <span class="keyword">return</span> <span class="keyword">this</span>._currentTarget; },
    get eventPhase() { <span class="keyword">return</span> <span class="keyword">this</span>._eventPhase; },
    get timeStamp() { <span class="keyword">return</span> <span class="keyword">this</span>._timeStamp; }
};

events.HTMLEvent = <span class="keyword">function</span>(eventType) {
    events.Event.call(<span class="keyword">this</span>, eventType);
};
events.HTMLEvent.prototype.__proto__ = events.Event.prototype;


events.UIEvent = <span class="keyword">function</span>(eventType) {
    events.Event.call(<span class="keyword">this</span>, eventType);
    <span class="keyword">this</span>.view = <span class="literal">null</span>;
    <span class="keyword">this</span>.detail = <span class="literal">null</span>;
};
events.UIEvent.prototype = {
    initUIEvent: <span class="keyword">function</span>(type, bubbles, cancelable, view, detail) {
        <span class="keyword">this</span>.initEvent(type, bubbles, cancelable);
        <span class="keyword">this</span>.view = view;
        <span class="keyword">this</span>.detail = detail;
    },
};
events.UIEvent.prototype.__proto__ = events.Event.prototype;


events.MouseEvent = <span class="keyword">function</span>(eventType) {
    events.UIEvent.call(<span class="keyword">this</span>, eventType);
    <span class="keyword">this</span>.screenX = <span class="literal">null</span>;
    <span class="keyword">this</span>.screenY = <span class="literal">null</span>;
    <span class="keyword">this</span>.clientX = <span class="literal">null</span>;
    <span class="keyword">this</span>.clientY = <span class="literal">null</span>;
    <span class="keyword">this</span>.ctrlKey = <span class="literal">null</span>;
    <span class="keyword">this</span>.shiftKey = <span class="literal">null</span>;
    <span class="keyword">this</span>.altKey = <span class="literal">null</span>;
    <span class="keyword">this</span>.metaKey = <span class="literal">null</span>;
    <span class="keyword">this</span>.button = <span class="literal">null</span>;
    <span class="keyword">this</span>.relatedTarget = <span class="literal">null</span>;
};
events.MouseEvent.prototype = {
    initMouseEvent:   <span class="keyword">function</span>(type,
                               bubbles,
                               cancelable,
                               view,
                               detail,
                               screenX,
                               screenY,
                               clientX,
                               clientY,
                               ctrlKey,
                               altKey,
                               shiftKey,
                               metaKey,
                               button,
                               relatedTarget) {
        <span class="keyword">this</span>.initUIEvent(type, bubbles, cancelable, view, detail);
        <span class="keyword">this</span>.screenX  = screenX
        <span class="keyword">this</span>.screenY  = screenY
        <span class="keyword">this</span>.clientX  = clientX
        <span class="keyword">this</span>.clientY  = clientY
        <span class="keyword">this</span>.ctrlKey  = ctrlKey
        <span class="keyword">this</span>.shiftKey  = shiftKey
        <span class="keyword">this</span>.altKey  = altKey
        <span class="keyword">this</span>.metaKey  = metaKey
        <span class="keyword">this</span>.button  = button
        <span class="keyword">this</span>.relatedTarget  = relatedTarget
    }
};
events.MouseEvent.prototype.__proto__ = events.UIEvent.prototype;


events.MutationEvent = <span class="keyword">function</span>(eventType) {
    events.Event.call(<span class="keyword">this</span>, eventType);
    <span class="keyword">this</span>.relatedNode = <span class="literal">null</span>;
    <span class="keyword">this</span>.prevValue = <span class="literal">null</span>;
    <span class="keyword">this</span>.newValue = <span class="literal">null</span>;
    <span class="keyword">this</span>.attrName = <span class="literal">null</span>;
    <span class="keyword">this</span>.attrChange = <span class="literal">null</span>;
};
events.MutationEvent.prototype = {
    initMutationEvent:   <span class="keyword">function</span>(type,
                                  bubbles,
                                  cancelable,
                                  relatedNode,
                                  prevValue,
                                  newValue,
                                  attrName,
                                  attrChange) {
        <span class="keyword">this</span>.initEvent(type, bubbles, cancelable);
        <span class="keyword">this</span>.relatedNode = relatedNode;
        <span class="keyword">this</span>.prevValue = prevValue;
        <span class="keyword">this</span>.newValue = newValue;
        <span class="keyword">this</span>.attrName = attrName;
        <span class="keyword">this</span>.attrChange = attrChange;
    },
    MODIFICATION : <span class="number">1</span>,
    ADDITION     : <span class="number">2</span>,
    REMOVAL      : <span class="number">3</span>
};
events.MutationEvent.prototype.__proto__ = events.Event.prototype;

events.EventTarget = <span class="keyword">function</span>() {};

events.EventTarget.getListeners = <span class="function"><span class="keyword">function</span> <span class="title">getListeners</span><span class="params">(target, type, capturing)</span> {</span>
    <span class="keyword">var</span> listeners = target._listeners
            &amp;&amp; target._listeners[type]
            &amp;&amp; target._listeners[type][capturing] || [];
    <span class="keyword">if</span> (!capturing) {
        <span class="keyword">var</span> traditionalHandler = target[<span class="string">'on'</span> + type];
        <span class="keyword">if</span> (traditionalHandler) {
            <span class="keyword">var</span> implementation = (target._ownerDocument ? target._ownerDocument.implementation
                                                        : target.document.implementation);

            <span class="keyword">if</span> (implementation.hasFeature(<span class="string">'ProcessExternalResources'</span>, <span class="string">'script'</span>)) {
                listeners.push(traditionalHandler);
            }
        }
    }
    <span class="keyword">return</span> listeners;
};

events.EventTarget.dispatch = <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(event, iterator, capturing)</span> {</span>
    <span class="keyword">var</span> listeners,
        currentListener,
        target = iterator();

    <span class="keyword">while</span> (target &amp;&amp; !event._stopPropagation) {
        listeners = events.EventTarget.getListeners(target, event._type, capturing);
        currentListener = listeners.length;
        <span class="keyword">while</span> (currentListener--) {
            event._currentTarget = target;
            <span class="keyword">try</span> {
              listeners[currentListener].call(target, event);
            } <span class="keyword">catch</span> (e) {
              target.raise(
                <span class="string">'error'</span>, <span class="string">"Dispatching event '"</span> + event._type + <span class="string">"' failed"</span>,
                {error: e, event: event}
              );
            }
        }
        target = iterator();
    }
    <span class="keyword">return</span> !event._stopPropagation;
};

events.EventTarget.forwardIterator = <span class="function"><span class="keyword">function</span> <span class="title">forwardIterator</span><span class="params">(list)</span> {</span>
  <span class="keyword">var</span> i = <span class="number">0</span>, len = list.length;
  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">iterator</span><span class="params">()</span> {</span> <span class="keyword">return</span> i &lt; len ? list[i++] : <span class="literal">null</span> };
};

events.EventTarget.backwardIterator = <span class="function"><span class="keyword">function</span> <span class="title">backwardIterator</span><span class="params">(list)</span> {</span>
  <span class="keyword">var</span> i = list.length;
  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">iterator</span><span class="params">()</span> {</span> <span class="keyword">return</span> i >=<span class="number">0</span> ? list[--i] : <span class="literal">null</span> };
};

events.EventTarget.singleIterator = <span class="function"><span class="keyword">function</span> <span class="title">singleIterator</span><span class="params">(obj)</span> {</span>
  <span class="keyword">var</span> i = <span class="number">1</span>;
  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">iterator</span><span class="params">()</span> {</span> <span class="keyword">return</span> i-- ? obj : <span class="literal">null</span> };
};

events.EventTarget.prototype = {
    addEventListener: <span class="keyword">function</span>(type, listener, capturing) {
        <span class="keyword">this</span>._listeners = <span class="keyword">this</span>._listeners || {};
        <span class="keyword">var</span> listeners = <span class="keyword">this</span>._listeners[type] || {};
        capturing = (capturing === <span class="literal">true</span>);
        <span class="keyword">var</span> capturingListeners = listeners[capturing] || [];
        <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; capturingListeners.length; i++) {
            <span class="keyword">if</span> (capturingListeners[i] === listener) {
                <span class="keyword">return</span>;
            }
        }
        capturingListeners.push(listener);
        listeners[capturing] = capturingListeners;
        <span class="keyword">this</span>._listeners[type] = listeners;
    },

    removeEventListener: <span class="keyword">function</span>(type, listener, capturing) {
        <span class="keyword">var</span> listeners  = <span class="keyword">this</span>._listeners &amp;&amp; <span class="keyword">this</span>._listeners[type];
        <span class="keyword">if</span> (!listeners) <span class="keyword">return</span>;
        <span class="keyword">var</span> capturingListeners = listeners[(capturing === <span class="literal">true</span>)];
        <span class="keyword">if</span> (!capturingListeners) <span class="keyword">return</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; capturingListeners.length; i++) {
            <span class="keyword">if</span> (capturingListeners[i] === listener) {
                capturingListeners.splice(i, <span class="number">1</span>);
                <span class="keyword">return</span>;
            }
        }
    },

    dispatchEvent: <span class="keyword">function</span>(event) {
        <span class="keyword">if</span> (event == <span class="literal">null</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> events.EventException(<span class="number">0</span>, <span class="string">"Null event"</span>);
        }
        <span class="keyword">if</span> (event._type == <span class="literal">null</span> || event._type == <span class="string">""</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> events.EventException(<span class="number">0</span>, <span class="string">"Uninitialized event"</span>);
        }

        <span class="keyword">var</span> targetList = [];

        event._target = <span class="keyword">this</span>;

        <span class="comment">//per the spec we gather the list of targets first to ensure</span>
        <span class="comment">//against dom modifications during actual event dispatch</span>
        <span class="keyword">var</span> target = <span class="keyword">this</span>,
            targetParent = target._parentNode;
        <span class="keyword">while</span> (targetParent) {
            targetList.push(targetParent);
            target = targetParent;
            targetParent = target._parentNode;
        }
        targetParent = target._parentWindow;
        <span class="keyword">if</span> (targetParent) {
            targetList.push(targetParent);
        }

        <span class="keyword">var</span> iterator = events.EventTarget.backwardIterator(targetList);

        event._eventPhase = event.CAPTURING_PHASE;
        <span class="keyword">if</span> (!events.EventTarget.dispatch(event, iterator, <span class="literal">true</span>)) <span class="keyword">return</span> event._preventDefault;

        iterator = events.EventTarget.singleIterator(event._target);
        event._eventPhase = event.AT_TARGET;
        <span class="keyword">if</span> (!events.EventTarget.dispatch(event, iterator, <span class="literal">false</span>)) <span class="keyword">return</span> event._preventDefault;

        <span class="keyword">if</span> (event._bubbles &amp;&amp; !event._stopPropagation) {
            <span class="keyword">var</span> i = <span class="number">0</span>;
            iterator = events.EventTarget.forwardIterator(targetList);
            event._eventPhase = event.BUBBLING_PHASE;
            events.EventTarget.dispatch(event, iterator, <span class="literal">false</span>);
        }

        <span class="keyword">return</span> event._preventDefault;
    }

};


core.Node.prototype.__proto__ = events.EventTarget.prototype;

<span class="function"><span class="keyword">function</span> <span class="title">getDocument</span><span class="params">(el)</span> {</span>
  <span class="keyword">return</span> el.nodeType == core.Node.DOCUMENT_NODE ? el : el._ownerDocument;
}

<span class="function"><span class="keyword">function</span> <span class="title">mutationEventsEnabled</span><span class="params">(el)</span> {</span>
  <span class="keyword">return</span> el.nodeType != core.Node.ATTRIBUTE_NODE &amp;&amp;
         getDocument(el).implementation.hasFeature(<span class="string">'MutationEvents'</span>);
}

utils.intercept(core.Node, <span class="string">'insertBefore'</span>, <span class="keyword">function</span>(_super, args, newChild, refChild) {
  <span class="keyword">var</span> ret = _super.apply(<span class="keyword">this</span>, args);
  <span class="keyword">if</span> (mutationEventsEnabled(<span class="keyword">this</span>)) {
    <span class="keyword">var</span> doc = getDocument(<span class="keyword">this</span>),
        ev = doc.createEvent(<span class="string">"MutationEvents"</span>);

    ev.initMutationEvent(<span class="string">"DOMNodeInserted"</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="keyword">this</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);
    newChild.dispatchEvent(ev);
    <span class="keyword">if</span> (<span class="keyword">this</span>.nodeType == core.Node.DOCUMENT_NODE || <span class="keyword">this</span>._attachedToDocument) {
      ev = doc.createEvent(<span class="string">"MutationEvents"</span>);
      ev.initMutationEvent(<span class="string">"DOMNodeInsertedIntoDocument"</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);
      core.visitTree(newChild, <span class="keyword">function</span>(el) {
        <span class="keyword">if</span> (el.nodeType == core.Node.ELEMENT_NODE) {
          el.dispatchEvent(ev);
          el._attachedToDocument = <span class="literal">true</span>;
        }
      });
    }
  }
  <span class="keyword">return</span> ret;
});

utils.intercept(core.Node, <span class="string">'removeChild'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(_super, args, oldChild)</span> {</span>
  <span class="keyword">if</span> (mutationEventsEnabled(<span class="keyword">this</span>)) {
    <span class="keyword">var</span> doc = getDocument(<span class="keyword">this</span>),
        ev = doc.createEvent(<span class="string">"MutationEvents"</span>);

    ev.initMutationEvent(<span class="string">"DOMNodeRemoved"</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="keyword">this</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);
    oldChild.dispatchEvent(ev);

    ev = doc.createEvent(<span class="string">"MutationEvents"</span>);
    ev.initMutationEvent(<span class="string">"DOMNodeRemovedFromDocument"</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);
    core.visitTree(oldChild, <span class="keyword">function</span>(el) {
      <span class="keyword">if</span> (el.nodeType == core.Node.ELEMENT_NODE) {
        el.dispatchEvent(ev);
        el._attachedToDocument = <span class="literal">false</span>;
      }
    });
  }
  <span class="keyword">return</span> _super.apply(<span class="keyword">this</span>, args);
});

<span class="function"><span class="keyword">function</span> <span class="title">dispatchAttrEvent</span><span class="params">(change)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">function</span>(_super, args, node) {
    <span class="keyword">var</span> target = <span class="keyword">this</span>._parentNode,
        prev = _super.apply(<span class="keyword">this</span>, args);

    <span class="keyword">if</span> (mutationEventsEnabled(target)) {
      <span class="keyword">var</span> doc = target._ownerDocument,
          attrChange = events.MutationEvent.prototype[change],
          attrName = prev &amp;&amp; prev.name || node.name,
          prevVal = prev &amp;&amp; prev.value || <span class="literal">null</span>,
          newVal = change == <span class="string">'ADDITION'</span> ? node.value : <span class="literal">null</span>,
          ev;

      <span class="keyword">if</span> (!newVal || newVal != prevVal) {
        ev = doc.createEvent(<span class="string">"MutationEvents"</span>);
        ev.initMutationEvent(<span class="string">"DOMAttrModified"</span>, <span class="literal">true</span>, <span class="literal">false</span>, target, prevVal, newVal, attrName, attrChange);
        target.dispatchEvent(ev);
      }
    }
    <span class="keyword">return</span> prev;
  }
}

utils.intercept(core.AttrNodeMap, <span class="string">'removeNamedItem'</span>, dispatchAttrEvent(<span class="string">'REMOVAL'</span>));
utils.intercept(core.AttrNodeMap, <span class="string">'setNamedItem'</span>, dispatchAttrEvent(<span class="string">'ADDITION'</span>));

core.CharacterData.prototype.__defineGetter__(<span class="string">"_nodeValue"</span>, <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>.__nodeValue;
});
core.CharacterData.prototype.__defineSetter__(<span class="string">"_nodeValue"</span>, <span class="keyword">function</span>(value) {
  <span class="keyword">var</span> oldValue = <span class="keyword">this</span>.__nodeValue;
  <span class="keyword">this</span>.__nodeValue = value;
  <span class="keyword">if</span> (<span class="keyword">this</span>._ownerDocument &amp;&amp; <span class="keyword">this</span>._parentNode &amp;&amp; mutationEventsEnabled(<span class="keyword">this</span>)) {
    <span class="keyword">var</span> ev = <span class="keyword">this</span>._ownerDocument.createEvent(<span class="string">"MutationEvents"</span>)
    ev.initMutationEvent(<span class="string">"DOMCharacterDataModified"</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="keyword">this</span>, oldValue, value, <span class="literal">null</span>, <span class="literal">null</span>);
    <span class="keyword">this</span>.dispatchEvent(ev);
  }
});

core.Document.prototype.createEvent = <span class="keyword">function</span>(eventType) {
    <span class="keyword">switch</span> (eventType) {
        <span class="keyword">case</span> <span class="string">"MutationEvents"</span>: <span class="keyword">return</span> <span class="keyword">new</span> events.MutationEvent(eventType);
        <span class="keyword">case</span> <span class="string">"UIEvents"</span>: <span class="keyword">return</span> <span class="keyword">new</span> events.UIEvent(eventType);
        <span class="keyword">case</span> <span class="string">"MouseEvents"</span>: <span class="keyword">return</span> <span class="keyword">new</span> events.MouseEvent(eventType);
        <span class="keyword">case</span> <span class="string">"HTMLEvents"</span>: <span class="keyword">return</span> <span class="keyword">new</span> events.HTMLEvent(eventType);
    }
    <span class="keyword">return</span> <span class="keyword">new</span> events.Event(eventType);
};

exports.dom =
{
  level2 : {
    core   : core,
    events : events
  }
};

</code></pre>