<h1>domtohtml.js</h1>
<pre><code class="lang-js"><span class="comment">//List from node-htmlparser</span>
<span class="keyword">var</span> singleTags = {
  area: <span class="number">1</span>,
  base: <span class="number">1</span>,
  basefont: <span class="number">1</span>,
  br: <span class="number">1</span>,
  col: <span class="number">1</span>,
  frame: <span class="number">1</span>,
  hr: <span class="number">1</span>,
  img: <span class="number">1</span>,
  input: <span class="number">1</span>,
  isindex: <span class="number">1</span>,
  link: <span class="number">1</span>,
  meta: <span class="number">1</span>,
  param: <span class="number">1</span>,
  embed: <span class="number">1</span>
};

<span class="keyword">var</span> expr = {
  upperCaseChars: <span class="regexp">/([A-Z])/g</span>,
  breakBetweenTags: <span class="regexp">/(&lt;(\/?\w+).*?>)(?=&lt;(?!\/\2))/gi</span>,
  singleTag: (<span class="keyword">function</span>() {
    <span class="keyword">var</span> tags = [];
    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> singleTags) {
      tags.push(i);
    }
    <span class="keyword">return</span> <span class="keyword">new</span> RegExp(<span class="string">'&lt;'</span> + tags.join(<span class="string">'|&lt;'</span>), <span class="string">'i'</span>);
  })()
};

<span class="keyword">var</span> uncanon = <span class="keyword">function</span>(str, letter) {
  <span class="keyword">return</span> <span class="string">'-'</span> + letter.toLowerCase();
};

<span class="keyword">var</span> HTMLEncode = require(<span class="string">'./htmlencoding'</span>).HTMLEncode;

exports.stringifyElement = <span class="function"><span class="keyword">function</span> <span class="title">stringifyElement</span><span class="params">(element)</span> {</span>
  <span class="keyword">var</span> tagName = element.tagName.toLowerCase(),
      ret = {
        start: <span class="string">"&lt;"</span> + tagName,
        end:<span class="string">''</span>
      },
      attributes = [],
      i,
      attribute = <span class="literal">null</span>;

  <span class="keyword">if</span> (element.attributes.length) {
    ret.start += <span class="string">" "</span>;
    <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;element.attributes.length; i++) {
      attribute = element.attributes.item(i);
      attributes.push(attribute.name + <span class="string">'="'</span> +
                      HTMLEncode(attribute.nodeValue, <span class="literal">true</span>) + <span class="string">'"'</span>);
    }
  }
  ret.start += attributes.join(<span class="string">" "</span>);

  <span class="keyword">if</span> (singleTags[tagName]) {
    ret.start += <span class="string">" />"</span>;
    ret.end = <span class="string">''</span>;
  } <span class="keyword">else</span> {
    ret.start += <span class="string">">"</span>;
    ret.end = <span class="string">"&lt;/"</span> + tagName + <span class="string">">"</span>;
  }

  <span class="keyword">return</span> ret;
};

<span class="keyword">var</span> rawTextElements = <span class="regexp">/SCRIPT|STYLE/i</span>;

<span class="function"><span class="keyword">function</span> <span class="title">stringifyDoctype</span> <span class="params">(doctype)</span> {</span>
  <span class="keyword">if</span> (doctype.ownerDocument &amp;&amp; doctype.ownerDocument._fullDT) {
    <span class="keyword">return</span> doctype.ownerDocument._fullDT;
  }

  <span class="keyword">var</span> dt = <span class="string">'&lt;!DOCTYPE '</span> + doctype.name;
  <span class="keyword">if</span> (doctype.publicId) {
    <span class="comment">// Public ID may never contain double quotes, so this is always safe.</span>
    dt += <span class="string">' PUBLIC "'</span> + doctype.publicId + <span class="string">'" '</span>;
  }
  <span class="keyword">if</span> (!doctype.publicId &amp;&amp; doctype.systemId) {
    dt += <span class="string">' SYSTEM '</span>;
  }
  <span class="keyword">if</span> (doctype.systemId) {
    <span class="comment">// System ID may contain double quotes OR single quotes, not never both.</span>
    <span class="keyword">if</span> (doctype.systemId.indexOf(<span class="string">'"'</span>) > -<span class="number">1</span>) {
      dt += <span class="string">"'"</span> + doctype.systemId + <span class="string">"'"</span>;
    } <span class="keyword">else</span> {
      dt += <span class="string">'"'</span> + doctype.systemId + <span class="string">'"'</span>;
    }
  }
  dt += <span class="string">'>'</span>;
  <span class="keyword">return</span> dt;
}

exports.makeHtmlGenerator = <span class="function"><span class="keyword">function</span> <span class="title">makeHtmlGenerator</span><span class="params">(indentUnit, eol)</span> {</span>
  indentUnit = indentUnit || <span class="string">""</span>;
  eol = eol || <span class="string">""</span>;

  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">generateHtmlRecursive</span><span class="params">(node, rawText, curIndent)</span> {</span>
    <span class="keyword">var</span> ret = <span class="string">""</span>, parent, current, i;
    curIndent = curIndent || <span class="string">""</span>;
    <span class="keyword">if</span> (node) {
      <span class="keyword">if</span> (node.nodeType &amp;&amp;
          node.nodeType === node.ENTITY_REFERENCE_NODE) {
        node = node._entity;
      }

      <span class="keyword">var</span> childNodesRawText = rawText || rawTextElements.test(node.nodeName);

      <span class="keyword">switch</span> (node.nodeType) {
        <span class="keyword">case</span> node.ELEMENT_NODE:
          current = exports.stringifyElement(node);
          <span class="keyword">if</span> (childNodesRawText) {
            ret += curIndent + current.start;
          } <span class="keyword">else</span> {
            ret += curIndent + current.start;
          }
          <span class="keyword">if</span> (node._childNodes.length > <span class="number">0</span>) {
            <span class="keyword">if</span> (node._childNodes[<span class="number">0</span>].nodeType !== node.TEXT_NODE) {
              ret += eol;
            }
            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;node._childNodes.length; i++) {
              ret += generateHtmlRecursive(node._childNodes[i], childNodesRawText, curIndent + indentUnit);
            }
            <span class="keyword">if</span> (node._childNodes[node._childNodes.length - <span class="number">1</span>].nodeType !== node.TEXT_NODE) {
              ret += curIndent;
            }
            ret += current.end + eol;
          } <span class="keyword">else</span> {
            ret += ((rawText ? node.nodeValue : HTMLEncode(node.nodeValue, <span class="literal">false</span>)) || <span class="string">''</span>) + current.end + eol;
          }
          <span class="keyword">break</span>;
        <span class="keyword">case</span> node.TEXT_NODE:
          <span class="comment">// Skip pure whitespace nodes if we're indenting</span>
          <span class="keyword">if</span> (!indentUnit || !<span class="regexp">/^[\s\n]*$/</span>.test(node.nodeValue)) {
            ret += (rawText ? node.nodeValue : HTMLEncode(node.nodeValue, <span class="literal">false</span>)) || <span class="string">''</span>;
          }
          <span class="keyword">break</span>;
        <span class="keyword">case</span> node.COMMENT_NODE:
          ret += curIndent + <span class="string">'&lt;!--'</span> + node.nodeValue + <span class="string">'-->'</span> + eol;
          <span class="keyword">break</span>;
        <span class="keyword">case</span> node.DOCUMENT_NODE:
          <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;node._childNodes.length; i++) {
            ret += generateHtmlRecursive(node._childNodes[i], childNodesRawText, curIndent);
          }
          <span class="keyword">break</span>;
        <span class="keyword">case</span> node.DOCUMENT_TYPE_NODE:
          ret += stringifyDoctype(node);
        <span class="keyword">break</span>;
      }
    }
    <span class="keyword">return</span> ret;
  };
};

exports.domToHtml = <span class="keyword">function</span>(dom, noformat, raw) {
  <span class="keyword">var</span> htmlGenerator = exports.makeHtmlGenerator(noformat ? <span class="string">""</span> : <span class="string">"  "</span>,
                                                noformat ? <span class="string">""</span> : <span class="string">"\n"</span>);
  <span class="keyword">if</span> (dom.toArray) {
    <span class="comment">// node list</span>
    dom = dom.toArray();
  }
  <span class="keyword">if</span> (<span class="keyword">typeof</span> dom.length !== <span class="string">'undefined'</span>) {
    <span class="keyword">var</span> ret = <span class="string">""</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>,len=dom.length; i&lt;len; i++) {
      ret += htmlGenerator(dom[i], raw);
    }
    <span class="keyword">return</span> ret;
  } <span class="keyword">else</span> {
    <span class="comment">// single node</span>
    <span class="keyword">return</span> htmlGenerator(dom, raw);
  }
};
</code></pre>