<h1>htmltodom.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> HTMLDecode = require(<span class="string">'./htmlencoding'</span>).HTMLDecode;

<span class="function"><span class="keyword">function</span> <span class="title">HtmlToDom</span><span class="params">(parser)</span> {</span>

  <span class="keyword">if</span>(parser &amp;&amp; parser.write) {
    <span class="comment">// sax parser</span>
    <span class="keyword">this</span>.appendHtmlToElement = <span class="keyword">function</span>(html, element){

      <span class="keyword">var</span> currentElement = element, currentLevel = <span class="number">0</span>;

      parser.onerror = <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> {</span>};

      parser.ontext = <span class="function"><span class="keyword">function</span> <span class="params">(t)</span> {</span>
        <span class="keyword">var</span> ownerDocument = currentElement.ownerDocument || currentElement;
        <span class="keyword">var</span> newText = ownerDocument.createTextNode(t);
        currentElement.appendChild(newText);
      };

      parser.onopentag = <span class="function"><span class="keyword">function</span> <span class="params">(node)</span> {</span>
        <span class="keyword">var</span> nodeName  = node.name.toLowerCase(),
            document   = currentElement.ownerDocument || currentElement,
            newElement = document.createElement(nodeName),
            i          = <span class="number">0</span>,
            length     = (node.attributes &amp;&amp; node.attributes.length) ?
                          node.attributes.length                     :
                          <span class="number">0</span>;

        <span class="keyword">for</span> (i <span class="keyword">in</span> node.attributes) {
          <span class="keyword">if</span> (node.attributes.hasOwnProperty(i)) {
            newElement.setAttribute(i, node.attributes[i]);
          }
        }

        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;node.attributes.length; i++) {
            newElement.setAttribute(i, node.attributes.item(i));
        }
        currentElement.appendChild(newElement);
        currentElement = newElement;
      };

      parser.onclosetag = <span class="keyword">function</span>(node) {
        currentElement = currentElement.parentNode;
      };

      parser.write(html).close();

      <span class="keyword">return</span> element;
    };

  } <span class="keyword">else</span> <span class="keyword">if</span> (parser &amp;&amp; (parser.ParseHtml || parser.DefaultHandler)) {

    <span class="comment">// Forgiving HTML parser</span>

    <span class="keyword">if</span> (parser.ParseHtml) {
      <span class="comment">// davglass/node-htmlparser</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (parser.DefaultHandler){
      <span class="comment">// tautologistics/node-htmlparser</span>

      <span class="keyword">var</span> handler        = <span class="keyword">new</span> parser.DefaultHandler(),
          parserInstance = <span class="keyword">new</span> parser.Parser(handler);
      parser.ParseHtml = <span class="keyword">function</span>(rawHtml){
        parserInstance.includeLocation = <span class="literal">false</span>;
        parserInstance.parseComplete(rawHtml);
        <span class="keyword">return</span> handler.dom;
      };
    }

    <span class="keyword">this</span>.appendHtmlToElement = <span class="keyword">function</span>(html, element) {

      <span class="keyword">if</span> (<span class="keyword">typeof</span> html !== <span class="string">'string'</span>) {
        html +=<span class="string">''</span>;
      }

      <span class="keyword">var</span> parsed = parser.ParseHtml(html);

      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; parsed.length; i++) {
        setChild(element, parsed[i]);
      }

      <span class="keyword">return</span> element;
    };

  } <span class="keyword">else</span> <span class="keyword">if</span> (parser &amp;&amp; parser.moduleName == <span class="string">'HTML5'</span>) { <span class="comment">/* HTML5 parser */</span>
    <span class="keyword">this</span>.appendHtmlToElement = <span class="keyword">function</span>(html, element) {

      <span class="keyword">if</span> (<span class="keyword">typeof</span> html !== <span class="string">'string'</span>) {
        html += <span class="string">''</span>;
      }
      <span class="keyword">if</span> (html.length > <span class="number">0</span>) {
        <span class="keyword">if</span> (element.nodeType == <span class="number">9</span>) {
          <span class="keyword">new</span> parser.Parser({document: element}).parse(html);
        }
        <span class="keyword">else</span> {
          <span class="keyword">var</span> p = <span class="keyword">new</span> parser.Parser({document: element.ownerDocument});
          p.parse_fragment(html, element);
        }
      }
    };
  } <span class="keyword">else</span> {

    <span class="keyword">this</span>.appendHtmlToElement = <span class="keyword">function</span>(){
      console.log(<span class="string">''</span>);
      console.log(<span class="string">'###########################################################'</span>);
      console.log(<span class="string">'#  WARNING: No HTML parser could be found.'</span>);
      console.log(<span class="string">'#  Element.innerHTML setter support has been disabled'</span>);
      console.log(<span class="string">'#  Element.innerHTML getter support will still function'</span>);
      console.log(<span class="string">'#  Download: http://github.com/tautologistics/node-htmlparser'</span>);
      console.log(<span class="string">'###########################################################'</span>);
      console.log(<span class="string">''</span>);
    };

  }
};

<span class="comment">// utility function for forgiving parser</span>
<span class="function"><span class="keyword">function</span> <span class="title">setChild</span><span class="params">(parent, node)</span> {</span>

  <span class="keyword">var</span> c, newNode, currentDocument = parent._ownerDocument || parent;

  <span class="keyword">switch</span> (node.type)
  {
    <span class="keyword">case</span> <span class="string">'tag'</span>:
    <span class="keyword">case</span> <span class="string">'script'</span>:
    <span class="keyword">case</span> <span class="string">'style'</span>:
      <span class="keyword">try</span> {
        newNode = currentDocument.createElement(node.name);
        <span class="keyword">if</span> (node.location) {
          newNode.sourceLocation = node.location;
          newNode.sourceLocation.file = parent.sourceLocation.file;
        }
      } <span class="keyword">catch</span> (err) {
        currentDocument.raise(<span class="string">'error'</span>, <span class="string">'invalid markup'</span>, {
          exception: err,
          node : node
        });

        <span class="keyword">return</span> <span class="literal">null</span>;
      }
    <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="string">'text'</span>:
      newNode = currentDocument.createTextNode(HTMLDecode(node.data));
    <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="string">'comment'</span>:
      newNode = currentDocument.createComment(node.data);
    <span class="keyword">break</span>;

    <span class="keyword">default</span>:
      <span class="keyword">return</span> <span class="literal">null</span>;
    <span class="keyword">break</span>;
  }

  <span class="keyword">if</span> (!newNode)
    <span class="keyword">return</span> <span class="literal">null</span>;

  <span class="keyword">if</span> (node.attribs) {
    <span class="keyword">for</span> (c <span class="keyword">in</span> node.attribs) {
      <span class="comment">// catchin errors here helps with improperly escaped attributes</span>
      <span class="comment">// but properly fixing parent should (can only?) be done in the htmlparser itself</span>
      <span class="keyword">try</span> {
        newNode.setAttribute(c.toLowerCase(), HTMLDecode(node.attribs[c]));
      } <span class="keyword">catch</span>(e2) { <span class="comment">/* noop */</span> }
    }
  }

  <span class="keyword">if</span> (node.children) {
    <span class="keyword">for</span> (c = <span class="number">0</span>; c &lt; node.children.length; c++) {
      setChild(newNode, node.children[c]);
    }
  }

  <span class="keyword">try</span>{
    <span class="keyword">return</span> parent.appendChild(newNode);
  }<span class="keyword">catch</span>(err){
    currentDocument.raise(<span class="string">'error'</span>, err.message, {
          exception: err,
          node : node
        });
    <span class="keyword">return</span> <span class="literal">null</span>;    
  }
}

exports.HtmlToDom = HtmlToDom;
</code></pre>