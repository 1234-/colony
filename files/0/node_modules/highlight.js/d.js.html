<h1>d.js</h1>
<pre><code class="lang-js">module.exports = <span class="comment">/**
 * Known issues:
 *
 * - invalid hex string literals will be recognized as a double quoted strings
 *   but 'x' at the beginning of string will not be matched
 *
 * - delimited string literals are not checked for matching end delimiter
 *   (not possible to do with js regexp)
 *
 * - content of token string is colored as a string (i.e. no keyword coloring inside a token string)
 *   also, content of token string is not validated to contain only valid D tokens
 *
 * - special token sequence rule is not strictly following D grammar (anything following #line
 *   up to the end of line is matched as special token sequence)
 */</span>

<span class="keyword">function</span>(hljs) {

	<span class="comment">/**
	 * Language keywords
	 *
	 * @type {Object}
	 */</span>
	<span class="keyword">var</span> D_KEYWORDS = {
		keyword:
			<span class="string">'abstract alias align asm assert auto body break byte case cast catch class '</span> +
			<span class="string">'const continue debug default delete deprecated do else enum export extern final '</span> +
			<span class="string">'finally for foreach foreach_reverse|10 goto if immutable import in inout int '</span> +
			<span class="string">'interface invariant is lazy macro mixin module new nothrow out override package '</span> +
			<span class="string">'pragma private protected public pure ref return scope shared static struct '</span> +
			<span class="string">'super switch synchronized template this throw try typedef typeid typeof union '</span> +
			<span class="string">'unittest version void volatile while with __FILE__ __LINE__ __gshared|10 '</span> +
			<span class="string">'__thread __traits __DATE__ __EOF__ __TIME__ __TIMESTAMP__ __VENDOR__ __VERSION__'</span>,
		built_in:
			<span class="string">'bool cdouble cent cfloat char creal dchar delegate double dstring float function '</span> +
			<span class="string">'idouble ifloat ireal long real short string ubyte ucent uint ulong ushort wchar '</span> +
			<span class="string">'wstring'</span>,
		literal:
			<span class="string">'false null true'</span>
	};

	<span class="comment">/**
	 * Number literal regexps
	 *
	 * @type {String}
	 */</span>
	<span class="keyword">var</span> decimal_integer_re = <span class="string">'(0|[1-9][\\d_]*)'</span>,
		decimal_integer_nosus_re = <span class="string">'(0|[1-9][\\d_]*|\\d[\\d_]*|[\\d_]+?\\d)'</span>,
		binary_integer_re = <span class="string">'0[bB][01_]+'</span>,
		hexadecimal_digits_re = <span class="string">'([\\da-fA-F][\\da-fA-F_]*|_[\\da-fA-F][\\da-fA-F_]*)'</span>,
		hexadecimal_integer_re = <span class="string">'0[xX]'</span> + hexadecimal_digits_re,

		decimal_exponent_re = <span class="string">'([eE][+-]?'</span> + decimal_integer_nosus_re + <span class="string">')'</span>,
		decimal_float_re = <span class="string">'('</span> + decimal_integer_nosus_re + <span class="string">'(\\.\\d*|'</span> + decimal_exponent_re + <span class="string">')|'</span> +
								<span class="string">'\\d+\\.'</span> + decimal_integer_nosus_re + decimal_integer_nosus_re + <span class="string">'|'</span> +
								<span class="string">'\\.'</span> + decimal_integer_re + decimal_exponent_re + <span class="string">'?'</span> +
							<span class="string">')'</span>,
		hexadecimal_float_re = <span class="string">'(0[xX]('</span> +
									hexadecimal_digits_re + <span class="string">'\\.'</span> + hexadecimal_digits_re + <span class="string">'|'</span>+
									<span class="string">'\\.?'</span> + hexadecimal_digits_re +
							   <span class="string">')[pP][+-]?'</span> + decimal_integer_nosus_re + <span class="string">')'</span>,

		integer_re = <span class="string">'('</span> +
			decimal_integer_re + <span class="string">'|'</span> +
			binary_integer_re  + <span class="string">'|'</span> +
		 	hexadecimal_integer_re   +
		<span class="string">')'</span>,

		float_re = <span class="string">'('</span> +
			hexadecimal_float_re + <span class="string">'|'</span> +
			decimal_float_re  +
		<span class="string">')'</span>;

	<span class="comment">/**
	 * Escape sequence supported in D string and character literals
	 *
	 * @type {String}
	 */</span>
	<span class="keyword">var</span> escape_sequence_re = <span class="string">'\\\\('</span> +
							<span class="string">'[\'"\\?\\\\abfnrtv]|'</span> +	<span class="comment">// common escapes</span>
							<span class="string">'u[\\dA-Fa-f]{4}|'</span> + 		<span class="comment">// four hex digit unicode codepoint</span>
							<span class="string">'[0-7]{1,3}|'</span> + 			<span class="comment">// one to three octal digit ascii char code</span>
							<span class="string">'x[\\dA-Fa-f]{2}|'</span> +		<span class="comment">// two hex digit ascii char code</span>
							<span class="string">'U[\\dA-Fa-f]{8}'</span> +			<span class="comment">// eight hex digit unicode codepoint</span>
						  <span class="string">')|'</span> +
						  <span class="string">'&amp;[a-zA-Z\\d]{2,};'</span>;			<span class="comment">// named character entity</span>


	<span class="comment">/**
	 * D integer number literals
	 *
	 * @type {Object}
	 */</span>
	<span class="keyword">var</span> D_INTEGER_MODE = {
		className: <span class="string">'number'</span>,
    	begin: <span class="string">'\\b'</span> + integer_re + <span class="string">'(L|u|U|Lu|LU|uL|UL)?'</span>,
    	relevance: <span class="number">0</span>
	};

	<span class="comment">/**
	 * [D_FLOAT_MODE description]
	 * @type {Object}
	 */</span>
	<span class="keyword">var</span> D_FLOAT_MODE = {
		className: <span class="string">'number'</span>,
		begin: <span class="string">'\\b('</span> +
				float_re + <span class="string">'([fF]|L|i|[fF]i|Li)?|'</span> +
				integer_re + <span class="string">'(i|[fF]i|Li)'</span> +
			<span class="string">')'</span>,
		relevance: <span class="number">0</span>
	};

	<span class="comment">/**
	 * D character literal
	 *
	 * @type {Object}
	 */</span>
	<span class="keyword">var</span> D_CHARACTER_MODE = {
		className: <span class="string">'string'</span>,
		begin: <span class="string">'\'('</span> + escape_sequence_re + <span class="string">'|.)'</span>, end: <span class="string">'\''</span>,
		illegal: <span class="string">'.'</span>
	};

	<span class="comment">/**
	 * D string escape sequence
	 *
	 * @type {Object}
	 */</span>
	<span class="keyword">var</span> D_ESCAPE_SEQUENCE = {
		begin: escape_sequence_re,
		relevance: <span class="number">0</span>
	}

	<span class="comment">/**
	 * D double quoted string literal
	 *
	 * @type {Object}
	 */</span>
	<span class="keyword">var</span> D_STRING_MODE = {
		className: <span class="string">'string'</span>,
		begin: <span class="string">'"'</span>,
		contains: [D_ESCAPE_SEQUENCE],
		end: <span class="string">'"[cwd]?'</span>,
		relevance: <span class="number">0</span>
	};

	<span class="comment">/**
	 * D wysiwyg and delimited string literals
	 *
	 * @type {Object}
	 */</span>
	<span class="keyword">var</span> D_WYSIWYG_DELIMITED_STRING_MODE = {
		className: <span class="string">'string'</span>,
		begin: <span class="string">'[rq]"'</span>,
		end: <span class="string">'"[cwd]?'</span>,
		relevance: <span class="number">5</span>
	};

	<span class="comment">/**
	 * D alternate wysiwyg string literal
	 *
	 * @type {Object}
	 */</span>
	<span class="keyword">var</span> D_ALTERNATE_WYSIWYG_STRING_MODE = {
		className: <span class="string">'string'</span>,
		begin: <span class="string">'`'</span>,
		end: <span class="string">'`[cwd]?'</span>
	};

	<span class="comment">/**
	 * D hexadecimal string literal
	 *
	 * @type {Object}
	 */</span>
	<span class="keyword">var</span> D_HEX_STRING_MODE = {
		className: <span class="string">'string'</span>,
		begin: <span class="string">'x"[\\da-fA-F\\s\\n\\r]*"[cwd]?'</span>,
		relevance: <span class="number">10</span>
	};

	<span class="comment">/**
	 * D delimited string literal
	 *
	 * @type {Object}
	 */</span>
	<span class="keyword">var</span> D_TOKEN_STRING_MODE = {
		className: <span class="string">'string'</span>,
		begin: <span class="string">'q"\\{'</span>,
		end: <span class="string">'\\}"'</span>
	};

	<span class="comment">/**
	 * Hashbang support
	 *
	 * @type {Object}
	 */</span>
	<span class="keyword">var</span> D_HASHBANG_MODE = {
		className: <span class="string">'shebang'</span>,
		begin: <span class="string">'^#!'</span>,
		end: <span class="string">'$'</span>,
		relevance: <span class="number">5</span>
	};

	<span class="comment">/**
	 * D special token sequence
	 *
	 * @type {Object}
	 */</span>
	<span class="keyword">var</span> D_SPECIAL_TOKEN_SEQUENCE_MODE = {
		className: <span class="string">'preprocessor'</span>,
		begin: <span class="string">'#(line)'</span>,
		end: <span class="string">'$'</span>,
		relevance: <span class="number">5</span>
	};

	<span class="comment">/**
	 * D attributes
	 *
	 * @type {Object}
	 */</span>
	<span class="keyword">var</span> D_ATTRIBUTE_MODE = {
		className: <span class="string">'keyword'</span>,
		begin: <span class="string">'@[a-zA-Z_][a-zA-Z_\\d]*'</span>
	};

	<span class="comment">/**
	 * D nesting comment
	 *
	 * @type {Object}
	 */</span>
	<span class="keyword">var</span> D_NESTING_COMMENT_MODE = {
		className: <span class="string">'comment'</span>,
		begin: <span class="string">'\\/\\+'</span>,
		contains: [<span class="string">'self'</span>],
		end: <span class="string">'\\+\\/'</span>,
		relevance: <span class="number">10</span>
	}

	<span class="keyword">return</span> {
		lexems: hljs.UNDERSCORE_IDENT_RE,
		keywords: D_KEYWORDS,
		contains: [
			hljs.C_LINE_COMMENT_MODE,
  			hljs.C_BLOCK_COMMENT_MODE,
  			D_NESTING_COMMENT_MODE,
  			D_HEX_STRING_MODE,
  			D_STRING_MODE,
  			D_WYSIWYG_DELIMITED_STRING_MODE,
  			D_ALTERNATE_WYSIWYG_STRING_MODE,
  			D_TOKEN_STRING_MODE,
  			D_FLOAT_MODE,
  			D_INTEGER_MODE,
  			D_CHARACTER_MODE,
  			D_HASHBANG_MODE,
  			D_SPECIAL_TOKEN_SEQUENCE_MODE,
  			D_ATTRIBUTE_MODE
		]
	};
};</code></pre>