<h1>jsdom</h1>
<pre><code class="lang-js"><span class="keyword">var</span> dom      = exports.dom = require(<span class="string">"./jsdom/level3/index"</span>).dom,
    features = require(<span class="string">'./jsdom/browser/documentfeatures'</span>),
    fs       = require(<span class="string">"fs"</span>),
    pkg      = JSON.parse(fs.readFileSync(__dirname + <span class="string">"/../package.json"</span>)),
    request  = require(<span class="string">'request'</span>),
    URL      = require(<span class="string">'url'</span>);

<span class="keyword">var</span> style = require(<span class="string">'./jsdom/level2/style'</span>);
exports.defaultLevel = dom.level3.html;
exports.browserAugmentation = require(<span class="string">"./jsdom/browser/index"</span>).browserAugmentation;
exports.windowAugmentation = require(<span class="string">"./jsdom/browser/index"</span>).windowAugmentation;

<span class="comment">// Proxy feature functions to features module.</span>
[<span class="string">'availableDocumentFeatures'</span>,
 <span class="string">'defaultDocumentFeatures'</span>,
 <span class="string">'applyDocumentFeatures'</span>].forEach(<span class="function"><span class="keyword">function</span> <span class="params">(propName)</span> {</span>
  exports.__defineGetter__(propName, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> features[propName];
  });
  exports.__defineSetter__(propName, <span class="function"><span class="keyword">function</span> <span class="params">(val)</span> {</span>
    <span class="keyword">return</span> features[propName] = val;
  });
});

exports.debugMode = <span class="literal">false</span>;

<span class="keyword">var</span> createWindow = exports.createWindow = require(<span class="string">"./jsdom/browser/index"</span>).createWindow;

exports.__defineGetter__(<span class="string">'version'</span>, <span class="keyword">function</span>() {
  <span class="keyword">return</span> pkg.version;
});

exports.level = <span class="function"><span class="keyword">function</span> <span class="params">(level, feature)</span> {</span>
	<span class="keyword">if</span>(!feature) feature = <span class="string">'core'</span>
	<span class="keyword">return</span> require(<span class="string">'./jsdom/level'</span> + level + <span class="string">'/'</span> + feature).dom[<span class="string">'level'</span> + level][feature]
}

exports.jsdom = <span class="function"><span class="keyword">function</span> <span class="params">(html, level, options)</span> {</span>

  options = options || {};
  <span class="keyword">if</span>(<span class="keyword">typeof</span> level == <span class="string">"string"</span>) {
    level = exports.level(level, <span class="string">'html'</span>)
  } <span class="keyword">else</span> {
    level   = level || exports.defaultLevel;
  }

  <span class="keyword">if</span> (!options.url) {
    options.url = (module.parent.id === <span class="string">'jsdom'</span>) ?
                  module.parent.parent.filename  :
                  module.parent.filename;
  }

  <span class="keyword">var</span> browser = exports.browserAugmentation(level, options),
      doc     = (browser.HTMLDocument)             ?
                 <span class="keyword">new</span> browser.HTMLDocument(options) :
                 <span class="keyword">new</span> browser.Document(options);

  <span class="keyword">if</span> (options.features &amp;&amp; options.features.QuerySelector) {
    require(<span class="string">"./jsdom/selectors/index"</span>).applyQuerySelector(doc, level);
  }

  features.applyDocumentFeatures(doc, options.features);

  <span class="keyword">if</span> (<span class="keyword">typeof</span> html === <span class="string">'undefined'</span> || html === <span class="literal">null</span>) {
    doc.write(<span class="string">'&lt;html>&lt;head>&lt;/head>&lt;body>&lt;/body>&lt;/html>'</span>);
  } <span class="keyword">else</span> {
    doc.write(html + <span class="string">''</span>);
  }

  <span class="keyword">if</span> (doc.close &amp;&amp; !options.deferClose) {
    doc.close();
  }

  <span class="comment">// Kept for backwards-compatibility. The window is lazily created when</span>
  <span class="comment">// document.parentWindow or document.defaultView is accessed.</span>
  doc.createWindow = <span class="keyword">function</span>() {
    <span class="comment">// Remove ourself</span>
    <span class="keyword">if</span> (doc.createWindow) {
      <span class="keyword">delete</span> doc.createWindow;
    }
    <span class="keyword">return</span> doc.parentWindow;
  };

  <span class="keyword">return</span> doc;
};

exports.html = <span class="keyword">function</span>(html, level, options) {
  html += <span class="string">''</span>;

  <span class="comment">// TODO: cache a regex and use it here instead</span>
  <span class="comment">//       or make the parser handle it</span>
  <span class="keyword">var</span> htmlLowered = html.toLowerCase();

  <span class="comment">// body</span>
  <span class="keyword">if</span> (!~htmlLowered.indexOf(<span class="string">'&lt;body'</span>)) {
    html = <span class="string">'&lt;body>'</span> + html + <span class="string">'&lt;/body>'</span>;
  }

  <span class="comment">// html</span>
  <span class="keyword">if</span> (!~htmlLowered.indexOf(<span class="string">'&lt;html'</span>)) {
    html = <span class="string">'&lt;html>'</span> + html + <span class="string">'&lt;/html>'</span>;
  }
  <span class="keyword">return</span> exports.jsdom(html, level, options);
};

exports.jQueryify = exports.jsdom.jQueryify = <span class="function"><span class="keyword">function</span> <span class="params">(window <span class="comment">/* path [optional], callback */</span>)</span> {</span>

  <span class="keyword">if</span> (!window || !window.document) { <span class="keyword">return</span>; }

  <span class="keyword">var</span> args = Array.prototype.slice.call(arguments),
      callback = (<span class="keyword">typeof</span>(args[args.length - <span class="number">1</span>]) === <span class="string">'function'</span>) &amp;&amp; args.pop(),
      path,
      jQueryTag = window.document.createElement(<span class="string">"script"</span>);
      jQueryTag.className = <span class="string">"jsdom"</span>;

  <span class="keyword">if</span> (args.length > <span class="number">1</span> &amp;&amp; <span class="keyword">typeof</span>(args[<span class="number">1</span>] === <span class="string">'string'</span>)) {
    path = args[<span class="number">1</span>];
  }

  <span class="keyword">var</span> features = window.document.implementation._features;

  window.document.implementation.addFeature(<span class="string">'FetchExternalResources'</span>, [<span class="string">'script'</span>]);
  window.document.implementation.addFeature(<span class="string">'ProcessExternalResources'</span>, [<span class="string">'script'</span>]);
  window.document.implementation.addFeature(<span class="string">'MutationEvents'</span>, [<span class="string">"1.0"</span>]);
  jQueryTag.src = path || <span class="string">'http://code.jquery.com/jquery-latest.js'</span>;
  window.document.body.appendChild(jQueryTag);

  jQueryTag.onload = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (callback) {
      callback(window, window.jQuery);
    }

    window.document.implementation._features = features;
  };

  <span class="keyword">return</span> window;
};


exports.env = exports.jsdom.env = <span class="keyword">function</span>() {
  <span class="keyword">var</span>
  args        = Array.prototype.slice.call(arguments),
  config      = exports.env.processArguments(args),
  callback    = config.done,
  processHTML = <span class="keyword">function</span>(err, html) {

    html += <span class="string">''</span>;
    <span class="keyword">if</span>(err) {
      <span class="keyword">return</span> callback(err);
    }

    config.scripts = config.scripts || [];
    <span class="keyword">if</span> (<span class="keyword">typeof</span> config.scripts === <span class="string">'string'</span>) {
      config.scripts = [config.scripts];
    }

    config.src = config.src || [];
    <span class="keyword">if</span> (<span class="keyword">typeof</span> config.src === <span class="string">'string'</span>) {
      config.src = [config.src];
    }

    <span class="keyword">var</span>
    options    = {
      features: config.features || {
        <span class="string">'FetchExternalResources'</span> : <span class="literal">false</span>,
        <span class="string">'ProcessExternalResources'</span> : <span class="literal">false</span>
      },
      url: config.url
    },
    window     = exports.html(html, <span class="literal">null</span>, options).createWindow(),
    features   = JSON.parse(JSON.stringify(window.document.implementation._features)),
    docsLoaded = <span class="number">0</span>,
    totalDocs  = config.scripts.length + config.src.length,
    readyState = <span class="literal">null</span>,
    errors     = <span class="literal">null</span>;

    <span class="keyword">if</span> (!window || !window.document) {
      <span class="keyword">return</span> callback(<span class="keyword">new</span> Error(<span class="string">'JSDOM: a window object could not be created.'</span>));
    }

    <span class="keyword">if</span>( config.document ) {
      window.document._referrer = config.document.referrer;
      window.document._cookie = config.document.cookie;
    }

    window.document.implementation.addFeature(<span class="string">'FetchExternalResources'</span>, [<span class="string">'script'</span>]);
    window.document.implementation.addFeature(<span class="string">'ProcessExternalResources'</span>, [<span class="string">'script'</span>]);
    window.document.implementation.addFeature(<span class="string">'MutationEvents'</span>, [<span class="string">'1.0'</span>]);

    <span class="keyword">var</span> scriptComplete = <span class="keyword">function</span>() {
      docsLoaded++;
      <span class="keyword">if</span> (docsLoaded >= totalDocs) {
        window.document.implementation._features = features;

        <span class="keyword">if</span> (errors) {
          errors = errors.concat(window.document.errors || []);
        }

        process.nextTick(<span class="keyword">function</span>() { callback(errors, window); });
      }
    }

    <span class="keyword">if</span> (config.scripts.length > <span class="number">0</span> || config.src.length > <span class="number">0</span>) {
      config.scripts.forEach(<span class="keyword">function</span>(src) {
        <span class="keyword">var</span> script = window.document.createElement(<span class="string">'script'</span>);
        script.className = <span class="string">"jsdom"</span>;
        script.onload = <span class="keyword">function</span>() {
          scriptComplete()
        };

        script.onerror = <span class="keyword">function</span>(e) {
          <span class="keyword">if</span> (!errors) {
            errors = [];
          }
          errors.push(e.error);
          scriptComplete();
        };

        script.src = src;
        <span class="keyword">try</span> {
          <span class="comment">// project against invalid dom</span>
          <span class="comment">// ex: http://www.google.com/foo#bar</span>
          window.document.documentElement.appendChild(script);
        } <span class="keyword">catch</span>(e) {
          <span class="keyword">if</span>(!errors) {
            errors=[];
          }
          errors.push(e.error || e.message);
          scriptComplete();
        }
      });

      config.src.forEach(<span class="keyword">function</span>(src) {
        <span class="keyword">var</span> script = window.document.createElement(<span class="string">'script'</span>);
        script.onload = <span class="keyword">function</span>() {
          process.nextTick(scriptComplete);
        };

        script.onerror = <span class="keyword">function</span>(e) {
          <span class="keyword">if</span> (!errors) {
            errors = [];
          }
          errors.push(e.error || e.message);
          <span class="comment">// nextTick so that an exception within scriptComplete won't cause</span>
          <span class="comment">// another script onerror (which would be an infinite loop)</span>
          process.nextTick(scriptComplete);
        };

        script.text = src;
        window.document.documentElement.appendChild(script);
        window.document.documentElement.removeChild(script);
      });
    } <span class="keyword">else</span> {
      scriptComplete();
    }
  };

  config.html += <span class="string">''</span>;

  <span class="comment">// Handle markup</span>
  <span class="keyword">if</span> (config.html.indexOf(<span class="string">"\n"</span>) > <span class="number">0</span> || config.html.match(<span class="regexp">/^\W*&lt;/</span>)) {
    processHTML(<span class="literal">null</span>, config.html);

  <span class="comment">// Handle url/file</span>
  } <span class="keyword">else</span> {
    <span class="keyword">var</span> url = URL.parse(config.html);
    config.url = config.url || url.href;
    <span class="keyword">if</span> (url.hostname) {
      request({
        uri      : url,
        encoding : config.encoding || <span class="string">'utf8'</span>,
        headers  : config.headers || {}
      },
      <span class="keyword">function</span>(err, request, body) {
        processHTML(err, body);
      });
    } <span class="keyword">else</span> {
      fs.readFile(config.html, processHTML);
    }
  }
};

<span class="comment">/*
  Since jsdom.env() is a helper for quickly and easily setting up a
  window with scripts and such already loaded into it, the arguments
  should be fairly flexible.  Here are the requirements

  1) collect `html` (url, string, or file on disk)  (STRING)
  2) load `code` into the window (array of scripts) (ARRAY)
  3) callback when resources are `done`             (FUNCTION)
  4) configuration                                  (OBJECT)

  Rules:
  + if there is one argument it had better be an object with atleast
    a `html` and `done` property (other properties are gravy)

  + arguments above are pulled out of the arguments and put into the
    config object that is returned
*/</span>
exports.env.processArguments = <span class="keyword">function</span>(args) {
  <span class="keyword">if</span> (!args || !args.length || args.length &lt; <span class="number">1</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'No arguments passed to jsdom.env().'</span>);
  }

  <span class="keyword">var</span>
  props = {
    <span class="string">'html'</span>    : <span class="literal">true</span>,
    <span class="string">'done'</span>    : <span class="literal">true</span>,
    <span class="string">'scripts'</span> : <span class="literal">false</span>,
    <span class="string">'config'</span>  : <span class="literal">false</span>,
    <span class="string">'url'</span>     : <span class="literal">false</span>,  <span class="comment">// the URL for location.href if different from html</span>
    <span class="string">'document'</span>: <span class="literal">false</span>   <span class="comment">// HTMLDocument properties</span>
  },
  propKeys = Object.keys(props),
  config = {
    code : []
  },
  l    = args.length
  ;
  <span class="keyword">if</span> (l === <span class="number">1</span>) {
    config = args[<span class="number">0</span>];
  } <span class="keyword">else</span> {
    args.forEach(<span class="keyword">function</span>(v) {
      <span class="keyword">var</span> type = <span class="keyword">typeof</span> v;
      <span class="keyword">if</span> (!v) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (type === <span class="string">'string'</span> || v + <span class="string">''</span> === v) {
        config.html = v;
      } <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'object'</span>) {
        <span class="comment">// Array</span>
        <span class="keyword">if</span> (v.length &amp;&amp; v[<span class="number">0</span>]) {
          config.scripts = v;
        } <span class="keyword">else</span> {
          <span class="comment">// apply missing required properties if appropriate</span>
          propKeys.forEach(<span class="keyword">function</span>(req) {

            <span class="keyword">if</span> (<span class="keyword">typeof</span> v[req] !== <span class="string">'undefined'</span> &amp;&amp;
                <span class="keyword">typeof</span> config[req] === <span class="string">'undefined'</span>) {

              config[req] = v[req];
              <span class="keyword">delete</span> v[req];
            }
          });
          config.config = v;
        }
      } <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'function'</span>) {
        config.done = v;
      }
    });
  }

  propKeys.forEach(<span class="keyword">function</span>(req) {
    <span class="keyword">var</span> required = props[req];
    <span class="keyword">if</span> (required &amp;&amp; <span class="keyword">typeof</span> config[req] === <span class="string">'undefined'</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"jsdom.env requires a '"</span> + req + <span class="string">"' argument"</span>);
    }
  });
  <span class="keyword">return</span> config;
};
</code></pre>