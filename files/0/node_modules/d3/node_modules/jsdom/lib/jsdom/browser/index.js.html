<h1>index.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> http          = require(<span class="string">'http'</span>),
    URL           = require(<span class="string">'url'</span>),
    HtmlToDom     = require(<span class="string">'./htmltodom'</span>).HtmlToDom,
    domToHtml     = require(<span class="string">'./domtohtml'</span>).domToHtml,
    htmlencoding  = require(<span class="string">'./htmlencoding'</span>),
    HTMLEncode    = htmlencoding.HTMLEncode,
    HTMLDecode    = htmlencoding.HTMLDecode,
    jsdom         = require(<span class="string">'../../jsdom'</span>),
    Contextify    = <span class="literal">null</span>;

<span class="keyword">try</span> {
  Contextify = require(<span class="string">'contextify'</span>);
} <span class="keyword">catch</span> (e) {
  <span class="comment">// Shim for when the contextify compilation fails.</span>
  <span class="comment">// This is not quite as correct, but it gets the job done.</span>
  Contextify = <span class="keyword">function</span>(sandbox) {
    <span class="keyword">var</span> vm = require(<span class="string">'vm'</span>);
    <span class="keyword">var</span> context = vm.createContext(sandbox);
    <span class="keyword">var</span> global = <span class="literal">null</span>;

    sandbox.run = <span class="keyword">function</span>(code, filename) {
      <span class="keyword">return</span> vm.runInContext(code, context, filename);
    };

    sandbox.getGlobal = <span class="keyword">function</span>() {
      <span class="keyword">if</span> (!global) {
        global = vm.runInContext(<span class="string">'this'</span>, context);
      }
      <span class="keyword">return</span> global;
    };

    sandbox.dispose = <span class="keyword">function</span>() {
      global = <span class="literal">null</span>;
      sandbox.run = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Called run() after dispose()."</span>);
      };
      sandbox.getGlobal = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Called getGlobal() after dispose()."</span>);
      };
      sandbox.dispose = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Called dispose() after dispose()."</span>);
      };
    };

    <span class="keyword">return</span> sandbox;
  };
}

<span class="function"><span class="keyword">function</span> <span class="title">NOT_IMPLEMENTED</span><span class="params">(target)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">function</span>() {
    <span class="keyword">if</span> (!jsdom.debugMode) {
      <span class="keyword">var</span> raise = target ? target.raise : <span class="keyword">this</span>.raise;
      raise.call(<span class="keyword">this</span>, <span class="string">'error'</span>, <span class="string">'NOT IMPLEMENTED'</span>);
    }
  };
}

<span class="comment">/**
 * Creates a window having a document. The document can be passed as option,
 * if omitted, a new document will be created.
 */</span>
exports.windowAugmentation = <span class="keyword">function</span>(dom, options) {
  options = options || {};
  <span class="keyword">var</span> window = exports.createWindow(dom, options);

  <span class="keyword">if</span> (!options.document) {
    <span class="keyword">var</span> browser = browserAugmentation(dom, options);

    <span class="keyword">if</span> (options.features &amp;&amp; options.features.QuerySelector) {
      require(__dirname + <span class="string">"/../selectors/index"</span>).applyQuerySelectorPrototype(browser);
    }

    options.document = (browser.HTMLDocument)             ?
                        <span class="keyword">new</span> browser.HTMLDocument(options) :
                        <span class="keyword">new</span> browser.Document(options);



    options.document.write(<span class="string">'&lt;html>&lt;head>&lt;/head>&lt;body>&lt;/body>&lt;/html>'</span>);
  }

  <span class="keyword">var</span> doc = window.document = options.document;

  <span class="keyword">if</span> (doc.addEventListener) {
    <span class="keyword">if</span> (doc.readyState == <span class="string">'complete'</span>) {
      <span class="keyword">var</span> ev = doc.createEvent(<span class="string">'HTMLEvents'</span>);
      ev.initEvent(<span class="string">'load'</span>, <span class="literal">false</span>, <span class="literal">false</span>);
      window.dispatchEvent(ev);
    }
    <span class="keyword">else</span> {
      doc.addEventListener(<span class="string">'load'</span>, <span class="keyword">function</span>(ev) {
        window.dispatchEvent(ev);
      });
    }
  }

  <span class="keyword">return</span> window;
};

<span class="comment">/**
 * Creates a document-less window.
 */</span>
exports.createWindow = <span class="keyword">function</span>(dom, options) {
  <span class="keyword">var</span> timers = [];

  <span class="function"><span class="keyword">function</span> <span class="title">startTimer</span><span class="params">(startFn, stopFn, callback, ms)</span> {</span>
	  <span class="keyword">var</span> res = startFn(callback, ms);
	  timers.push( [ res, stopFn ] );
	  <span class="keyword">return</span> res;
  }

  <span class="function"><span class="keyword">function</span> <span class="title">stopTimer</span><span class="params">(id)</span> {</span>
	  <span class="keyword">if</span> (<span class="keyword">typeof</span> id === <span class="string">'undefined'</span>) {
		  <span class="keyword">return</span>;
	  }
	  <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> timers) {
		  <span class="keyword">if</span> (timers[i][<span class="number">0</span>] === id) {
			  timers[i][<span class="number">1</span>].call(<span class="keyword">this</span>, id);
			  timers.splice(i, <span class="number">1</span>);
			  <span class="keyword">break</span>;
		  }
	  }
  }

  <span class="function"><span class="keyword">function</span> <span class="title">stopAllTimers</span><span class="params">()</span> {</span>
	  timers.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(t)</span> {</span>
		  t[<span class="number">1</span>].call(<span class="keyword">this</span>, t[<span class="number">0</span>]);
	  });
	  timers = [];
  }

  <span class="function"><span class="keyword">function</span> <span class="title">DOMWindow</span><span class="params">(options)</span> {</span>
    <span class="keyword">var</span> href = (options || {}).url || <span class="string">'file://'</span> + __filename;
    <span class="keyword">this</span>.location = URL.parse(href);
    <span class="keyword">this</span>.location.reload = NOT_IMPLEMENTED(<span class="keyword">this</span>);
    <span class="keyword">this</span>.location.replace = NOT_IMPLEMENTED(<span class="keyword">this</span>);
    <span class="keyword">this</span>.location.toString = <span class="keyword">function</span>() {
      <span class="keyword">return</span> href;
    };

    <span class="keyword">var</span> window = <span class="keyword">this</span>.console._window = <span class="keyword">this</span>;

    <span class="comment">/* Location hash support */</span>
    <span class="keyword">this</span>.location.__defineGetter__(<span class="string">"hash"</span>, <span class="keyword">function</span>() {
      <span class="keyword">return</span> (window.location.href.split(<span class="string">"#"</span>).length > <span class="number">1</span>)
        ? <span class="string">"#"</span>+window.location.href.split(<span class="string">"#"</span>)[<span class="number">1</span>]
        : <span class="string">""</span>;
    });

    <span class="keyword">this</span>.location.__defineSetter__(<span class="string">"hash"</span>, <span class="keyword">function</span>(val) {
      <span class="comment">/* TODO: Should fire a hashchange event, but tests aren't working */</span>
      window.location.href = window.location.href.split(<span class="string">"#"</span>)[<span class="number">0</span>] + val;
    });

    <span class="comment">/* Location search support */</span>
    <span class="keyword">this</span>.location.__defineGetter__(<span class="string">"search"</span>, <span class="keyword">function</span>() {
      <span class="keyword">return</span> (window.location.href.split(<span class="string">"?"</span>).length > <span class="number">1</span>)
        ? <span class="string">"?"</span>+window.location.href.match(<span class="regexp">/\?([^#]+)/</span>)[<span class="number">1</span>]
        : <span class="string">""</span>;
    });

    <span class="keyword">this</span>.location.__defineSetter__(<span class="string">"search"</span>, <span class="keyword">function</span>(val) {
      window.location.href = (window.location.href.indexOf(<span class="string">"?"</span>) > <span class="number">0</span>)
        ? window.location.href.replace(<span class="regexp">/\?([^#]+)/</span>, val)
        : window.location.href.match(<span class="regexp">/^([^#?]+)/</span>)[<span class="number">0</span>] + val + window.location.hash;
    });

    <span class="keyword">if</span> (options &amp;&amp; options.document) {
      options.document.location = <span class="keyword">this</span>.location;
    }
    <span class="keyword">this</span>.addEventListener = <span class="keyword">function</span>() {
      dom.Node.prototype.addEventListener.apply(window, arguments);
    };
    <span class="keyword">this</span>.removeEventListener = <span class="keyword">function</span>() {
      dom.Node.prototype.removeEventListener.apply(window, arguments);
    };
    <span class="keyword">this</span>.dispatchEvent = <span class="keyword">function</span>() {
      dom.Node.prototype.dispatchEvent.apply(window, arguments);
    };
    <span class="keyword">this</span>.raise = <span class="keyword">function</span>(){
      dom.Node.prototype.raise.apply(window.document, arguments);
    };

    <span class="keyword">this</span>.setTimeout = <span class="function"><span class="keyword">function</span> <span class="params">(fn, ms)</span> {</span> <span class="keyword">return</span> startTimer(setTimeout, clearTimeout, fn, ms); };
    <span class="keyword">this</span>.setInterval = <span class="function"><span class="keyword">function</span> <span class="params">(fn, ms)</span> {</span> <span class="keyword">return</span> startTimer(setInterval, clearInterval, fn, ms); };
    <span class="keyword">this</span>.clearInterval = stopTimer;
    <span class="keyword">this</span>.clearTimeout = stopTimer;
    <span class="keyword">this</span>.__stopAllTimers = stopAllTimers;
  }

  DOMWindow.prototype = {
    __proto__: dom,
    <span class="comment">// This implements window.frames.length, since window.frames returns a</span>
    <span class="comment">// self reference to the window object.  This value is incremented in the</span>
    <span class="comment">// HTMLFrameElement init function (see: level2/html.js).</span>
    _length : <span class="number">0</span>,
    get length () {
      <span class="keyword">return</span> <span class="keyword">this</span>._length;
    },
    close : <span class="keyword">function</span>() {
      <span class="comment">// Recursively close child frame windows, then ourselves.</span>
      <span class="keyword">var</span> currentWindow = <span class="keyword">this</span>;
      (<span class="function"><span class="keyword">function</span> <span class="title">windowCleaner</span> <span class="params">(window)</span> {</span>
        <span class="keyword">var</span> i;
        <span class="comment">// We could call window.frames.length etc, but window.frames just points</span>
        <span class="comment">// back to window.</span>
        <span class="keyword">if</span> (window.length > <span class="number">0</span>) {
          <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; window.length; i++) {
            windowCleaner(window[i]);
          }
        }
        <span class="comment">// We're already in our own window.close().</span>
        <span class="keyword">if</span> (window !== currentWindow) {
          window.close();
        }
      })(<span class="keyword">this</span>);

      <span class="keyword">if</span> (<span class="keyword">this</span>.document) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.document.body) {
          <span class="keyword">this</span>.document.body.innerHTML = <span class="string">""</span>;
        }

        <span class="keyword">if</span> (<span class="keyword">this</span>.document.close) {
          <span class="comment">// We need to empty out the event listener array because</span>
          <span class="comment">// document.close() causes 'load' event to re-fire.</span>
          <span class="keyword">this</span>.document._listeners = [];
          <span class="keyword">this</span>.document.close();
        }
        <span class="keyword">delete</span> <span class="keyword">this</span>.document;
      }

      stopAllTimers();
      <span class="comment">// Clean up the window's execution context.</span>
      <span class="comment">// dispose() is added by Contextify.</span>
      <span class="keyword">this</span>.dispose();
    },
    getComputedStyle: <span class="keyword">function</span>(node) {
      <span class="keyword">var</span> s = node.style,
          cs = {};

      <span class="keyword">for</span> (<span class="keyword">var</span> n <span class="keyword">in</span> s) {
        cs[n] = s[n];
      }
      cs.__proto__ = {
        getPropertyValue: <span class="keyword">function</span>(name) {
          <span class="keyword">return</span> node.style[name];
        }
      };
      <span class="keyword">return</span> cs;
    },
    console: {
      log:   <span class="keyword">function</span>(message) { <span class="keyword">this</span>._window.raise(<span class="string">'log'</span>,   message) },
      info:  <span class="keyword">function</span>(message) { <span class="keyword">this</span>._window.raise(<span class="string">'info'</span>,  message) },
      warn:  <span class="keyword">function</span>(message) { <span class="keyword">this</span>._window.raise(<span class="string">'warn'</span>,  message) },
      error: <span class="keyword">function</span>(message) { <span class="keyword">this</span>._window.raise(<span class="string">'error'</span>, message) }
    },
    navigator: {
      userAgent: <span class="string">'Node.js ('</span> + process.platform + <span class="string">'; U; rv:'</span> + process.version + <span class="string">')'</span>,
      appName: <span class="string">'Node.js jsDom'</span>,
      platform: process.platform,
      appVersion: process.version
    },
    XMLHttpRequest: <span class="function"><span class="keyword">function</span> <span class="title">XMLHttpRequest</span><span class="params">()</span> {</span>},

    name: <span class="string">'nodejs'</span>,
    innerWidth: <span class="number">1024</span>,
    innerHeight: <span class="number">768</span>,
    outerWidth: <span class="number">1024</span>,
    outerHeight: <span class="number">768</span>,
    pageXOffset: <span class="number">0</span>,
    pageYOffset: <span class="number">0</span>,
    screenX: <span class="number">0</span>,
    screenY: <span class="number">0</span>,
    screenLeft: <span class="number">0</span>,
    screenTop: <span class="number">0</span>,
    scrollX: <span class="number">0</span>,
    scrollY: <span class="number">0</span>,
    scrollTop: <span class="number">0</span>,
    scrollLeft: <span class="number">0</span>,
    alert: NOT_IMPLEMENTED(),
    blur: NOT_IMPLEMENTED(),
    confirm: NOT_IMPLEMENTED(),
    createPopup: NOT_IMPLEMENTED(),
    focus: NOT_IMPLEMENTED(),
    moveBy: NOT_IMPLEMENTED(),
    moveTo: NOT_IMPLEMENTED(),
    open: NOT_IMPLEMENTED(),
    print: NOT_IMPLEMENTED(),
    prompt: NOT_IMPLEMENTED(),
    resizeBy: NOT_IMPLEMENTED(),
    resizeTo: NOT_IMPLEMENTED(),
    scroll: NOT_IMPLEMENTED(),
    scrollBy: NOT_IMPLEMENTED(),
    scrollTo: NOT_IMPLEMENTED(),
    screen : {
      width : <span class="number">0</span>,
      height : <span class="number">0</span>
    },
    Image : NOT_IMPLEMENTED()
  };

  <span class="keyword">var</span> window = <span class="keyword">new</span> DOMWindow(options);

  Contextify(window);

  <span class="comment">// We need to set up self references using Contextify's getGlobal() so that</span>
  <span class="comment">// the global object identity is correct (window === this).</span>
  <span class="comment">// See Contextify README for more info.</span>
  <span class="keyword">var</span> global = window.getGlobal();

  <span class="comment">// Set up the window as if it's a top level window.</span>
  <span class="comment">// If it's not, then references will be corrected by frame/iframe code.</span>
  <span class="comment">// Note: window.frames is maintained in the HTMLFrameElement init function.</span>
  window.window = window.frames
                = window.self
                = window.parent
                = window.top = global;

  <span class="keyword">return</span> window;
};

<span class="comment">//Caching for HTMLParser require. HUGE performace boost.</span>
<span class="comment">/**
* 5000 iterations
* Without cache: ~1800+ms
* With cache: ~80ms
*/</span>
<span class="keyword">var</span> defaultParser = <span class="literal">null</span>;
<span class="function"><span class="keyword">function</span> <span class="title">getDefaultParser</span><span class="params">()</span> {</span>
  <span class="keyword">if</span> (defaultParser === <span class="literal">null</span>) {
    <span class="keyword">try</span> {
      defaultParser = require(<span class="string">'htmlparser'</span>);
    }
    <span class="keyword">catch</span> (e) {
      <span class="keyword">try</span> {
        defaultParser = require(<span class="string">'node-htmlparser/lib/node-htmlparser'</span>);
      }
      <span class="keyword">catch</span> (e2) {
        defaultParser = <span class="literal">undefined</span>;
      }
    }
  }
  <span class="keyword">return</span> defaultParser;
}

<span class="comment">/**
 * Augments the given DOM by adding browser-specific properties and methods (BOM).
 * Returns the augmented DOM.
 */</span>
<span class="keyword">var</span> browserAugmentation = exports.browserAugmentation = <span class="keyword">function</span>(dom, options) {

  <span class="keyword">if</span> (dom._augmented) {
    <span class="keyword">return</span> dom;
  }

  <span class="keyword">if</span>(!options) {
    options = {};
  }

  <span class="comment">// set up html parser - use a provided one or try and load from library</span>
  <span class="keyword">var</span> htmltodom = <span class="keyword">new</span> HtmlToDom(options.parser || getDefaultParser());

  <span class="keyword">if</span> (!dom.HTMLDocument) {
    dom.HTMLDocument = dom.Document;
  }
  <span class="keyword">if</span> (!dom.HTMLDocument.prototype.write) {
    dom.HTMLDocument.prototype.write = <span class="keyword">function</span>(html) {
      <span class="keyword">this</span>.innerHTML = html;
    };
  }

  dom.Element.prototype.getElementsByClassName = <span class="keyword">function</span>(className) {

    <span class="function"><span class="keyword">function</span> <span class="title">filterByClassName</span><span class="params">(child)</span> {</span>
      <span class="keyword">if</span> (!child) {
        <span class="keyword">return</span> <span class="literal">false</span>;
      }

      <span class="keyword">if</span> (child.nodeType &amp;&amp;
          child.nodeType === dom.Node.ENTITY_REFERENCE_NODE)
      {
        child = child._entity;
      }

      <span class="keyword">var</span> classString = child.className;
      <span class="keyword">if</span> (classString) {
        <span class="keyword">var</span> s = classString.split(<span class="string">" "</span>);
        <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;s.length; i++) {
          <span class="keyword">if</span> (s[i] === className) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
        }
      }
      <span class="keyword">return</span> <span class="literal">false</span>;
    }

    <span class="keyword">return</span> <span class="keyword">new</span> dom.NodeList(<span class="keyword">this</span>.ownerDocument || <span class="keyword">this</span>, dom.mapper(<span class="keyword">this</span>, filterByClassName));
  };

  dom.Element.prototype.__defineGetter__(<span class="string">'sourceIndex'</span>, <span class="keyword">function</span>() {
    <span class="comment">/*
    * According to QuirksMode:
    * Get the sourceIndex of element x. This is also the index number for
    * the element in the document.getElementsByTagName('*') array.
    * http://www.quirksmode.org/dom/w3c_core.html#t77
    */</span>
    <span class="keyword">var</span> items = <span class="keyword">this</span>.ownerDocument.getElementsByTagName(<span class="string">'*'</span>),
        len = items.length;

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) {
      <span class="keyword">if</span> (items[i] === <span class="keyword">this</span>) {
        <span class="keyword">return</span> i;
      }
    }
  });

  dom.Document.prototype.__defineGetter__(<span class="string">'outerHTML'</span>, <span class="keyword">function</span>() {
    <span class="keyword">return</span> domToHtml(<span class="keyword">this</span>);
  });

  dom.Element.prototype.__defineGetter__(<span class="string">'outerHTML'</span>, <span class="keyword">function</span>() {
    <span class="keyword">return</span> domToHtml(<span class="keyword">this</span>);
  });

  dom.Element.prototype.__defineGetter__(<span class="string">'innerHTML'</span>, <span class="keyword">function</span>() {

    <span class="keyword">if</span> (<span class="keyword">this</span>._tagName === <span class="string">'script'</span> &amp;&amp;
        <span class="keyword">this</span>._attributes.length > <span class="number">0</span> &amp;&amp;
        <span class="keyword">typeof</span>(<span class="keyword">this</span>._attributes._nodes.type) !== <span class="string">"undefined"</span> &amp;&amp;
        <span class="keyword">this</span>._attributes._nodes.type._nodeValue.indexOf(<span class="string">"text"</span>) === <span class="number">0</span>) {
        <span class="keyword">return</span> domToHtml(<span class="keyword">this</span>._childNodes, <span class="literal">true</span>, <span class="literal">true</span>);
    }

    <span class="keyword">return</span> domToHtml(<span class="keyword">this</span>._childNodes, <span class="literal">true</span>);
  });

  dom.Element.prototype.__defineSetter__(<span class="string">'doctype'</span>, <span class="keyword">function</span>() {
    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR);
  });
  dom.Element.prototype.__defineGetter__(<span class="string">'doctype'</span>, <span class="keyword">function</span>() {
    <span class="keyword">var</span> r = <span class="literal">null</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.nodeName == <span class="string">'#document'</span>) {
        <span class="keyword">if</span> (<span class="keyword">this</span>._doctype) {
         r = <span class="keyword">this</span>._doctype;
        }
    }
    <span class="keyword">return</span> r;
  });

  dom.Element.prototype.__defineSetter__(<span class="string">'innerHTML'</span>, <span class="keyword">function</span>(html) {
    <span class="comment">//Clear the children first:</span>
    <span class="keyword">var</span> child;
    <span class="keyword">while</span> ((child = <span class="keyword">this</span>._childNodes[<span class="number">0</span>])) {
      <span class="keyword">this</span>.removeChild(child);
    }

    <span class="keyword">if</span> (<span class="keyword">this</span>.nodeName === <span class="string">'#document'</span>) {
      parseDocType(<span class="keyword">this</span>, html);
    }
    <span class="keyword">if</span> (html !== <span class="string">""</span> &amp;&amp; html != <span class="literal">null</span>) {
      htmltodom.appendHtmlToElement(html, <span class="keyword">this</span>);
    }
    <span class="keyword">return</span> html;
  });


  dom.Document.prototype.__defineGetter__(<span class="string">'innerHTML'</span>, <span class="keyword">function</span>() {
    <span class="keyword">return</span> domToHtml(<span class="keyword">this</span>._childNodes, <span class="literal">true</span>);
  });

  dom.Document.prototype.__defineSetter__(<span class="string">'innerHTML'</span>, <span class="keyword">function</span>(html) {
    <span class="comment">//Clear the children first:</span>
    <span class="keyword">var</span> child;
    <span class="keyword">while</span> ((child = <span class="keyword">this</span>._childNodes[<span class="number">0</span>])) {
      <span class="keyword">this</span>.removeChild(child);
    }

    <span class="keyword">if</span> (<span class="keyword">this</span>.nodeName === <span class="string">'#document'</span>) {
      parseDocType(<span class="keyword">this</span>, html);
    }
    <span class="keyword">if</span> (html !== <span class="string">""</span> &amp;&amp; html != <span class="literal">null</span>) {
      htmltodom.appendHtmlToElement(html, <span class="keyword">this</span>);
    }
    <span class="keyword">return</span> html;
  });

  <span class="keyword">var</span> DOC_HTML5      = <span class="regexp">/&lt;!doctype html>/i</span>,
      DOC_TYPE       = <span class="regexp">/&lt;!DOCTYPE (\w(.|\n)*)">/i</span>,
      DOC_TYPE_START = <span class="string">'&lt;!DOCTYPE '</span>,
      DOC_TYPE_END   = <span class="string">'">'</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">parseDocType</span><span class="params">(doc, html)</span> {</span>
    <span class="keyword">var</span> publicID = <span class="string">''</span>,
        systemID = <span class="string">''</span>,
        fullDT = <span class="string">''</span>,
        name = <span class="string">'HTML'</span>,
        set = <span class="literal">true</span>,
        doctype = html.match(DOC_HTML5);

    <span class="comment">//Default, No doctype === null</span>
    doc._doctype = <span class="literal">null</span>;

    <span class="keyword">if</span> (doctype &amp;&amp; doctype[<span class="number">0</span>]) { <span class="comment">//Handle the HTML shorty doctype</span>
      fullDT = doctype[<span class="number">0</span>];
    } <span class="keyword">else</span> { <span class="comment">//Parse the doctype</span>
      <span class="comment">// find the start</span>
      <span class="keyword">var</span> start     = html.indexOf(DOC_TYPE_START),
          end       = html.indexOf(DOC_TYPE_END),
          docString;

      <span class="keyword">if</span> (start &lt; <span class="number">0</span> || end &lt; <span class="number">0</span>) {
        <span class="keyword">return</span>;
      }

      docString = html.substr(start, (end-start)+DOC_TYPE_END.length);
      doctype = docString.replace(<span class="regexp">/[\n\r]/g</span>,<span class="string">''</span>).match(DOC_TYPE);

      <span class="keyword">if</span> (!doctype) {
        <span class="keyword">return</span>;
      }

      fullDT = doctype[<span class="number">0</span>];
      doctype = doctype[<span class="number">1</span>].split(<span class="string">' "'</span>);
      <span class="keyword">var</span> _id1 = doctype.length ? doctype.pop().replace(<span class="regexp">/"/g</span>, <span class="string">''</span>) : <span class="string">''</span>,
          _id2 = doctype.length ? doctype.pop().replace(<span class="regexp">/"/g</span>, <span class="string">''</span>) : <span class="string">''</span>;

      <span class="keyword">if</span> (_id1.indexOf(<span class="string">'-//'</span>) !== -<span class="number">1</span>) {
        publicID = _id1;
      }
      <span class="keyword">if</span> (_id2.indexOf(<span class="string">'-//'</span>) !== -<span class="number">1</span>) {
        publicID = _id2;
      }
      <span class="keyword">if</span> (_id1.indexOf(<span class="string">'://'</span>) !== -<span class="number">1</span>) {
        systemID = _id1;
      }
      <span class="keyword">if</span> (_id2.indexOf(<span class="string">'://'</span>) !== -<span class="number">1</span>) {
        systemID = _id2;
      }
      <span class="keyword">if</span> (doctype.length) {
        doctype = doctype[<span class="number">0</span>].split(<span class="string">' '</span>);
        name = doctype[<span class="number">0</span>].toUpperCase();
      }
    }
    doc._doctype = <span class="keyword">new</span> dom.DOMImplementation().createDocumentType(name, publicID, systemID);
    doc._doctype._ownerDocument = doc;
    doc._doctype._fullDT = fullDT;
    doc._doctype.toString = <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">this</span>._fullDT;
    };
  }

  dom.Document.prototype.getElementsByClassName = <span class="keyword">function</span>(className) {

    <span class="function"><span class="keyword">function</span> <span class="title">filterByClassName</span><span class="params">(child)</span> {</span>
      <span class="keyword">if</span> (!child) {
        <span class="keyword">return</span> <span class="literal">false</span>;
      }

      <span class="keyword">if</span> (child.nodeType &amp;&amp;
          child.nodeType === dom.Node.ENTITY_REFERENCE_NODE)
      {
        child = child._entity;
      }

      <span class="keyword">var</span> classString = child.className;
      <span class="keyword">if</span> (classString) {
        <span class="keyword">var</span> s = classString.split(<span class="string">" "</span>);
        <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;s.length; i++) {
          <span class="keyword">if</span> (s[i] === className) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
        }
      }
      <span class="keyword">return</span> <span class="literal">false</span>;
    }

    <span class="keyword">return</span> <span class="keyword">new</span> dom.NodeList(<span class="keyword">this</span>.ownerDocument || <span class="keyword">this</span>, dom.mapper(<span class="keyword">this</span>, filterByClassName));
  };

  dom.Element.prototype.__defineGetter__(<span class="string">'nodeName'</span>, <span class="keyword">function</span>(val) {
    <span class="keyword">return</span> <span class="keyword">this</span>._nodeName.toUpperCase();
  });

  dom.Element.prototype.__defineGetter__(<span class="string">'tagName'</span>, <span class="keyword">function</span>(val) {
    <span class="keyword">var</span> t = <span class="keyword">this</span>._tagName.toUpperCase();
    <span class="comment">//Document should not return a tagName</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.nodeName === <span class="string">'#document'</span>) {
      t = <span class="literal">null</span>;
    }
    <span class="keyword">return</span> t;
  });

  dom.Element.prototype.scrollTop = <span class="number">0</span>;
  dom.Element.prototype.scrollLeft = <span class="number">0</span>;

  dom.Document.prototype.__defineGetter__(<span class="string">'parentWindow'</span>, <span class="keyword">function</span>() {
    <span class="keyword">if</span> (!<span class="keyword">this</span>._parentWindow) {
      <span class="keyword">var</span> window = exports.windowAugmentation(dom, {document: <span class="keyword">this</span>, url: <span class="keyword">this</span>.URL});
      <span class="keyword">this</span>._parentWindow = window.getGlobal();
    }
    <span class="keyword">return</span> <span class="keyword">this</span>._parentWindow;
  });

  dom.Document.prototype.__defineSetter__(<span class="string">'parentWindow'</span>, <span class="keyword">function</span>(window) {
    <span class="keyword">this</span>._parentWindow = window.getGlobal();
  });

  dom.Document.prototype.__defineGetter__(<span class="string">'defaultView'</span>, <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="keyword">this</span>.parentWindow;
  });

  dom._augmented = <span class="literal">true</span>;
  <span class="keyword">return</span> dom;
};
</code></pre>