<h1>core.js</h1>
<pre><code class="lang-js"><span class="comment">/*
  ServerJS Javascript DOM Level 1
*/</span>

<span class="comment">// utility functions</span>
<span class="keyword">var</span> attachId = <span class="keyword">function</span>(id,elm,doc) {
  <span class="keyword">if</span> (id &amp;&amp; elm &amp;&amp; doc) {
    <span class="keyword">if</span> (!doc._ids[id]) {
      doc._ids[id] = [];
    }
    doc._ids[id].push(elm);
  }
};
<span class="keyword">var</span> detachId = <span class="keyword">function</span>(id,elm,doc) {
  <span class="keyword">var</span> elms, i;
  <span class="keyword">if</span> (id &amp;&amp; elm &amp;&amp; doc) {
    <span class="keyword">if</span> (doc._ids &amp;&amp; doc._ids[id]) {
      elms = doc._ids[id];
      <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;elms.length;i++) {
        <span class="keyword">if</span> (elms[i] === elm) {
          elms.splice(i,<span class="number">1</span>);
          i--;
        }
      }
      <span class="keyword">if</span> (elms.length === <span class="number">0</span>) {
        <span class="keyword">delete</span> doc._ids[id];
      }
    }
  }
};

<span class="keyword">var</span> core = {

  mapper: <span class="keyword">function</span>(parent, filter, recursive) {
    <span class="keyword">return</span> <span class="keyword">function</span>() {
      <span class="keyword">return</span> core.mapDOMNodes(parent, recursive !== <span class="literal">false</span>, filter);
    };
  },

  <span class="comment">// Returns Array</span>
  mapDOMNodes : <span class="keyword">function</span>(parent, recursive, callback) {
    <span class="function"><span class="keyword">function</span> <span class="title">visit</span><span class="params">(parent, result)</span> {</span>
      <span class="keyword">return</span> parent.childNodes.reduce(reducer, result);
    }

    <span class="function"><span class="keyword">function</span> <span class="title">reducer</span><span class="params">(array, child)</span> {</span>
      <span class="keyword">if</span> (callback(child)) {
        array.push(child);
      }
      <span class="keyword">if</span> (recursive &amp;&amp; child._childNodes) {
        visit(child, array);
      }
      <span class="keyword">return</span> array;
    }

    <span class="keyword">return</span> visit(parent, []);
  },

  visitTree: <span class="keyword">function</span>(root, callback) {
    <span class="keyword">var</span> cur = root; <span class="comment">// TODO: Unroll this.</span>

    <span class="function"><span class="keyword">function</span> <span class="title">visit</span><span class="params">(el)</span> {</span>
      <span class="keyword">if</span> (el) {
        callback(el);
        <span class="keyword">if</span> (el._childNodes) {
          <span class="keyword">var</span> i        = <span class="number">0</span>,
              children = el._childNodes,
              l        = children.length;

          <span class="keyword">for</span> (i; i&lt;l; i++) {
            visit(children[i]);
          }
        }
      }
    }
    visit(root);
  },

  markTreeReadonly: <span class="keyword">function</span>(node) {
    <span class="function"><span class="keyword">function</span> <span class="title">markLevel</span><span class="params">(el)</span> {</span>
      el._readonly = <span class="literal">true</span>;
      <span class="comment">// also mark attributes and their children read-only</span>
      <span class="keyword">if</span> (el.attributes) {
        <span class="keyword">var</span> attributes = el.attributes, l = attributes.length, i=<span class="number">0</span>;
        attributes._readonly = <span class="literal">true</span>;

        <span class="keyword">for</span> (i; i&lt;l; i++) {
          core.visitTree(attributes[i], markLevel);
        }
      }
    }

    core.visitTree(node, markLevel);
  }
};

<span class="comment">// ExceptionCode</span>
<span class="keyword">var</span> INDEX_SIZE_ERR              = core.INDEX_SIZE_ERR              = <span class="number">1</span>,
    DOMSTRING_SIZE_ERR          = core.DOMSTRING_SIZE_ERR          = <span class="number">2</span>,
    HIERARCHY_REQUEST_ERR       = core.HIERARCHY_REQUEST_ERR       = <span class="number">3</span>,
    WRONG_DOCUMENT_ERR          = core.WRONG_DOCUMENT_ERR          = <span class="number">4</span>,
    INVALID_CHARACTER_ERR       = core.INVALID_CHARACTER_ERR       = <span class="number">5</span>,
    NO_DATA_ALLOWED_ERR         = core.NO_DATA_ALLOWED_ERR         = <span class="number">6</span>,
    NO_MODIFICATION_ALLOWED_ERR = core.NO_MODIFICATION_ALLOWED_ERR = <span class="number">7</span>,
    NOT_FOUND_ERR               = core.NOT_FOUND_ERR               = <span class="number">8</span>,
    NOT_SUPPORTED_ERR           = core.NOT_SUPPORTED_ERR           = <span class="number">9</span>,
    INUSE_ATTRIBUTE_ERR         = core.INUSE_ATTRIBUTE_ERR         = <span class="number">10</span>,

<span class="comment">// Node Types</span>
    ELEMENT_NODE                = <span class="number">1</span>,
    ATTRIBUTE_NODE              = <span class="number">2</span>,
    TEXT_NODE                   = <span class="number">3</span>,
    CDATA_SECTION_NODE          = <span class="number">4</span>,
    ENTITY_REFERENCE_NODE       = <span class="number">5</span>,
    ENTITY_NODE                 = <span class="number">6</span>,
    PROCESSING_INSTRUCTION_NODE = <span class="number">7</span>,
    COMMENT_NODE                = <span class="number">8</span>,
    DOCUMENT_NODE               = <span class="number">9</span>,
    DOCUMENT_TYPE_NODE          = <span class="number">10</span>,
    DOCUMENT_FRAGMENT_NODE      = <span class="number">11</span>,
    NOTATION_NODE               = <span class="number">12</span>;

<span class="keyword">var</span> messages = core.exceptionMessages = { };
messages[INDEX_SIZE_ERR]              = <span class="string">"Index size error"</span>;
messages[DOMSTRING_SIZE_ERR]          = <span class="string">"DOMString size error"</span>;
messages[HIERARCHY_REQUEST_ERR]       = <span class="string">"Hierarchy request error"</span>;
messages[WRONG_DOCUMENT_ERR]          = <span class="string">"Wrong document"</span>;
messages[INVALID_CHARACTER_ERR]       = <span class="string">"Invalid character"</span>;
messages[NO_DATA_ALLOWED_ERR]         = <span class="string">"No data allowed"</span>;
messages[NO_MODIFICATION_ALLOWED_ERR] = <span class="string">"No modification allowed"</span>;
messages[NOT_FOUND_ERR]               = <span class="string">"Not found"</span>;
messages[NOT_SUPPORTED_ERR]           = <span class="string">"Not supported"</span>;
messages[INUSE_ATTRIBUTE_ERR]         = <span class="string">"Attribute in use"</span>;

core.DOMException = <span class="keyword">function</span>(code, message) {
  <span class="keyword">this</span>.code = code;
  Error.call(<span class="keyword">this</span>, core.exceptionMessages[code]);
  <span class="keyword">this</span>.message = core.exceptionMessages[code];
  <span class="keyword">if</span>(message) <span class="keyword">this</span>.message = <span class="keyword">this</span>.message + <span class="string">": "</span> + message;
  <span class="keyword">if</span>(Error.captureStackTrace) Error.captureStackTrace(<span class="keyword">this</span>, core.DOMException);
};

core.DOMException.INDEX_SIZE_ERR              = INDEX_SIZE_ERR;
core.DOMException.DOMSTRING_SIZE_ERR          = DOMSTRING_SIZE_ERR;
core.DOMException.HIERARCHY_REQUEST_ERR       = HIERARCHY_REQUEST_ERR;
core.DOMException.WRONG_DOCUMENT_ERR          = WRONG_DOCUMENT_ERR;
core.DOMException.INVALID_CHARACTER_ERR       = INVALID_CHARACTER_ERR;
core.DOMException.NO_DATA_ALLOWED_ERR         = NO_DATA_ALLOWED_ERR;
core.DOMException.NO_MODIFICATION_ALLOWED_ERR = NO_MODIFICATION_ALLOWED_ERR;
core.DOMException.NOT_FOUND_ERR               = NOT_FOUND_ERR;
core.DOMException.NOT_SUPPORTED_ERR           = NOT_SUPPORTED_ERR;
core.DOMException.INUSE_ATTRIBUTE_ERR         = INUSE_ATTRIBUTE_ERR;

core.DOMException.prototype = {
  INDEX_SIZE_ERR              : INDEX_SIZE_ERR,
  DOMSTRING_SIZE_ERR          : DOMSTRING_SIZE_ERR,
  HIERARCHY_REQUEST_ERR       : HIERARCHY_REQUEST_ERR,
  WRONG_DOCUMENT_ERR          : WRONG_DOCUMENT_ERR,
  INVALID_CHARACTER_ERR       : INVALID_CHARACTER_ERR,
  NO_DATA_ALLOWED_ERR         : NO_DATA_ALLOWED_ERR,
  NO_MODIFICATION_ALLOWED_ERR : NO_MODIFICATION_ALLOWED_ERR,
  NOT_FOUND_ERR               : NOT_FOUND_ERR,
  NOT_SUPPORTED_ERR           : NOT_SUPPORTED_ERR,
  INUSE_ATTRIBUTE_ERR         : INUSE_ATTRIBUTE_ERR
};

core.DOMException.prototype.__proto__ = Error.prototype;

<span class="keyword">var</span> NodeArray = <span class="keyword">function</span>() {};
NodeArray.prototype = <span class="keyword">new</span> Array();
NodeArray.prototype.item = <span class="keyword">function</span>(i) {
  <span class="keyword">return</span> <span class="keyword">this</span>[i];
};

core.NodeList = <span class="function"><span class="keyword">function</span> <span class="title">NodeList</span><span class="params">(element, query)</span> {</span>
  <span class="keyword">if</span> (!query) {
    <span class="comment">// Non-live NodeList</span>
    <span class="keyword">var</span> list = <span class="keyword">new</span> NodeArray();
    <span class="keyword">if</span> (Array.isArray(element)) {
      Array.prototype.push.apply(list, element);
    }

    <span class="keyword">return</span> list;
  }
  Object.defineProperties(<span class="keyword">this</span>, {
    _element: {value: element},
    _query: {value: query},
    _snapshot: {writable: <span class="literal">true</span>},
    _length: {value: <span class="number">0</span>, writable: <span class="literal">true</span>},
    _version: {value: -<span class="number">1</span>, writable: <span class="literal">true</span>}
  });
  <span class="keyword">this</span>.update();
};
core.NodeList.prototype = {
  update: <span class="keyword">function</span>() {
    <span class="keyword">var</span> i;
    <span class="keyword">if</span> (<span class="keyword">this</span>._element &amp;&amp; <span class="keyword">this</span>._version &lt; <span class="keyword">this</span>._element._version) {
      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>._length; i++) {
        <span class="keyword">this</span>[i] = <span class="literal">undefined</span>;
      }
      <span class="keyword">var</span> nodes = <span class="keyword">this</span>._snapshot = <span class="keyword">this</span>._query();
      <span class="keyword">this</span>._length = nodes.length;
      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nodes.length; i++) {
        <span class="keyword">this</span>[i] = nodes[i];
      }
      <span class="keyword">this</span>._version = <span class="keyword">this</span>._element._version;
    }
    <span class="keyword">return</span> <span class="keyword">this</span>._snapshot;
  },
  toArray: <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="keyword">this</span>.update() || [];
  },
  get length() {
    <span class="keyword">this</span>.update();
    <span class="keyword">return</span> <span class="keyword">this</span>._length || <span class="number">0</span>;
  },
  item: <span class="keyword">function</span>(index) {
    <span class="keyword">this</span>.update();
    <span class="keyword">return</span> <span class="keyword">this</span>[index] || <span class="literal">null</span>;
  },
  toString: <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="string">'[ jsdom NodeList ]: contains '</span> + <span class="keyword">this</span>.length + <span class="string">' items'</span>;
  },
  indexOf: <span class="keyword">function</span>(node) {
    <span class="keyword">var</span> len = <span class="keyword">this</span>.update().length;

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) {
      <span class="keyword">if</span> (<span class="keyword">this</span>[i] == node) {
        <span class="keyword">return</span> i;
      }
    }

    <span class="keyword">return</span> -<span class="number">1</span>; <span class="comment">// not found</span>
  }
};

core.DOMImplementation = <span class="function"><span class="keyword">function</span> <span class="title">DOMImplementation</span><span class="params">(document, <span class="comment">/* Object */</span> features)</span> {</span>
  <span class="keyword">this</span>._ownerDocument = document;
  <span class="keyword">this</span>._features = {};

  <span class="keyword">if</span> (features) {
    <span class="keyword">for</span> (<span class="keyword">var</span> feature <span class="keyword">in</span> features) {
      <span class="keyword">if</span> (features.hasOwnProperty(feature)) {
        <span class="keyword">this</span>.addFeature(feature.toLowerCase(), features[feature]);
      }
    }
  }
};

core.DOMImplementation.prototype = {
  get ownerDocument() { <span class="keyword">return</span> <span class="keyword">this</span>._ownerDocument },
  removeFeature : <span class="keyword">function</span>(feature, version) {
    feature = feature.toLowerCase();
    <span class="keyword">if</span> (<span class="keyword">this</span>._features[feature]) {
      <span class="keyword">if</span> (version) {
        <span class="keyword">var</span> j        = <span class="number">0</span>,
            versions = <span class="keyword">this</span>._features[feature],
            l        = versions.length;

        <span class="keyword">for</span> (j; j&lt;l; j++) {
          <span class="keyword">if</span> (versions[j] === version) {
            versions.splice(j,<span class="number">1</span>);
            <span class="keyword">return</span>;
          }
        }
      } <span class="keyword">else</span> {
        <span class="keyword">delete</span> <span class="keyword">this</span>._features[feature];
      }
    }
  },

  addFeature: <span class="keyword">function</span>(feature, version) {
    feature = feature.toLowerCase();

    <span class="keyword">if</span> (version) {

      <span class="keyword">if</span> (!<span class="keyword">this</span>._features[feature]) {
        <span class="keyword">this</span>._features[feature] = [];
      }

      <span class="keyword">if</span> (version <span class="keyword">instanceof</span> Array) {
        Array.prototype.push.apply(<span class="keyword">this</span>._features[feature], version);
      } <span class="keyword">else</span> {
        <span class="keyword">this</span>._features[feature].push(version);
      }
    }
  },

  hasFeature: <span class="keyword">function</span>(<span class="comment">/* string */</span> feature, <span class="comment">/* string */</span> version) {
    feature = (feature) ? feature.toLowerCase() : <span class="string">''</span>;
    <span class="keyword">var</span> versions = (<span class="keyword">this</span>._features[feature]) ?
                    <span class="keyword">this</span>._features[feature]  :
                    <span class="literal">false</span>;

    <span class="keyword">if</span> (!version &amp;&amp; versions.length &amp;&amp; versions.length > <span class="number">0</span>) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> versions === <span class="string">'string'</span>) {
      <span class="keyword">return</span> versions === version;
    } <span class="keyword">else</span> <span class="keyword">if</span> (versions.indexOf &amp;&amp; versions.length > <span class="number">0</span>) {
       <span class="keyword">return</span> versions.indexOf(version) !== -<span class="number">1</span>;
    } <span class="keyword">else</span> {
      <span class="keyword">return</span> <span class="literal">false</span>;
    }
  }
};


<span class="keyword">var</span> attrCopy = <span class="keyword">function</span>(src, dest, fn) {
  <span class="keyword">if</span> (src.attributes) {
    <span class="keyword">var</span> attrs = src.attributes, i, l = attrs.length, attr, copied;
    <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;l;i++) {
      attr = attrs[i];
      <span class="comment">// skip over default attributes</span>
      <span class="keyword">if</span> (!attr.specified) {
        <span class="keyword">continue</span>;
      }
      <span class="comment">// TODO: consider duplicating this code and moving it into level2/core</span>
      <span class="keyword">if</span> (attr.namespaceURI) {
        dest.setAttributeNS(attr.namespaceURI,
                                     attr.nodeName,
                                     attr.nodeValue);
        <span class="keyword">var</span> localName = attr.nodeName.split(<span class="string">':'</span>).pop();
        copied = dest.getAttributeNodeNS(attr.namespaceURI, localName);
      } <span class="keyword">else</span> {
        dest.setAttribute(attr.nodeName, attr.nodeValue);
        copied = dest.getAttributeNode(attr.nodeName);
      }
      <span class="keyword">if</span> (<span class="keyword">typeof</span> fn == <span class="string">"function"</span>) {
        fn(attr, copied);
      }

    }
  }
  <span class="keyword">return</span> dest;
};

core.Node = <span class="function"><span class="keyword">function</span> <span class="title">Node</span><span class="params">(ownerDocument)</span> {</span>
  <span class="keyword">this</span>._childNodes = <span class="keyword">new</span> core.NodeList();
  <span class="keyword">this</span>._ownerDocument = ownerDocument;
  <span class="keyword">this</span>._attributes = <span class="keyword">new</span> core.AttrNodeMap(ownerDocument, <span class="keyword">this</span>);
  <span class="keyword">this</span>._nodeName = <span class="literal">null</span>;
  <span class="keyword">this</span>._childrenList = <span class="literal">null</span>;
  <span class="keyword">this</span>._version = <span class="number">0</span>;
  <span class="keyword">this</span>._nodeValue = <span class="literal">null</span>;
  <span class="keyword">this</span>._parentNode = <span class="literal">null</span>;
  <span class="keyword">this</span>._nodeName = <span class="literal">null</span>;
  <span class="keyword">this</span>._readonly = <span class="literal">false</span>;
};

core.Node.ELEMENT_NODE                = ELEMENT_NODE;
core.Node.ATTRIBUTE_NODE              = ATTRIBUTE_NODE;
core.Node.TEXT_NODE                   = TEXT_NODE;
core.Node.CDATA_SECTION_NODE          = CDATA_SECTION_NODE;
core.Node.ENTITY_REFERENCE_NODE       = ENTITY_REFERENCE_NODE;
core.Node.ENTITY_NODE                 = ENTITY_NODE;
core.Node.PROCESSING_INSTRUCTION_NODE = PROCESSING_INSTRUCTION_NODE;
core.Node.COMMENT_NODE                = COMMENT_NODE;
core.Node.DOCUMENT_NODE               = DOCUMENT_NODE;
core.Node.DOCUMENT_TYPE_NODE          = DOCUMENT_TYPE_NODE;
core.Node.DOCUMENT_FRAGMENT_NODE      = DOCUMENT_FRAGMENT_NODE;
core.Node.NOTATION_NODE               = NOTATION_NODE;

core.Node.prototype = {
  ELEMENT_NODE                : ELEMENT_NODE,
  ATTRIBUTE_NODE              : ATTRIBUTE_NODE,
  TEXT_NODE                   : TEXT_NODE,
  CDATA_SECTION_NODE          : CDATA_SECTION_NODE,
  ENTITY_REFERENCE_NODE       : ENTITY_REFERENCE_NODE,
  ENTITY_NODE                 : ENTITY_NODE,
  PROCESSING_INSTRUCTION_NODE : PROCESSING_INSTRUCTION_NODE,
  COMMENT_NODE                : COMMENT_NODE,
  DOCUMENT_NODE               : DOCUMENT_NODE,
  DOCUMENT_TYPE_NODE          : DOCUMENT_TYPE_NODE,
  DOCUMENT_FRAGMENT_NODE      : DOCUMENT_FRAGMENT_NODE,
  NOTATION_NODE               : NOTATION_NODE,

  get children() {
    <span class="keyword">if</span> (!<span class="keyword">this</span>._childrenList) {
      <span class="keyword">var</span> self = <span class="keyword">this</span>;
      <span class="keyword">this</span>._childrenList = <span class="keyword">new</span> core.NodeList(<span class="keyword">this</span>, <span class="keyword">function</span>() {
        <span class="keyword">return</span> self._childNodes.filter(<span class="keyword">function</span>(node) {
          <span class="keyword">return</span> node.tagName;
        });
      });
    }
    <span class="keyword">return</span> <span class="keyword">this</span>._childrenList;
  },
  get nodeValue() {
    <span class="keyword">return</span> <span class="keyword">this</span>._nodeValue;
  },
  set nodeValue(value) {
    <span class="comment">// readonly</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>._readonly === <span class="literal">true</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR, <span class="string">'Attempting to modify a read-only node'</span>);
    }

    <span class="keyword">this</span>._nodeValue = value;
  },
  get parentNode() { <span class="keyword">return</span> <span class="keyword">this</span>._parentNode;},

  get nodeName() {
    <span class="keyword">var</span> name = <span class="keyword">this</span>._nodeName || <span class="keyword">this</span>._tagName;
    <span class="keyword">if</span> (<span class="keyword">this</span>.nodeType === ELEMENT_NODE &amp;&amp;
        <span class="keyword">this</span>._ownerDocument                  &amp;&amp;
        <span class="keyword">this</span>._ownerDocument._doctype          &amp;&amp;
        <span class="keyword">this</span>._ownerDocument._doctype.name.toLowerCase().indexOf(<span class="string">"html"</span>) !== -<span class="number">1</span>)
    {
      <span class="keyword">return</span> name.toUpperCase();
    }
    <span class="keyword">return</span> name;
  },
  set nodeName() { <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException();},
  get attributes() { <span class="keyword">return</span> <span class="keyword">this</span>._attributes;},
  get firstChild() {
    <span class="keyword">return</span> <span class="keyword">this</span>._childNodes.length > <span class="number">0</span> ? <span class="keyword">this</span>._childNodes[<span class="number">0</span>] : <span class="literal">null</span>;
  },
  set firstChild() { <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException();},
  get ownerDocument() { <span class="keyword">return</span> <span class="keyword">this</span>._ownerDocument;},
  get readonly() { <span class="keyword">return</span> <span class="keyword">this</span>._readonly;},

  get lastChild() {
    <span class="keyword">var</span> len = <span class="keyword">this</span>._childNodes.length;
    <span class="keyword">return</span> len > <span class="number">0</span> ? <span class="keyword">this</span>._childNodes[len -<span class="number">1</span>] : <span class="literal">null</span>;
  },
  set lastChild() { <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException();},

  get childNodes() {
    <span class="keyword">return</span> <span class="keyword">this</span>._childNodes;
  },
  set childNodes() { <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException();},

  _indexOf: <span class="keyword">function</span>(<span class="comment">/*Node*/</span> child) {
    <span class="keyword">if</span> (!<span class="keyword">this</span>._childNodes ||
	!<span class="keyword">this</span>._childNodes.length) {
      <span class="keyword">return</span> -<span class="number">1</span>;
    }

    <span class="keyword">var</span> currentNode, index = <span class="number">0</span>, children = <span class="keyword">this</span>._childNodes;

    <span class="keyword">while</span> ((currentNode = children[index])) {
      <span class="keyword">if</span> (currentNode == child) {
        <span class="keyword">break</span>;
      }
      index++;
    }

    <span class="keyword">if</span> (currentNode == child) {
      <span class="keyword">return</span> index;
    }
    <span class="keyword">return</span> -<span class="number">1</span>;
  },

  get nextSibling() {
    <span class="comment">// find this node's index in the parentNode, add one and call it a day</span>
    <span class="keyword">if</span> (!<span class="keyword">this</span>._parentNode || !<span class="keyword">this</span>._parentNode._indexOf) {
      <span class="keyword">return</span> <span class="literal">null</span>;
    }

    <span class="keyword">var</span> index = <span class="keyword">this</span>._parentNode._indexOf(<span class="keyword">this</span>);

    <span class="keyword">if</span> (index == -<span class="number">1</span> || index+<span class="number">1</span> >= <span class="keyword">this</span>._parentNode._childNodes.length) {
      <span class="keyword">return</span> <span class="literal">null</span>;
    }

    <span class="keyword">return</span> <span class="keyword">this</span>._parentNode._childNodes[index+<span class="number">1</span>] || <span class="literal">null</span>;
  },
  set nextSibling() { <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException();},

  get previousSibling() {
    <span class="keyword">if</span> (!<span class="keyword">this</span>._parentNode || !<span class="keyword">this</span>._parentNode._indexOf) {
      <span class="keyword">return</span> <span class="literal">null</span>;
    }

    <span class="keyword">var</span> index = <span class="keyword">this</span>._parentNode._indexOf(<span class="keyword">this</span>);

    <span class="keyword">if</span> (index == -<span class="number">1</span> || index-<span class="number">1</span> &lt; <span class="number">0</span>) {
      <span class="keyword">return</span> <span class="literal">null</span>;
    }

    <span class="keyword">return</span> <span class="keyword">this</span>._parentNode._childNodes[index-<span class="number">1</span>] || <span class="literal">null</span>;
  },
  set previousSibling() { <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException();},

  <span class="comment">/* returns Node */</span>
  insertBefore :  <span class="keyword">function</span>(<span class="comment">/* Node */</span> newChild, <span class="comment">/* Node*/</span> refChild) {
    <span class="keyword">if</span> (<span class="keyword">this</span>._readonly === <span class="literal">true</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR, <span class="string">'Attempting to modify a read-only node'</span>);
    }

    <span class="comment">// Adopt unowned children, for weird nodes like DocumentType</span>
    <span class="keyword">if</span> (!newChild._ownerDocument) newChild._ownerDocument = <span class="keyword">this</span>._ownerDocument;

    <span class="comment">// TODO - if (!newChild) then?</span>
    <span class="keyword">if</span> (newChild._ownerDocument !== <span class="keyword">this</span>._ownerDocument) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(WRONG_DOCUMENT_ERR);
    }

    <span class="keyword">if</span> (newChild.nodeType &amp;&amp; newChild.nodeType === ATTRIBUTE_NODE) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(HIERARCHY_REQUEST_ERR);
    }

    <span class="comment">// search for parents matching the newChild</span>
    <span class="keyword">var</span> current = <span class="keyword">this</span>;
    <span class="keyword">do</span> {
      <span class="keyword">if</span> (current === newChild) {
        <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(HIERARCHY_REQUEST_ERR);
      }
    } <span class="keyword">while</span>((current = current._parentNode));

    <span class="comment">// fragments are merged into the element</span>
    <span class="keyword">if</span> (newChild.nodeType === DOCUMENT_FRAGMENT_NODE) {
      <span class="keyword">var</span> tmpNode;
      <span class="keyword">while</span> (newChild._childNodes.length > <span class="number">0</span>) {
        tmpNode = newChild.removeChild(newChild.firstChild);
        <span class="keyword">this</span>.insertBefore(tmpNode, refChild);
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (newChild === refChild) {
      <span class="keyword">return</span> newChild;
    } <span class="keyword">else</span> {
      <span class="comment">// if the newChild is already in the tree elsewhere, remove it first</span>
      <span class="keyword">if</span> (newChild._parentNode) {
        newChild._parentNode.removeChild(newChild);
      }

      <span class="keyword">if</span> (refChild == <span class="literal">null</span>) {
        <span class="keyword">var</span> refChildIndex = <span class="keyword">this</span>._childNodes.length;
      } <span class="keyword">else</span> {
        <span class="keyword">var</span> refChildIndex = <span class="keyword">this</span>._indexOf(refChild);
        <span class="keyword">if</span> (refChildIndex == -<span class="number">1</span>) {
          <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NOT_FOUND_ERR);
        }
      }

      <span class="keyword">this</span>._childNodes.splice(refChildIndex, <span class="number">0</span>, newChild);
      newChild._parentNode = <span class="keyword">this</span>;
      <span class="keyword">if</span> (<span class="keyword">this</span>._attached &amp;&amp; newChild._attach) {
        newChild._attach();
      }

      <span class="keyword">this</span>._modified();
    }

    <span class="keyword">return</span> newChild;
  }, <span class="comment">// raises(DOMException);</span>

  _modified: <span class="keyword">function</span>() {
    <span class="keyword">this</span>._version++;
    <span class="keyword">if</span> (<span class="keyword">this</span>._ownerDocument) {
      <span class="keyword">this</span>._ownerDocument._version++;
    }

    <span class="keyword">if</span> (<span class="keyword">this</span>._childrenList) <span class="keyword">this</span>._childrenList.update();
    <span class="comment">//this._childNodesList.update();</span>
  },

  _attrModified: <span class="keyword">function</span>(name, value, oldValue) {
    <span class="keyword">if</span> (name == <span class="string">'id'</span> &amp;&amp; <span class="keyword">this</span>._attached) {
      <span class="keyword">var</span> doc = <span class="keyword">this</span>._ownerDocument;
      detachId(oldValue,<span class="keyword">this</span>,doc);
      attachId(value,<span class="keyword">this</span>,doc);
    }
  },

  <span class="comment">/* returns Node */</span>
  replaceChild : <span class="keyword">function</span>(<span class="comment">/* Node */</span> newChild, <span class="comment">/* Node */</span> oldChild){
    <span class="keyword">this</span>.insertBefore(newChild, oldChild);
    <span class="keyword">return</span> <span class="keyword">this</span>.removeChild(oldChild);
  }, <span class="comment">//raises(DOMException);</span>

  <span class="comment">/* returns void */</span>
  _attach : <span class="keyword">function</span>() {
    <span class="keyword">this</span>._attached = <span class="literal">true</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.id) {
      attachId(<span class="keyword">this</span>.id,<span class="keyword">this</span>,<span class="keyword">this</span>._ownerDocument);
    }
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="keyword">this</span>._childNodes.length;i++) {
      <span class="keyword">if</span> (<span class="keyword">this</span>._childNodes[i]._attach) {
        <span class="keyword">this</span>._childNodes[i]._attach();
      }
    }
  },
  <span class="comment">/* returns void */</span>
  _detach : <span class="keyword">function</span>() {
    <span class="keyword">var</span> i, elms;
    <span class="keyword">this</span>._attached = <span class="literal">false</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.id) {
      detachId(<span class="keyword">this</span>.id,<span class="keyword">this</span>,<span class="keyword">this</span>._ownerDocument);
    }
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="keyword">this</span>._childNodes.length;i++) {
      <span class="keyword">this</span>._childNodes[i]._detach();
    }
  },

  <span class="comment">/* returns Node */</span>
  removeChild : <span class="keyword">function</span>(<span class="comment">/* Node */</span> oldChild){
    <span class="keyword">if</span> (<span class="keyword">this</span>._readonly === <span class="literal">true</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR);
    }

    <span class="comment">// TODO - if (!oldChild) then?</span>
    <span class="keyword">var</span> oldChildIndex = <span class="keyword">this</span>._indexOf(oldChild);
    <span class="keyword">if</span> (oldChildIndex == -<span class="number">1</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NOT_FOUND_ERR);
    }

    <span class="keyword">this</span>._childNodes.splice(oldChildIndex, <span class="number">1</span>);
    oldChild._parentNode = <span class="literal">null</span>;
    <span class="keyword">this</span>._modified();
    oldChild._detach();
    <span class="keyword">return</span> oldChild;
  }, <span class="comment">// raises(DOMException);</span>

  <span class="comment">/* returns Node */</span>
  appendChild : <span class="keyword">function</span>(<span class="comment">/* Node */</span> newChild) {
    <span class="keyword">return</span> <span class="keyword">this</span>.insertBefore(newChild, <span class="literal">null</span>);
  }, <span class="comment">// raises(DOMException);</span>

  <span class="comment">/* returns boolean */</span>
  hasChildNodes : <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="keyword">this</span>._childNodes.length > <span class="number">0</span>;
  },

  <span class="comment">/* returns Node */</span>
  cloneNode : <span class="keyword">function</span>(<span class="comment">/* bool */</span> deep, fn) {

    <span class="keyword">var</span> object = <span class="literal">null</span>;
    <span class="keyword">switch</span> (<span class="keyword">this</span>.nodeType) {

      <span class="keyword">case</span> <span class="keyword">this</span>.ELEMENT_NODE:
        object = attrCopy(<span class="keyword">this</span>,<span class="keyword">this</span>._ownerDocument.createElement(<span class="keyword">this</span>.tagName), fn);
      <span class="keyword">break</span>;

      <span class="keyword">case</span> <span class="keyword">this</span>.TEXT_NODE:
        object = attrCopy(<span class="keyword">this</span>,<span class="keyword">this</span>._ownerDocument.createTextNode(<span class="keyword">this</span>.tagName));
        object.nodeValue = <span class="keyword">this</span>.nodeValue;
      <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="keyword">this</span>.CDATA_SECTION_NODE:
        object = <span class="keyword">this</span>._ownerDocument.createCDATASection(<span class="keyword">this</span>.tagName);
        object.nodeValue = <span class="keyword">this</span>.nodeValue;
      <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="keyword">this</span>.ENTITY_REFERENCE_NODE:
        <span class="keyword">var</span> name = (<span class="keyword">this</span>._entity) ? <span class="keyword">this</span>._entity.name : <span class="keyword">this</span>._entityName,
            ref  = <span class="keyword">this</span>._ownerDocument.createEntityReference(name);

        object = attrCopy(<span class="keyword">this</span>, ref);
        object.nodeValue = <span class="keyword">this</span>.nodeValue;
      <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="keyword">this</span>.ATTRIBUTE_NODE:
        object = <span class="keyword">this</span>._ownerDocument.createAttribute(<span class="keyword">this</span>.name);
      <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="keyword">this</span>.ENTITY_NODE:
        <span class="keyword">var</span> entity = <span class="keyword">this</span>._ownerDocument.createEntityNode(<span class="keyword">this</span>.name);
        object = attrCopy(<span class="keyword">this</span>, entity);
        object.nodeValue = <span class="keyword">this</span>.nodeValue;
        object._publicId = <span class="keyword">this</span>._publicId;
        object._systemId = <span class="keyword">this</span>._systemId;
        object._notationName = <span class="keyword">this</span>.notationName;
      <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="keyword">this</span>.PROCESSING_INSTRUCTION_NODE:
        <span class="keyword">var</span> pi = <span class="keyword">this</span>._ownerDocument.createProcessingInstruction(<span class="keyword">this</span>._target,
                                                                <span class="keyword">this</span>._data);
        object = attrCopy(<span class="keyword">this</span>, pi);
        object.nodeValue = <span class="keyword">this</span>.nodeValue;
      <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="keyword">this</span>.COMMENT_NODE:
        object = <span class="keyword">this</span>._ownerDocument.createComment(<span class="keyword">this</span>.tagName);
        object.nodeValue = <span class="keyword">this</span>.nodeValue;
      <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="keyword">this</span>.DOCUMENT_NODE:
        object = attrCopy(<span class="keyword">this</span>, <span class="keyword">new</span> core.Document());
        <span class="comment">// TODO: clone the doctype/entities/notations/etc?</span>
      <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="keyword">this</span>.DOCUMENT_TYPE_NODE:
        object = attrCopy(<span class="keyword">this</span>, <span class="keyword">new</span> core.DocumentType());
        object.nodeValue = <span class="keyword">this</span>.nodeValue;
      <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="keyword">this</span>.DOCUMENT_FRAGMENT_NODE:
        object = <span class="keyword">this</span>._ownerDocument.createDocumentFragment();
      <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="keyword">this</span>.NOTATION_NODE:
        object = <span class="keyword">this</span>._ownerDocument.createNotationNode(<span class="keyword">this</span>._name,
                                                       <span class="keyword">this</span>._publicId,
                                                       <span class="keyword">this</span>._systemId);
        object = attrCopy(<span class="keyword">this</span>,object);
        object.nodeValue = <span class="keyword">this</span>.nodeValue;
      <span class="keyword">break</span>;
      <span class="keyword">default</span>:
        <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NOT_FOUND_ERR);
      <span class="keyword">break</span>;
    }

    <span class="keyword">if</span> (<span class="keyword">typeof</span> fn === <span class="string">"function"</span>) {
      fn(<span class="keyword">this</span>, object);
    }

    <span class="keyword">if</span> (deep || <span class="keyword">this</span>.nodeType === ATTRIBUTE_NODE) {
      <span class="keyword">var</span> clone = <span class="literal">null</span>;
      <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>,len=<span class="keyword">this</span>._childNodes.length;i&lt;len;i++)
      {
        clone = <span class="keyword">this</span>._childNodes[i].cloneNode(<span class="literal">true</span>);
        <span class="keyword">if</span> (clone.nodeType === ATTRIBUTE_NODE) {
          object.setAttributeNode(clone);
        } <span class="keyword">else</span> {
          <span class="keyword">var</span> readonly = object._readonly;
          object._readonly = <span class="literal">false</span>;
          object.appendChild(clone);
          object._readonly = readonly;
        }
      }
    }

    <span class="keyword">return</span> object;
  },

  <span class="comment">/* returns void */</span>
  normalize: <span class="keyword">function</span>() {
    <span class="keyword">var</span> prevChild, child, attr,i;

    <span class="keyword">if</span> (<span class="keyword">this</span>._attributes &amp;&amp; <span class="keyword">this</span>._attributes.length) {
      <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="keyword">this</span>._attributes.length;i++)
      {
        <span class="keyword">if</span> (<span class="keyword">this</span>._attributes.item(i)) {
          attr = <span class="keyword">this</span>._attributes.item(i).normalize();
        }
      }
    }

    <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="keyword">this</span>._childNodes.length;i++)
    {
      child = <span class="keyword">this</span>._childNodes[i];

      <span class="keyword">if</span> (child.normalize) {
        child.normalize();
      }

      <span class="comment">// Level2/core clean off empty nodes</span>
      <span class="keyword">if</span> (child.value === <span class="string">""</span>) {
        <span class="keyword">this</span>.removeChild(child);
        i--;
        <span class="keyword">continue</span>;
      }

      <span class="keyword">if</span> (i><span class="number">0</span>) {
        prevChild = <span class="keyword">this</span>._childNodes[i-<span class="number">1</span>];

        <span class="keyword">if</span> (child.nodeType === TEXT_NODE &amp;&amp;
            prevChild.nodeType === TEXT_NODE)
        {

          <span class="comment">// remove the child and decrement i</span>
          prevChild.appendData(child.value);

          <span class="keyword">this</span>.removeChild(child);
          i--;
        }
      }
    }
  },
  toString: <span class="keyword">function</span>() {
    <span class="keyword">var</span> id = <span class="string">''</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.id) {
        id = <span class="string">'#'</span> + <span class="keyword">this</span>.id;
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>.className) {
        <span class="keyword">var</span> classes = <span class="keyword">this</span>.className.split(<span class="regexp">/\s+/</span>);
	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = classes.length; i &lt; len; i++) {
	    id += <span class="string">'.'</span> + classes[i];
	}
    }
    <span class="keyword">return</span> <span class="string">'[ '</span> + <span class="keyword">this</span>.tagName + id + <span class="string">' ]'</span>;
  },
  raise: <span class="keyword">function</span>(type, message, data) {
    <span class="keyword">var</span> text = type + <span class="string">": "</span> + message;

    <span class="keyword">if</span> (data) {
      <span class="keyword">if</span> (data.exception) {
        text = data.exception.stack;
      } <span class="keyword">else</span> {
        text += <span class="string">' - More:\n'</span> + data;
      }
    }

    <span class="keyword">if</span> (type === <span class="string">"error"</span>) {
      <span class="keyword">if</span> (!<span class="keyword">this</span>.errors) {
        <span class="keyword">this</span>.errors = [];
      }
      <span class="comment">// TODO: consider using actual `Error` objects or `DOMException`s even..</span>
      <span class="keyword">var</span> err = {
        type    : type,
        message : message || <span class="string">"No message"</span>,
        data    : data || <span class="literal">null</span>
      };

      <span class="keyword">this</span>.errors.push(err);

      <span class="keyword">if</span> (<span class="keyword">this</span>._ownerDocument        &amp;&amp;
          <span class="keyword">this</span>._ownerDocument.raise &amp;&amp;
          <span class="keyword">this</span> !== <span class="keyword">this</span>._ownerDocument)
      {
        <span class="keyword">this</span>._ownerDocument.raise(type, message, data);
      }
    }
  }
};


core.NamedNodeMap = <span class="function"><span class="keyword">function</span> <span class="title">NamedNodeMap</span><span class="params">(document)</span> {</span>
  <span class="keyword">this</span>._nodes = {};
  <span class="keyword">this</span>._nsStore = {};
  <span class="keyword">this</span>.length = <span class="number">0</span>;
  <span class="keyword">this</span>._ownerDocument = document;
  <span class="keyword">this</span>._readonly = <span class="literal">false</span>;
};
core.NamedNodeMap.prototype = {
  get readonly() { <span class="keyword">return</span> <span class="keyword">this</span>._readonly;},
  get ownerDocument() { <span class="keyword">this</span>._ownerDocument;},

  exists : <span class="keyword">function</span>(name) {
    <span class="keyword">return</span> (<span class="keyword">this</span>._nodes[name] || <span class="keyword">this</span>._nodes[name] === <span class="literal">null</span>) ? <span class="literal">true</span> : <span class="literal">false</span>;
  },

  <span class="comment">/* returns Node */</span>
  getNamedItem: <span class="keyword">function</span>(<span class="comment">/* string */</span> name) {
    <span class="keyword">return</span> <span class="keyword">this</span>._nodes[name] || <span class="literal">null</span>;
  },

  <span class="comment">/* returns Node */</span>
  setNamedItem: <span class="keyword">function</span>(<span class="comment">/* Node */</span> arg) {

    <span class="comment">// readonly</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>._readonly === <span class="literal">true</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR);
    }

    <span class="comment">// arg is from a different document</span>
    <span class="keyword">if</span> (arg &amp;&amp; arg._ownerDocument !== <span class="keyword">this</span>._ownerDocument) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(WRONG_DOCUMENT_ERR);
    }

    <span class="comment">// if this argument is already in use..</span>
    <span class="keyword">if</span> (arg &amp;&amp; arg._ownerElement) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(INUSE_ATTRIBUTE_ERR);
    }

    <span class="keyword">var</span> name = arg.name;
    <span class="keyword">var</span> ret = <span class="keyword">this</span>._nodes[name];
    <span class="keyword">if</span> (!ret) {
      <span class="keyword">this</span>.length++;
      ret = <span class="literal">null</span>;
    }
    arg._specified = <span class="literal">true</span>;
    <span class="keyword">this</span>[name] = <span class="keyword">this</span>._nodes[name] = arg;
    <span class="keyword">return</span> ret;
  }, <span class="comment">// raises: function(DOMException) {},</span>

  <span class="comment">/* returns Node */</span>
  removeNamedItem: <span class="keyword">function</span>(<span class="comment">/* string */</span> name) {

    <span class="comment">// readonly</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>._readonly === <span class="literal">true</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR);
    }

    <span class="keyword">if</span> (!<span class="keyword">this</span>._nodes.hasOwnProperty(name)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NOT_FOUND_ERR);
    }

    <span class="keyword">var</span> prev = <span class="keyword">this</span>._nodes[name] || <span class="literal">null</span>;
    <span class="keyword">delete</span> <span class="keyword">this</span>._nodes[name];
    <span class="keyword">delete</span> <span class="keyword">this</span>[name];

    <span class="keyword">this</span>.length--;
    <span class="keyword">return</span> prev;
  }, <span class="comment">// raises: function(DOMException) {},</span>

  <span class="comment">/* returns Node */</span>
  item: <span class="keyword">function</span>(<span class="comment">/* int */</span> index) {
    <span class="keyword">var</span> current = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> member <span class="keyword">in</span> <span class="keyword">this</span>._nodes) {
      <span class="keyword">if</span> (<span class="keyword">this</span>._nodes.hasOwnProperty(member)) {
        <span class="keyword">if</span> (current === index &amp;&amp; <span class="keyword">this</span>._nodes[member]) {
          <span class="keyword">return</span> <span class="keyword">this</span>._nodes[member];
        }
        current++;
      }
    }
    <span class="keyword">return</span> <span class="literal">null</span>;
  }
};

core.AttrNodeMap = <span class="function"><span class="keyword">function</span> <span class="title">AttrNodeMap</span><span class="params">(document, parentNode)</span> {</span>
  core.NamedNodeMap.call(<span class="keyword">this</span>, document);
  <span class="keyword">this</span>._parentNode = parentNode;
};
core.AttrNodeMap.prototype = {
  get parentNode() { <span class="keyword">return</span> <span class="keyword">this</span>._parentNode;},

  <span class="comment">/* returns Node */</span>
  setNamedItem: <span class="keyword">function</span>(<span class="comment">/* Node */</span> arg) {
    <span class="keyword">var</span> prev = core.NamedNodeMap.prototype.setNamedItem.call(<span class="keyword">this</span>, arg);
    <span class="keyword">var</span> p = <span class="keyword">this</span>._parentNode;
    arg._ownerElement = p;
    p._attrModified(arg.name, arg.value, prev &amp;&amp; prev.value || <span class="literal">null</span>);
    p._modified();
    <span class="keyword">return</span> prev;
  },

  <span class="comment">/* returns Node */</span>
  removeNamedItem: <span class="keyword">function</span>(<span class="comment">/* string */</span> name) {
    <span class="keyword">var</span> prev = core.NamedNodeMap.prototype.removeNamedItem.call(<span class="keyword">this</span>, name);
    <span class="keyword">var</span> p = <span class="keyword">this</span>._parentNode;

    prev._ownerElement = <span class="literal">null</span>;
    p._attrModified(name);
    p._modified();

    <span class="keyword">var</span> doc = <span class="keyword">this</span>._ownerDocument;

    <span class="comment">// set default value if available</span>
    <span class="keyword">if</span> (doc &amp;&amp; doc._doctype &amp;&amp; doc._doctype.name.toLowerCase() !== <span class="string">"html"</span>) {
      <span class="keyword">var</span> defaultValue = <span class="literal">false</span>,
          elem         = doc._doctype._attributes
                                     .getNamedItem(<span class="keyword">this</span>._parentNode.nodeName);

      <span class="keyword">if</span> (elem) {
        <span class="keyword">var</span> defaultValue = elem.attributes.getNamedItem(name);

        <span class="keyword">if</span> (defaultValue) {
          <span class="keyword">var</span> attr = doc.createAttribute(name);
          attr.value = defaultValue.value;
          attr._specified = <span class="literal">false</span>;
          <span class="keyword">this</span>._nodes[name] = attr;
          <span class="keyword">this</span>.length++;
        }
      }
    }
    <span class="keyword">return</span> prev;
  }, <span class="comment">// raises: function(DOMException) {},</span>
};
core.AttrNodeMap.prototype.__proto__ = core.NamedNodeMap.prototype;

core.NotationNodeMap = <span class="function"><span class="keyword">function</span> <span class="title">NotationNodeMap</span><span class="params">(document)</span> {</span>
  core.NamedNodeMap.call(<span class="keyword">this</span>, document);
  <span class="keyword">this</span>._readonly = <span class="literal">false</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">1</span>;i&lt;arguments.length;i++) {
    <span class="keyword">this</span>.setNamedItem(arguments[i]);
  }
  <span class="keyword">this</span>._readonly = <span class="literal">true</span>;
};
core.NotationNodeMap.prototype = {};
core.NotationNodeMap.prototype.__proto__ = core.NamedNodeMap.prototype;

core.EntityNodeMap = <span class="function"><span class="keyword">function</span> <span class="title">EntityNodeMap</span><span class="params">(document)</span> {</span>
  core.NamedNodeMap.call(<span class="keyword">this</span>,document);
  <span class="keyword">this</span>._readonly = <span class="literal">false</span>;
  <span class="keyword">var</span> i = <span class="number">1</span>, l = arguments.length;

  <span class="keyword">for</span> (i=<span class="number">1</span>; i&lt;l; i++) {
    <span class="keyword">this</span>.setNamedItem(arguments[i]);
  }
  core.markTreeReadonly(<span class="keyword">this</span>);
};
core.EntityNodeMap.prototype = {};
core.EntityNodeMap.prototype.__proto__ = core.NamedNodeMap.prototype;


core.Element = <span class="function"><span class="keyword">function</span> <span class="title">Element</span><span class="params">(document, tagName)</span> {</span>
  <span class="keyword">this</span>._ownerDocument = document;
  core.Node.call(<span class="keyword">this</span>, document);
  <span class="keyword">this</span>._nodeName = tagName;
  <span class="keyword">this</span>._tagName = tagName;
};

core.Element.prototype = {

  get nodeValue() { <span class="keyword">return</span> <span class="literal">null</span>;},
  set nodeValue(value) { <span class="comment">/* do nothing */</span> },
  get tagName() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.nodeType === ELEMENT_NODE &amp;&amp;
        <span class="keyword">this</span>._ownerDocument                  &amp;&amp;
        <span class="keyword">this</span>._ownerDocument._doctype          &amp;&amp;
        <span class="keyword">this</span>._ownerDocument._doctype.name.toLowerCase().indexOf(<span class="string">"html"</span>) !== -<span class="number">1</span>)
    {
      <span class="keyword">return</span> <span class="keyword">this</span>.nodeName.toUpperCase();
    }
    <span class="keyword">return</span> <span class="keyword">this</span>.nodeName;
  },
  nodeType : ELEMENT_NODE,
  get attributes() {
    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="keyword">this</span>._attributes.length; i++) {
      <span class="keyword">this</span>._attributes[i] = <span class="keyword">this</span>._attributes.item(i);
    }
    <span class="keyword">return</span> <span class="keyword">this</span>._attributes;
  },

  get name() { <span class="keyword">return</span> <span class="keyword">this</span>.nodeName;},
  <span class="comment">/* returns string */</span>
  getAttribute: <span class="keyword">function</span>(<span class="comment">/* string */</span> name) {
    <span class="keyword">var</span> attribute = <span class="keyword">this</span>._attributes.getNamedItem(name);
    <span class="keyword">if</span> (attribute) {
      <span class="keyword">return</span> attribute.value;
    }
    <span class="keyword">return</span> <span class="string">""</span>;
  },

  <span class="comment">/* returns string */</span>
  setAttribute: <span class="keyword">function</span>(<span class="comment">/* string */</span> name, <span class="comment">/* string */</span> value) {
    <span class="comment">// Check for inline event handlers.</span>
    <span class="comment">// We can't set these like other attributes then look it up in</span>
    <span class="comment">// dispatchEvent() because that would create 2 'traditional' event handlers</span>
    <span class="comment">// in the case where there's an inline event handler attribute, plus one</span>
    <span class="comment">// set using element.on* in a script.</span>
    <span class="keyword">if</span> ((name.length > <span class="number">2</span>) &amp;&amp; (name[<span class="number">0</span>] == <span class="string">'o'</span>) &amp;&amp; (name[<span class="number">1</span>] == <span class="string">'n'</span>)) {
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        self[name] = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="comment">// The handler code probably refers to functions declared in the</span>
            <span class="comment">// window context, so we need to call run().</span>
            <span class="keyword">if</span> (self.run != <span class="literal">undefined</span>) {
                <span class="comment">// We're the window. This can happen because inline handlers</span>
                <span class="comment">// on the body are proxied to the window.</span>
                self.run(value);
            } <span class="keyword">else</span> {
                <span class="comment">// We're an element.</span>
                self._ownerDocument.parentWindow.run(value);
            }
        };
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>._ownerDocument) {
      <span class="keyword">var</span> attr = <span class="keyword">this</span>._ownerDocument.createAttribute(name);
      attr.value = value;
      <span class="keyword">this</span>._attributes.setNamedItem(attr);
    }

  }, <span class="comment">//raises: function(DOMException) {},</span>

  <span class="comment">/* returns string */</span>
  removeAttribute: <span class="keyword">function</span>(<span class="comment">/* string */</span> name) {
    <span class="keyword">if</span> (!<span class="keyword">this</span>._attributes.exists(name)) {
      <span class="keyword">return</span>;
    }

    <span class="keyword">this</span>._attributes.removeNamedItem(name);
  }, <span class="comment">// raises: function(DOMException) {},</span>

  <span class="comment">/* returns Attr */</span>
  getAttributeNode: <span class="keyword">function</span>(<span class="comment">/* string */</span> name) {
    <span class="keyword">return</span> <span class="keyword">this</span>._attributes.getNamedItem(name);
  },

  <span class="comment">/* returns Attr */</span>
  setAttributeNode: <span class="keyword">function</span>(<span class="comment">/* Attr */</span> newAttr) {
    <span class="keyword">var</span> prevNode = <span class="keyword">this</span>._attributes.getNamedItem(newAttr.name);
    <span class="keyword">if</span> (prevNode) {
      prevNode._ownerElement = <span class="literal">null</span>;
    }

    <span class="keyword">this</span>._attributes.setNamedItem(newAttr);

    <span class="keyword">return</span> (prevNode &amp;&amp; prevNode.specified) ? prevNode : <span class="literal">null</span>;
  }, <span class="comment">//  raises: function(DOMException) {},</span>

  <span class="comment">/* returns Attr */</span>
  removeAttributeNode: <span class="keyword">function</span>(<span class="comment">/* Attr */</span> oldAttr) {
    <span class="keyword">var</span> existingAttr = <span class="keyword">this</span>._attributes.getNamedItem(oldAttr.name);

    <span class="keyword">if</span> (<span class="keyword">this</span>._attributes &amp;&amp; existingAttr === oldAttr) {
      <span class="keyword">this</span>._attributes.removeNamedItem(oldAttr.name);
      <span class="keyword">return</span> oldAttr;
    }

    <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NOT_FOUND_ERR);
  }, <span class="comment">//raises: function(DOMException) {},</span>

  <span class="comment">/* returns NodeList */</span>
  getElementsByTagName: <span class="keyword">function</span>(<span class="comment">/* string */</span> name) {
    name = name.toLowerCase();

    <span class="function"><span class="keyword">function</span> <span class="title">filterByTagName</span><span class="params">(child)</span> {</span>
      child = (child.nodeType === ENTITY_REFERENCE_NODE) ?
               child._entity                             :
               child;

      <span class="keyword">if</span> (child.nodeName &amp;&amp; child.nodeType === ELEMENT_NODE) {
        <span class="keyword">return</span> name === <span class="string">"*"</span> || (child.nodeName.toLowerCase() === name);
      }

      <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">return</span> <span class="keyword">new</span> core.NodeList(<span class="keyword">this</span>._ownerDocument || <span class="keyword">this</span>, core.mapper(<span class="keyword">this</span>, filterByTagName, <span class="literal">true</span>));
  },
};
core.Element.prototype.__proto__ = core.Node.prototype;

core.DocumentFragment = <span class="function"><span class="keyword">function</span> <span class="title">DocumentFragment</span><span class="params">(document)</span> {</span>
  core.Node.call(<span class="keyword">this</span>, document);
  <span class="keyword">this</span>._nodeName = <span class="keyword">this</span>._tagName = <span class="string">"#document-fragment"</span>;
};
core.DocumentFragment.prototype = {
  nodeType : DOCUMENT_FRAGMENT_NODE,
  get nodeValue() { <span class="keyword">return</span> <span class="literal">null</span>;},
  set nodeValue() { <span class="comment">/* do nothing */</span> },
  get attributes() { <span class="keyword">return</span> <span class="literal">null</span>;}
};
core.DocumentFragment.prototype.__proto__ = core.Node.prototype;

core.ProcessingInstruction = <span class="function"><span class="keyword">function</span> <span class="title">ProcessingInstruction</span><span class="params">(document, target, data)</span> {</span>
  <span class="keyword">this</span>._ownerDocument = document;
  core.Node.call(<span class="keyword">this</span>, document);
  <span class="keyword">this</span>._nodeName = target;
  <span class="keyword">this</span>._tagName = target;
  <span class="keyword">this</span>._target = target;
  <span class="keyword">this</span>._nodeValue = data;
}
core.ProcessingInstruction.prototype = {
  nodeType : PROCESSING_INSTRUCTION_NODE,
  get target() { <span class="keyword">return</span> <span class="keyword">this</span>._target;},
  set target(value) { <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(<span class="number">1</span>);},
  get nodeValue() { <span class="keyword">return</span> <span class="keyword">this</span>._nodeValue;},
  set nodeValue(value) { <span class="keyword">this</span>._nodeValue = value},
  get data()   { <span class="keyword">return</span> <span class="keyword">this</span>._nodeValue;},
  set data()   { <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR);},
  get attributes() { <span class="keyword">return</span> <span class="literal">null</span>;}

};
core.ProcessingInstruction.prototype.__proto__ = core.Node.prototype;

core.Document = <span class="function"><span class="keyword">function</span> <span class="title">Document</span><span class="params">(options)</span> {</span>
  <span class="keyword">if</span> (!options) {
    options = {};
  }
  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">'string'</span>) {
    options = {
      name: options
    };
  }
  core.Node.call(<span class="keyword">this</span>, <span class="string">"#document"</span>);
  <span class="keyword">this</span>._nodeName = <span class="keyword">this</span>._tagName = <span class="string">"#document"</span>;
  <span class="keyword">this</span>._contentType = options.contentType || <span class="string">"text/xml"</span>;
  <span class="keyword">this</span>._doctype = options._doctype;
  <span class="keyword">this</span>._implementation = options.implementation || <span class="keyword">new</span> (core.DOMImplementation)();
  <span class="keyword">this</span>._documentElement = <span class="literal">null</span>;
  <span class="keyword">this</span>._ids = {};
  <span class="keyword">this</span>._attached = <span class="literal">true</span>;
  <span class="keyword">this</span>._ownerDocument = <span class="keyword">this</span>;
  <span class="keyword">this</span>._readonly = <span class="literal">false</span>;
};


<span class="keyword">var</span> tagRegEx = <span class="regexp">/[^\w:\d_\.-]+/i</span>;
<span class="keyword">var</span> entRegEx = <span class="regexp">/[^\w\d_\-&amp;;]+/</span>;
<span class="keyword">var</span> invalidAttrRegEx = <span class="regexp">/[^\w:\d_\.-]+/</span>;

core.Document.prototype = {
  nodeType : DOCUMENT_NODE,
  _elementBuilders : {
    canvas : <span class="keyword">function</span>(document, tagName) {
      <span class="keyword">var</span> element = <span class="keyword">new</span> core.Element(document, tagName),
          canvas;

      <span class="comment">// require node-canvas and catch the error if it blows up</span>
      <span class="keyword">try</span> {
        canvas = <span class="keyword">new</span> (require(<span class="string">'canvas'</span>))(<span class="number">0</span>,<span class="number">0</span>);
        <span class="keyword">for</span> (attr <span class="keyword">in</span> element) {
          <span class="keyword">if</span> (!canvas[attr]) {
            canvas[attr] = element[attr];
          }
        }
        <span class="keyword">return</span> canvas;
      } <span class="keyword">catch</span> (e) {
        <span class="keyword">return</span> element;
      }
    }
  },
  _defaultElementBuilder: <span class="keyword">function</span>(document, tagName) {
    <span class="keyword">return</span> <span class="keyword">new</span> core.Element(document, tagName);
  },
  get contentType() { <span class="keyword">return</span> <span class="keyword">this</span>._contentType;},
  get doctype() { <span class="keyword">return</span> <span class="keyword">this</span>._doctype || <span class="literal">null</span>;},
  set doctype(doctype) { <span class="keyword">this</span>._doctype = doctype;},
  get documentElement() {
    <span class="keyword">if</span> (<span class="keyword">this</span>._documentElement) {
      <span class="keyword">return</span> <span class="keyword">this</span>._documentElement;
    } <span class="keyword">else</span> {
      <span class="keyword">var</span> children = <span class="keyword">this</span>._childNodes, len = <span class="keyword">this</span>._childNodes.length, i=<span class="number">0</span>;
      <span class="keyword">for</span> (i;i&lt;len;i++) {
        <span class="keyword">if</span> (children[i].nodeType === ELEMENT_NODE) {
          <span class="keyword">this</span>._documentElement = children[i];
          <span class="keyword">return</span> children[i];
        }
      }
      <span class="keyword">return</span> <span class="literal">null</span>;
    }
  },

  get implementation() { <span class="keyword">return</span> <span class="keyword">this</span>._implementation;},
  set implementation(implementation) { <span class="keyword">this</span>._implementation = implementation;},
  get nodeName() { <span class="keyword">return</span> <span class="string">'#document'</span>; },
  get tagName() {
    <span class="keyword">return</span> <span class="literal">null</span>;
  },
  get nodeValue() { <span class="keyword">return</span> <span class="literal">null</span>; },
  set nodeValue() { <span class="comment">/* noop */</span> },
  get attributes() { <span class="keyword">return</span> <span class="literal">null</span>;},
  get ownerDocument() { <span class="keyword">return</span> <span class="literal">null</span>;},
  get readonly() { <span class="keyword">return</span> <span class="keyword">this</span>._readonly;},
  <span class="comment">/* returns Element */</span>
  createElement: <span class="keyword">function</span>(<span class="comment">/* string */</span> tagName) {
    <span class="keyword">var</span> c = [], lower = tagName.toLowerCase(), element;

    <span class="keyword">if</span> (!tagName || !tagName.match || (c = tagName.match(tagRegEx))) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(INVALID_CHARACTER_ERR, <span class="string">'Invalid character in tag name: '</span> + c.pop());
    }

    element = (<span class="keyword">this</span>._elementBuilders[lower] || <span class="keyword">this</span>._defaultElementBuilder)(<span class="keyword">this</span>, tagName);

    <span class="comment">// Check for and introduce default elements</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>._doctype &amp;&amp; <span class="keyword">this</span>._doctype._attributes &amp;&amp; <span class="keyword">this</span>._doctype.name.toLowerCase() !== <span class="string">"html"</span>) {
      <span class="keyword">var</span> attrElement = <span class="keyword">this</span>._doctype._attributes.getNamedItem(tagName);
      <span class="keyword">if</span> (attrElement &amp;&amp; attrElement._childNodes) {

        attrs = attrElement.attributes;
        <span class="keyword">var</span> attr, len = attrs.length, defaultAttr;
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) {
          defaultAttr = attrs.item(i);
          <span class="keyword">if</span> (defaultAttr) {
            attr = <span class="keyword">this</span>.createAttribute(defaultAttr.name);
            attr.value = defaultAttr.value;
            element.setAttributeNode(attr);
            attr._specified = <span class="literal">false</span>;
          }
        }
      }
    }

    element._created = <span class="literal">true</span>;
    <span class="keyword">return</span> element;
  }, <span class="comment">//raises: function(DOMException) {},</span>

  <span class="comment">/* returns DocumentFragment */</span>
  createDocumentFragment: <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="keyword">new</span> core.DocumentFragment(<span class="keyword">this</span>);
  },

  <span class="comment">/* returns Text */</span>
  createTextNode: <span class="keyword">function</span>(<span class="comment">/* string */</span> data) {
    <span class="keyword">return</span> <span class="keyword">new</span> core.Text(<span class="keyword">this</span>,data);
  },

  <span class="comment">/* returns Comment */</span>
  createComment: <span class="keyword">function</span>(<span class="comment">/* string */</span> data) {
    <span class="keyword">return</span> <span class="keyword">new</span> core.Comment(<span class="keyword">this</span>,data);
  },

  <span class="comment">/* returns CDATASection */</span>
  createCDATASection: <span class="keyword">function</span>(<span class="comment">/* string */</span> data) {
    <span class="keyword">if</span> (<span class="keyword">this</span>._doctype &amp;&amp; <span class="keyword">this</span>._doctype.name === <span class="string">"html"</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NOT_SUPPORTED_ERR);
    }

    <span class="keyword">return</span> <span class="keyword">new</span> core.CDATASection(<span class="keyword">this</span>,data);
  }, <span class="comment">// raises: function(DOMException) {},</span>

  <span class="comment">/* returns ProcessingInstruction */</span>
  createProcessingInstruction: <span class="keyword">function</span>(<span class="comment">/* string */</span> target,<span class="comment">/* string */</span> data) {

    <span class="keyword">if</span> (<span class="keyword">this</span>._doctype &amp;&amp; <span class="keyword">this</span>._doctype.name === <span class="string">"html"</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NOT_SUPPORTED_ERR);
    }

    <span class="keyword">if</span> (target.match(tagRegEx) || !target || !target.length) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(INVALID_CHARACTER_ERR);
    }

    <span class="keyword">return</span> <span class="keyword">new</span> core.ProcessingInstruction(<span class="keyword">this</span>, target, data);
  }, <span class="comment">// raises: function(DOMException) {},</span>

  <span class="comment">/* returns Attr */</span>
  createAttribute: <span class="keyword">function</span>(<span class="comment">/* string */</span> name) {
    <span class="keyword">if</span> (!name || !name.length || name.match(invalidAttrRegEx) ) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(INVALID_CHARACTER_ERR, <span class="string">"attribute name: "</span> + name);
    }
    <span class="keyword">return</span> <span class="keyword">new</span> core.Attr(<span class="keyword">this</span>, name,<span class="literal">false</span>);
  }, <span class="comment">// raises: function(DOMException) {},</span>

  <span class="comment">/* returns EntityReference */</span>
  createEntityReference: <span class="keyword">function</span>(<span class="comment">/* string */</span> name) {

    <span class="keyword">if</span> (<span class="keyword">this</span>._doctype &amp;&amp; <span class="keyword">this</span>._doctype.name === <span class="string">"html"</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NOT_SUPPORTED_ERR);
    }

    name = name.replace(<span class="regexp">/[&amp;;]/g</span>,<span class="string">""</span>);
    <span class="keyword">if</span> (!name || !name.length) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(INVALID_CHARACTER_ERR);
    }

    <span class="keyword">if</span> (name.match(tagRegEx)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(INVALID_CHARACTER_ERR);
    }

    <span class="keyword">var</span> entity;
    <span class="keyword">if</span> (<span class="keyword">this</span>._doctype &amp;&amp; <span class="keyword">this</span>._doctype.entities) {
      entity = <span class="keyword">this</span>._doctype.entities.getNamedItem(name);
    } <span class="keyword">else</span> {
      entity = <span class="literal">null</span>;
    }

    <span class="keyword">var</span> ref    = <span class="keyword">new</span> core.EntityReference(<span class="keyword">this</span>, entity);

    ref._entityName = name;

    <span class="keyword">return</span> ref;
  }, <span class="comment">//raises: function(DOMException) {},</span>

  <span class="comment">/* returns Entity */</span>
  createEntityNode : <span class="keyword">function</span>(<span class="comment">/* string */</span> name)
  {

    <span class="keyword">if</span> (name.match(entRegEx) || !name || !name.length) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(INVALID_CHARACTER_ERR);
    }

    <span class="keyword">var</span> ret = <span class="keyword">new</span> core.Entity(<span class="keyword">this</span>, name);
    ret._readonly = <span class="literal">false</span>;<span class="comment">// TODO: fix me please.</span>

    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">1</span>;i&lt;arguments.length;i++)
    {
      ret.appendChild(arguments[i]);
    }

    core.markTreeReadonly(ret);

    <span class="keyword">return</span> ret;
  },

  <span class="comment">/* returns Notation */</span>
  createNotationNode : <span class="keyword">function</span>(<span class="comment">/* string */</span> name,<span class="comment">/* string */</span> publicId,<span class="comment">/* string */</span> systemId)
  {

    <span class="keyword">if</span> (name.match(entRegEx) || !name || !name.length) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(INVALID_CHARACTER_ERR);
    }

    <span class="keyword">var</span> ret = <span class="keyword">new</span> core.Notation(<span class="keyword">this</span>, name, publicId, systemId);
    ret._readonly = <span class="literal">false</span>;<span class="comment">// TODO: fix me please.</span>

    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">3</span>;i&lt;arguments.length;i++)
    {
      ret.appendChild(arguments[i]);
    }

    core.markTreeReadonly(ret);

    <span class="keyword">return</span> ret;
  },

  appendChild : <span class="keyword">function</span>(<span class="comment">/* Node */</span> arg) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.documentElement &amp;&amp; arg.nodeType == ELEMENT_NODE) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(HIERARCHY_REQUEST_ERR);
    }
    <span class="keyword">return</span> core.Node.prototype.appendChild.call(<span class="keyword">this</span>, arg);
  },

  removeChild : <span class="keyword">function</span>(<span class="comment">/* Node */</span> arg) {
    <span class="keyword">var</span> ret = core.Node.prototype.removeChild.call(<span class="keyword">this</span>, arg);
    <span class="keyword">if</span> (arg == <span class="keyword">this</span>._documentElement) {
      <span class="keyword">this</span>._documentElement = <span class="literal">null</span>;<span class="comment">// force a recalculation</span>
    }
    <span class="keyword">return</span> ret;
  },

  <span class="comment">/* returns NodeList */</span>
  getElementsByTagName: <span class="keyword">function</span>(<span class="comment">/* string */</span> name) {
    <span class="function"><span class="keyword">function</span> <span class="title">filterByTagName</span><span class="params">(child)</span> {</span>
      <span class="keyword">if</span> (child.nodeType &amp;&amp; child.nodeType === ENTITY_REFERENCE_NODE)
      {
        child = child._entity;
      }

      <span class="keyword">if</span> (child.nodeName &amp;&amp; child.nodeType === ELEMENT_NODE)
      {
        <span class="keyword">if</span> (name === <span class="string">"*"</span>) {
          <span class="keyword">return</span> <span class="literal">true</span>;

        <span class="comment">// case insensitivity for html</span>
        } <span class="keyword">else</span> <span class="keyword">if</span> (child._ownerDocument &amp;&amp; child._ownerDocument._doctype &amp;&amp;
                   <span class="comment">//child._ownerDocument._doctype.name === "html" &amp;&amp;</span>
                   child.nodeName.toLowerCase() === name.toLowerCase())
        {
          <span class="keyword">return</span> <span class="literal">true</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (child.nodeName.toLowerCase() === name.toLowerCase()) {
          <span class="keyword">return</span> <span class="literal">true</span>;
        }
      }
      <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">return</span> <span class="keyword">new</span> core.NodeList(<span class="keyword">this</span>.documentElement || <span class="keyword">this</span>, core.mapper(<span class="keyword">this</span>, filterByTagName, <span class="literal">true</span>));
  }
};
core.Document.prototype.__proto__ = core.Node.prototype;

core.CharacterData = <span class="function"><span class="keyword">function</span> <span class="title">CharacterData</span><span class="params">(document, value)</span> {</span>
  core.Node.call(<span class="keyword">this</span>, document);

  <span class="keyword">this</span>._nodeValue = (value) ? value + <span class="string">""</span> : <span class="string">""</span>;
};
core.CharacterData.prototype = {

  get data() { <span class="keyword">return</span> <span class="keyword">this</span>._nodeValue;},
  set data(data) {

    <span class="comment">// readonly</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>._readonly === <span class="literal">true</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR);
    }

    <span class="keyword">this</span>._nodeValue = data;
  },

  <span class="comment">/* returns int */</span>
  get length() { <span class="keyword">return</span> <span class="keyword">this</span>._nodeValue.length || <span class="number">0</span>;},

  <span class="comment">/* returns string */</span>
  substringData: <span class="keyword">function</span>(<span class="comment">/* int */</span> offset, <span class="comment">/* int */</span> count) {

    <span class="keyword">if</span> (count &lt; <span class="number">0</span> || offset &lt; <span class="number">0</span> || offset > <span class="keyword">this</span>._nodeValue.length) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(INDEX_SIZE_ERR);
    }

    <span class="keyword">return</span> (<span class="keyword">this</span>._nodeValue.length &lt; offset + count) ?
            <span class="keyword">this</span>._nodeValue.substring(offset) :
            <span class="keyword">this</span>._nodeValue.substring(offset, offset+count);

  }, <span class="comment">// raises: function(DOMException) {},</span>

  <span class="comment">/* returns string */</span>
  appendData: <span class="keyword">function</span>(<span class="comment">/* string */</span> arg) {

    <span class="comment">// readonly</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>._readonly === <span class="literal">true</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR);
    }

    <span class="keyword">this</span>._nodeValue+=arg;
    <span class="keyword">return</span> <span class="keyword">this</span>._nodeValue;
  }, <span class="comment">// raises: function(DOMException) {},</span>

  <span class="comment">/* returns string */</span>
  insertData: <span class="keyword">function</span>(<span class="comment">/* int */</span> offset, <span class="comment">/* string */</span> arg) {

    <span class="comment">// readonly</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>._readonly === <span class="literal">true</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR);
    }

    <span class="keyword">if</span> (offset &lt; <span class="number">0</span> || offset > <span class="keyword">this</span>._nodeValue.length) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(INDEX_SIZE_ERR);
    }

    <span class="keyword">var</span> start = <span class="keyword">this</span>._nodeValue.substring(<span class="number">0</span>,offset);
    <span class="keyword">var</span> end = <span class="keyword">this</span>._nodeValue.substring(offset);

    <span class="keyword">this</span>._nodeValue = start + arg + end;

  }, <span class="comment">//raises: function(DOMException) {},</span>

  <span class="comment">/* returns void */</span>
  deleteData: <span class="keyword">function</span>(<span class="comment">/* int */</span> offset, <span class="comment">/* int */</span> count) {

    <span class="comment">// readonly</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>._readonly === <span class="literal">true</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR);
    }

    <span class="keyword">if</span> (offset       &lt; <span class="number">0</span>                     ||
        offset       > <span class="keyword">this</span>._nodeValue.length ||
        count        &lt; <span class="number">0</span>)
    {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(INDEX_SIZE_ERR);
    }

    <span class="keyword">var</span> start = <span class="keyword">this</span>._nodeValue.substring(<span class="number">0</span>,offset);

    <span class="keyword">this</span>._nodeValue = (offset+count&lt;<span class="keyword">this</span>._nodeValue.length) ?
                     start + <span class="keyword">this</span>._nodeValue.substring(offset+count) :
                     start;
  }, <span class="comment">// raises: function(DOMException) {},</span>

  <span class="comment">/* returns void */</span>
  replaceData: <span class="keyword">function</span>(<span class="comment">/* int */</span> offset, <span class="comment">/* int */</span> count, <span class="comment">/* string */</span> arg) {

    <span class="comment">// readonly</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>._readonly === <span class="literal">true</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR);
    }

    count = (offset+count > <span class="keyword">this</span>._nodeValue.length) ?
             <span class="keyword">this</span>.nodeValue.length-offset           :
             count;

    <span class="keyword">if</span> (offset       &lt; <span class="number">0</span>                     ||
        offset       > <span class="keyword">this</span>._nodeValue.length ||
        count        &lt; <span class="number">0</span>                     <span class="comment">/*||
        offset+count > this._nodeValue.length*/</span>)
    {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(INDEX_SIZE_ERR);
    }

    <span class="keyword">var</span> start = <span class="keyword">this</span>._nodeValue.substring(<span class="number">0</span>,offset);
    <span class="keyword">var</span> end = <span class="keyword">this</span>._nodeValue.substring(offset+count);

    <span class="keyword">this</span>._nodeValue = start + arg + end;
  } <span class="comment">// raises: function(DOMException) {},</span>
};
core.CharacterData.prototype.__proto__ = core.Node.prototype;


core.Attr = <span class="function"><span class="keyword">function</span> <span class="title">Attr</span><span class="params">(document, name, value)</span> {</span>
  core.Node.call(<span class="keyword">this</span>, document);
  <span class="keyword">this</span>._nodeValue = value;
  <span class="keyword">this</span>._name = name;
  <span class="keyword">this</span>._specified = (value) ? <span class="literal">true</span> : <span class="literal">false</span>;
  <span class="keyword">this</span>._tagName   = name;
  <span class="keyword">this</span>._nodeName  = name;
};
core.Attr.prototype =  {
  nodeType : ATTRIBUTE_NODE,
  get nodeValue() {
    <span class="keyword">var</span> val = <span class="string">''</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>,len=<span class="keyword">this</span>._childNodes.length;i&lt;len;i++) {
      <span class="keyword">var</span> child = <span class="keyword">this</span>._childNodes[i];
      <span class="keyword">if</span> (child.nodeType === ENTITY_REFERENCE_NODE) {
        val += child.childNodes.reduce(<span class="keyword">function</span>(prev, c) {
          <span class="keyword">return</span> prev += (c.nodeValue || c);
        }, <span class="string">''</span>);
      } <span class="keyword">else</span> {
        val += child.nodeValue;
      }
    }
    <span class="keyword">return</span> val;
  },
  set nodeValue(value) {
    <span class="comment">// readonly</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>._readonly) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR);
    }

    <span class="keyword">this</span>._childNodes.length = <span class="number">0</span>;
    <span class="keyword">this</span>._childNodes.push(<span class="keyword">this</span>._ownerDocument.createTextNode(value));
    <span class="keyword">this</span>._modified();
    <span class="keyword">this</span>._specified = <span class="literal">true</span>;
    <span class="keyword">var</span> prev = <span class="keyword">this</span>._nodeValue;
    <span class="keyword">this</span>._nodeValue = value;
    <span class="keyword">if</span> (<span class="keyword">this</span>._ownerElement) {
      <span class="keyword">this</span>._ownerElement._attrModified(<span class="keyword">this</span>._name, value, prev);
    }
  },
  get name() { <span class="keyword">return</span> <span class="keyword">this</span>._name;},
  get specified() { <span class="keyword">return</span> <span class="keyword">this</span>._specified },
  get value() {
    <span class="keyword">return</span> <span class="keyword">this</span>.nodeValue;
  },
  set value(value) {
    <span class="keyword">this</span>.nodeValue = value;
  },
  get parentNode() { <span class="keyword">return</span> <span class="literal">null</span>;},
  get attributes() { <span class="keyword">return</span> <span class="literal">null</span>;},

  insertBefore : <span class="keyword">function</span>(<span class="comment">/* Node */</span> newChild, <span class="comment">/* Node*/</span> refChild){
    <span class="keyword">if</span> (newChild.nodeType === CDATA_SECTION_NODE ||
        newChild.nodeType === ELEMENT_NODE)
    {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(HIERARCHY_REQUEST_ERR);
    }

    <span class="keyword">return</span> core.Node.prototype.insertBefore.call(<span class="keyword">this</span>, newChild, refChild);
  },

  appendChild : <span class="keyword">function</span>(<span class="comment">/* Node */</span> arg) {

    <span class="keyword">if</span> (arg.nodeType === CDATA_SECTION_NODE ||
        arg.nodeType === ELEMENT_NODE)
    {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(HIERARCHY_REQUEST_ERR);
    }

    <span class="keyword">return</span> core.Node.prototype.appendChild.call(<span class="keyword">this</span>, arg);
  }

};
core.Attr.prototype.__proto__ = core.Node.prototype;

core.Text = <span class="function"><span class="keyword">function</span> <span class="title">Text</span><span class="params">(document, text, readonly)</span> {</span>
    core.CharacterData.call(<span class="keyword">this</span>, document, text);
    <span class="keyword">this</span>._nodeName = <span class="string">"#text"</span>;
    <span class="keyword">this</span>._readonly = readonly ? <span class="literal">true</span> : <span class="literal">false</span>
};
core.Text.prototype = {
  nodeType : TEXT_NODE,
  get attributes() { <span class="keyword">return</span> <span class="literal">null</span>;},
  get value() { <span class="keyword">return</span> <span class="keyword">this</span>._nodeValue;},
  set value(value) { <span class="keyword">this</span>.nodeValue = value;},

  <span class="comment">/* returns Text */</span>
  splitText: <span class="keyword">function</span>(offset) {

    <span class="comment">// readonly</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>._readonly) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(NO_MODIFICATION_ALLOWED_ERR);
    }

    <span class="keyword">if</span> (offset &lt; <span class="number">0</span> || offset > <span class="keyword">this</span>._nodeValue.length) {
      <span class="keyword">throw</span> <span class="keyword">new</span> core.DOMException(INDEX_SIZE_ERR);
    }

    <span class="keyword">var</span> newText = <span class="keyword">this</span>._nodeValue.substring(offset);
    <span class="keyword">this</span>._nodeValue = <span class="keyword">this</span>._nodeValue.substring(<span class="number">0</span>, offset);
    <span class="keyword">var</span> newNode = <span class="keyword">this</span>._ownerDocument.createTextNode(newText);

    <span class="keyword">if</span>(<span class="keyword">this</span>._parentNode.lastChild === <span class="keyword">this</span>) {
      <span class="keyword">this</span>._parentNode.appendChild(newNode);
    } <span class="keyword">else</span> {
      <span class="keyword">this</span>._parentNode.insertBefore(newNode, <span class="keyword">this</span>.nextSibling);
    }

    <span class="keyword">return</span> newNode;
  }, <span class="comment">//raises: function(DOMException) {},</span>
  toString: <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="keyword">this</span>.nodeName;
  }
};
core.Text.prototype.__proto__ = core.CharacterData.prototype


core.Comment = <span class="function"><span class="keyword">function</span> <span class="title">Comment</span><span class="params">(document, text)</span> {</span>
  core.Text.call(<span class="keyword">this</span>, document, text);
  <span class="keyword">this</span>._nodeName = <span class="string">"#comment"</span>;
  <span class="keyword">this</span>._tagName  = <span class="string">"#comment"</span>;
};
core.Comment.prototype = {
  nodeType : COMMENT_NODE
};
core.Comment.prototype.__proto__ = core.Text.prototype


core.CDATASection = <span class="function"><span class="keyword">function</span> <span class="title">CDATASection</span><span class="params">(document, value)</span> {</span>
  core.Text.call(<span class="keyword">this</span>, document, value);
  <span class="keyword">this</span>._nodeName = <span class="string">"#cdata-section"</span>;
};
core.CDATASection.prototype = {
  nodeType : CDATA_SECTION_NODE
};
core.CDATASection.prototype.__proto__ = core.Text.prototype

core.DocumentType = <span class="function"><span class="keyword">function</span> <span class="title">DocumentType</span><span class="params">(document, name, entities, notations, attributes)</span> {</span>
  core.Node.call(<span class="keyword">this</span>, document);
  <span class="keyword">this</span>._name = name;
  <span class="keyword">this</span>._tagName = name;
  <span class="keyword">this</span>._nodeName = name;
  <span class="keyword">this</span>._entities = entities || <span class="keyword">new</span> core.EntityNodeMap(document);
  <span class="keyword">this</span>._notations = notations || <span class="keyword">new</span> core.NotationNodeMap(document);

  core.markTreeReadonly(<span class="keyword">this</span>._notations);

  <span class="keyword">this</span>._attributes = attributes || <span class="keyword">new</span> core.AttrNodeMap(document);
};
core.DocumentType.prototype = {
  nodeType : DOCUMENT_TYPE_NODE,
  get nodeValue() { <span class="keyword">return</span> <span class="literal">null</span>;},
  set nodeValue() { <span class="comment">/* do nothing */</span> },
  get name() { <span class="keyword">return</span> <span class="keyword">this</span>._name;},
  get entities() { <span class="keyword">return</span> <span class="keyword">this</span>._entities;},
  get notations() { <span class="keyword">return</span> <span class="keyword">this</span>._notations;},
  get attributes() { <span class="keyword">return</span> <span class="literal">null</span>;}
};
core.DocumentType.prototype.__proto__ = core.Node.prototype;


core.Notation = <span class="function"><span class="keyword">function</span> <span class="title">Notation</span><span class="params">(document, name, publicId, systemId)</span>{</span>
  core.Node.call(<span class="keyword">this</span>, document);
  <span class="keyword">this</span>._name = name;
  <span class="keyword">this</span>._nodeName = name;
  <span class="keyword">this</span>._publicId = publicId || <span class="literal">null</span>;
  <span class="keyword">this</span>._systemId = systemId || <span class="literal">null</span>;
  <span class="keyword">this</span>._nodeValue = <span class="literal">null</span>;
};
core.Notation.prototype = {
  nodeType : NOTATION_NODE,
  get publicId() { <span class="keyword">return</span> <span class="keyword">this</span>._publicId;},
  get systemId() { <span class="keyword">return</span> <span class="keyword">this</span>._systemId;},
  get name() { <span class="keyword">return</span> <span class="keyword">this</span>._name || <span class="keyword">this</span>._nodeName;},
  get attributes() { <span class="comment">/* as per spec */</span> <span class="keyword">return</span> <span class="literal">null</span>;},
  set nodeValue() { <span class="comment">/* intentionally left blank */</span> },
  get nodeValue() { <span class="keyword">return</span> <span class="keyword">this</span>._nodeValue;},
};
core.Notation.prototype.__proto__ = core.Node.prototype;


core.Entity = <span class="function"><span class="keyword">function</span> <span class="title">Entity</span><span class="params">(document, name)</span> {</span>
  core.Node.call(<span class="keyword">this</span>, document);
  <span class="keyword">this</span>._name = name;
  <span class="keyword">this</span>._nodeName = name;
  <span class="keyword">this</span>._tagName = name;
  <span class="keyword">this</span>._publicId = <span class="literal">null</span>;
  <span class="keyword">this</span>._systemId = <span class="literal">null</span>;
  <span class="keyword">this</span>._notationName = <span class="literal">null</span>;
  <span class="keyword">this</span>._readonly = <span class="literal">true</span>;
};
core.Entity.prototype = {
  nodeType : ENTITY_NODE,
  get nodeValue() { <span class="keyword">return</span> <span class="literal">null</span>;},
  set nodeValue() {
    <span class="comment">// readonly</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>._readonly === <span class="literal">true</span>) {
      <span class="comment">// TODO: is this needed?</span>
      <span class="comment">// throw new DOMException(NO_MODIFICATION_ALLOWED_ERR);</span>
    }
    <span class="comment">/* do nothing */</span>
  },
  get name() { <span class="keyword">return</span> <span class="keyword">this</span>._name },
  get publicId() { <span class="keyword">return</span> <span class="keyword">this</span>._publicId;},
  get systemId() { <span class="keyword">return</span> <span class="keyword">this</span>._systemId;},

  set publicId(publicId) { <span class="keyword">this</span>._publicId = publicId;},
  set systemId(systemId) { <span class="keyword">this</span>._systemId = systemId;},
  set notationName(notationName) { <span class="keyword">this</span>._notationName = notationName;},

  get notationName() { <span class="keyword">return</span> <span class="keyword">this</span>._notationName;},
  get attributes() { <span class="keyword">return</span> <span class="literal">null</span>;},

};
core.Entity.prototype.__proto__ = core.Node.prototype;


core.EntityReference = <span class="function"><span class="keyword">function</span> <span class="title">EntityReference</span><span class="params">(document, entity)</span> {</span>
  core.Node.call(<span class="keyword">this</span>, document);
  <span class="keyword">this</span>._entity = entity;
  <span class="keyword">this</span>._nodeName = (entity) ? entity.name : <span class="literal">null</span>;
  <span class="keyword">this</span>._readonly = <span class="literal">true</span>;
};
core.EntityReference.prototype = {
  nodeType : ENTITY_REFERENCE_NODE,
  get nodeValue() { <span class="keyword">return</span> (<span class="keyword">this</span>._entity) ? <span class="keyword">this</span>._entity.nodeValue : <span class="literal">null</span>;},
  set nodeValue() {
    <span class="comment">// readonly</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>._readonly === <span class="literal">true</span>) {
      <span class="comment">// TODO: is this needed?</span>
      <span class="comment">//throw new DOMException(NO_MODIFICATION_ALLOWED_ERR);</span>
    }

    <span class="comment">/* do nothing */</span>
  },
  get attributes() { <span class="keyword">return</span> <span class="literal">null</span>;},

  <span class="comment">// Proxy to the entity</span>
  get nodeName() { <span class="keyword">return</span> <span class="keyword">this</span>._entityName;},
  get firstChild() { <span class="keyword">return</span> <span class="keyword">this</span>._entity.firstChild || <span class="literal">null</span>;},
  get childNodes() { <span class="keyword">return</span> <span class="keyword">this</span>._entity.childNodes;},
  get lastChild() { <span class="keyword">return</span> <span class="keyword">this</span>._entity.lastChild || <span class="literal">null</span>;},

};
core.EntityReference.prototype.__proto__ = core.Node.prototype;

exports.dom = { <span class="string">"level1"</span> : { <span class="string">"core"</span> : core }};
</code></pre>