<h1>index.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> createSizzle = require(<span class="string">"./sizzle"</span>);
exports.applyQuerySelector = <span class="keyword">function</span>(doc, dom) {
  <span class="keyword">var</span> addSizzle = <span class="keyword">function</span>(document) {

    <span class="keyword">if</span> (!document._sizzle) {
      document._sizzle = createSizzle(document);
    }
    <span class="keyword">return</span> document._sizzle;
  };

  doc.querySelector = <span class="keyword">function</span>(selector) {
    <span class="keyword">return</span> addSizzle(<span class="keyword">this</span>)(selector, <span class="keyword">this</span>)[<span class="number">0</span>];
  };

  doc.querySelectorAll = <span class="keyword">function</span>(selector) {
    <span class="keyword">return</span> <span class="keyword">new</span> dom.NodeList(addSizzle(<span class="keyword">this</span>)(selector, <span class="keyword">this</span>));
  };

  <span class="keyword">var</span> _createElement = doc.createElement;
  doc.createElement = <span class="keyword">function</span>() {
      <span class="keyword">var</span> element = _createElement.apply(<span class="keyword">this</span>, arguments);

      element.querySelector = <span class="keyword">function</span>(selector) {
        <span class="keyword">return</span> addSizzle(<span class="keyword">this</span>.ownerDocument)(selector, <span class="keyword">this</span>)[<span class="number">0</span>];
      };

      element.querySelectorAll = <span class="keyword">function</span>(selector) {
        <span class="keyword">var</span> el = <span class="keyword">this</span>;
        <span class="keyword">if</span> (!<span class="keyword">this</span>.parentNode) {
          el = <span class="keyword">this</span>.ownerDocument.createElement(<span class="string">"div"</span>);
          el.appendChild(<span class="keyword">this</span>);
        }
        <span class="keyword">return</span> <span class="keyword">new</span> dom.NodeList(addSizzle(<span class="keyword">this</span>.ownerDocument)(selector, el.parentNode || el));
      };

      <span class="keyword">return</span> element;
  };

};
</code></pre>