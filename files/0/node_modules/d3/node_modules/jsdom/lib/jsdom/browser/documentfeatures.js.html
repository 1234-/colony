<h1>documentfeatures.js</h1>
<pre><code class="lang-js">exports.availableDocumentFeatures = [
  <span class="string">'FetchExternalResources'</span>,
  <span class="string">'ProcessExternalResources'</span>,
  <span class="string">'MutationEvents'</span>,
  <span class="string">'QuerySelector'</span>
];

exports.defaultDocumentFeatures = {
  <span class="string">"FetchExternalResources"</span>   : [<span class="string">'script'</span><span class="comment">/*, 'img', 'css', 'frame', 'link'*/</span>],
  <span class="string">"ProcessExternalResources"</span> : [<span class="string">'script'</span><span class="comment">/*, 'frame', 'iframe'*/</span>],
  <span class="string">"MutationEvents"</span>           : <span class="string">'2.0'</span>,
  <span class="string">"QuerySelector"</span>            : <span class="literal">false</span>
};

exports.applyDocumentFeatures = <span class="keyword">function</span>(doc, features) {
  <span class="keyword">var</span> i, maxFeatures = exports.availableDocumentFeatures.length,
      defaultFeatures = exports.defaultDocumentFeatures,
      j,
      k,
      featureName,
      featureSource;

  features = features || {};

  <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;maxFeatures; i++) {
    featureName = exports.availableDocumentFeatures[i];
    <span class="keyword">if</span> (<span class="keyword">typeof</span> features[featureName] !== <span class="string">'undefined'</span>) {
      featureSource = features[featureName];
    <span class="comment">// We have to check the lowercase version also because the Document feature</span>
    <span class="comment">// methods convert everything to lowercase.</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> features[featureName.toLowerCase()] !== <span class="string">'undefined'</span>) {
      featureSource = features[featureName.toLowerCase()];
    } <span class="keyword">else</span> <span class="keyword">if</span> (defaultFeatures[featureName]) {
      featureSource = defaultFeatures[featureName];
    } <span class="keyword">else</span> {
      <span class="keyword">continue</span>;
    }

    doc.implementation.removeFeature(featureName);

    <span class="keyword">if</span> (<span class="keyword">typeof</span> featureSource !== <span class="string">'undefined'</span>) {
      <span class="keyword">if</span> (featureSource <span class="keyword">instanceof</span> Array) {
        k = featureSource.length;
        <span class="keyword">for</span> (j=<span class="number">0</span>; j&lt;k; j++) {
          doc.implementation.addFeature(featureName, featureSource[j]);
        }
      } <span class="keyword">else</span> {
        doc.implementation.addFeature(featureName, featureSource);
      }
    }
  }
};
</code></pre>