<h1>forever.js</h1>
<pre><code class="lang-js">module.exports = ForeverAgent
ForeverAgent.SSL = ForeverAgentSSL

<span class="keyword">var</span> util = require(<span class="string">'util'</span>)
  , Agent = require(<span class="string">'http'</span>).Agent
  , net = require(<span class="string">'net'</span>)
  , tls = require(<span class="string">'tls'</span>)
  , AgentSSL = require(<span class="string">'https'</span>).Agent

<span class="function"><span class="keyword">function</span> <span class="title">ForeverAgent</span><span class="params">(options)</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>
  self.options = options || {}
  self.requests = {}
  self.sockets = {}
  self.freeSockets = {}
  self.maxSockets = self.options.maxSockets || Agent.defaultMaxSockets
  self.minSockets = self.options.minSockets || ForeverAgent.defaultMinSockets
  self.on(<span class="string">'free'</span>, <span class="keyword">function</span>(socket, host, port) {
    <span class="keyword">var</span> name = host + <span class="string">':'</span> + port
    <span class="keyword">if</span> (self.requests[name] &amp;&amp; self.requests[name].length) {
      self.requests[name].shift().onSocket(socket)
    } <span class="keyword">else</span> <span class="keyword">if</span> (self.sockets[name].length &lt; self.minSockets) {
      <span class="keyword">if</span> (!self.freeSockets[name]) self.freeSockets[name] = []
      self.freeSockets[name].push(socket)
      
      <span class="comment">// if an error happens while we don't use the socket anyway, meh, throw the socket away</span>
      <span class="function"><span class="keyword">function</span> <span class="title">onIdleError</span><span class="params">()</span> {</span>
        socket.destroy()
      }
      socket._onIdleError = onIdleError
      socket.on(<span class="string">'error'</span>, onIdleError)
    } <span class="keyword">else</span> {
      <span class="comment">// If there are no pending requests just destroy the</span>
      <span class="comment">// socket and it will get removed from the pool. This</span>
      <span class="comment">// gets us out of timeout issues and allows us to</span>
      <span class="comment">// default to Connection:keep-alive.</span>
      socket.destroy();
    }
  })

}
util.inherits(ForeverAgent, Agent)

ForeverAgent.defaultMinSockets = <span class="number">5</span>


ForeverAgent.prototype.createConnection = net.createConnection
ForeverAgent.prototype.addRequestNoreuse = Agent.prototype.addRequest
ForeverAgent.prototype.addRequest = <span class="keyword">function</span>(req, host, port) {
  <span class="keyword">var</span> name = host + <span class="string">':'</span> + port
  <span class="keyword">if</span> (<span class="keyword">this</span>.freeSockets[name] &amp;&amp; <span class="keyword">this</span>.freeSockets[name].length > <span class="number">0</span> &amp;&amp; !req.useChunkedEncodingByDefault) {
    <span class="keyword">var</span> idleSocket = <span class="keyword">this</span>.freeSockets[name].pop()
    idleSocket.removeListener(<span class="string">'error'</span>, idleSocket._onIdleError)
    <span class="keyword">delete</span> idleSocket._onIdleError
    req._reusedSocket = <span class="literal">true</span>
    req.onSocket(idleSocket)
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.addRequestNoreuse(req, host, port)
  }
}

ForeverAgent.prototype.removeSocket = <span class="keyword">function</span>(s, name, host, port) {
  <span class="keyword">if</span> (<span class="keyword">this</span>.sockets[name]) {
    <span class="keyword">var</span> index = <span class="keyword">this</span>.sockets[name].indexOf(s);
    <span class="keyword">if</span> (index !== -<span class="number">1</span>) {
      <span class="keyword">this</span>.sockets[name].splice(index, <span class="number">1</span>);
    }
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.sockets[name] &amp;&amp; <span class="keyword">this</span>.sockets[name].length === <span class="number">0</span>) {
    <span class="comment">// don't leak</span>
    <span class="keyword">delete</span> <span class="keyword">this</span>.sockets[name];
    <span class="keyword">delete</span> <span class="keyword">this</span>.requests[name];
  }
  
  <span class="keyword">if</span> (<span class="keyword">this</span>.freeSockets[name]) {
    <span class="keyword">var</span> index = <span class="keyword">this</span>.freeSockets[name].indexOf(s)
    <span class="keyword">if</span> (index !== -<span class="number">1</span>) {
      <span class="keyword">this</span>.freeSockets[name].splice(index, <span class="number">1</span>)
      <span class="keyword">if</span> (<span class="keyword">this</span>.freeSockets[name].length === <span class="number">0</span>) {
        <span class="keyword">delete</span> <span class="keyword">this</span>.freeSockets[name]
      }
    }
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.requests[name] &amp;&amp; <span class="keyword">this</span>.requests[name].length) {
    <span class="comment">// If we have pending requests and a socket gets closed a new one</span>
    <span class="comment">// needs to be created to take over in the pool for the one that closed.</span>
    <span class="keyword">this</span>.createSocket(name, host, port).emit(<span class="string">'free'</span>);
  }
}

<span class="function"><span class="keyword">function</span> <span class="title">ForeverAgentSSL</span> <span class="params">(options)</span> {</span>
  ForeverAgent.call(<span class="keyword">this</span>, options)
}
util.inherits(ForeverAgentSSL, ForeverAgent)

ForeverAgentSSL.prototype.createConnection = createConnectionSSL
ForeverAgentSSL.prototype.addRequestNoreuse = AgentSSL.prototype.addRequest

<span class="function"><span class="keyword">function</span> <span class="title">createConnectionSSL</span> <span class="params">(port, host, options)</span> {</span>
  options.port = port
  options.host = host
  <span class="keyword">return</span> tls.connect(options)
}
</code></pre>