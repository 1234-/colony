<h1>form-data</h1>
<pre><code class="lang-js"><span class="keyword">var</span> CombinedStream = require(<span class="string">'combined-stream'</span>);
<span class="keyword">var</span> util = require(<span class="string">'util'</span>);
<span class="keyword">var</span> path = require(<span class="string">'path'</span>);
<span class="keyword">var</span> http = require(<span class="string">'http'</span>);
<span class="keyword">var</span> https = require(<span class="string">'https'</span>);
<span class="keyword">var</span> parseUrl = require(<span class="string">'url'</span>).parse;
<span class="keyword">var</span> fs = require(<span class="string">'fs'</span>);
<span class="keyword">var</span> mime = require(<span class="string">'mime'</span>);
<span class="keyword">var</span> async = require(<span class="string">'async'</span>);

module.exports = FormData;
<span class="function"><span class="keyword">function</span> <span class="title">FormData</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>._overheadLength = <span class="number">0</span>;
  <span class="keyword">this</span>._valueLength = <span class="number">0</span>;
  <span class="keyword">this</span>._lengthRetrievers = [];

  CombinedStream.call(<span class="keyword">this</span>);
}
util.inherits(FormData, CombinedStream);

FormData.LINE_BREAK = <span class="string">'\r\n'</span>;

FormData.prototype.append = <span class="keyword">function</span>(field, value) {
  <span class="keyword">var</span> append = CombinedStream.prototype.append.bind(<span class="keyword">this</span>);

  <span class="comment">// all that streamy business can't handle numbers</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> value == <span class="string">'number'</span>) value = <span class="string">''</span>+value;

  <span class="keyword">var</span> header = <span class="keyword">this</span>._multiPartHeader(field, value);
  <span class="keyword">var</span> footer = <span class="keyword">this</span>._multiPartFooter(field, value);

  append(header);
  append(value);
  append(footer);

  <span class="keyword">this</span>._trackLength(header, value)
};

FormData.prototype._trackLength = <span class="keyword">function</span>(header, value) {
  <span class="keyword">var</span> valueLength = <span class="number">0</span>;
  <span class="keyword">if</span> (Buffer.isBuffer(value)) {
    valueLength = value.length;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'string'</span>) {
    valueLength = Buffer.byteLength(value);
  }

  <span class="keyword">this</span>._valueLength += valueLength;
  <span class="keyword">this</span>._overheadLength +=
    Buffer.byteLength(header) +
    + FormData.LINE_BREAK.length;

  <span class="comment">// empty or ethier doesn't have path or not an http response</span>
  <span class="keyword">if</span> (!value || ( !value.path &amp;&amp; !(value.readable &amp;&amp; value.hasOwnProperty(<span class="string">'httpVersion'</span>)) )) {
    <span class="keyword">return</span>;
  }

  <span class="keyword">this</span>._lengthRetrievers.push(<span class="keyword">function</span>(next) {

    <span class="comment">// check if it's local file</span>
    <span class="keyword">if</span> (value.hasOwnProperty(<span class="string">'fd'</span>)) {
      fs.stat(value.path, <span class="keyword">function</span>(err, stat) {
        <span class="keyword">if</span> (err) {
          next(err);
          <span class="keyword">return</span>;
        }

        next(<span class="literal">null</span>, stat.size);
      });

    <span class="comment">// or http response</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (value.hasOwnProperty(<span class="string">'httpVersion'</span>)) {
      next(<span class="literal">null</span>, +value.headers[<span class="string">'content-length'</span>]);

    <span class="comment">// or request stream http://github.com/mikeal/request</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (value.hasOwnProperty(<span class="string">'httpModule'</span>)) {
      <span class="comment">// wait till response come back</span>
      value.on(<span class="string">'response'</span>, <span class="keyword">function</span>(response) {
        value.pause();
        next(<span class="literal">null</span>, +response.headers[<span class="string">'content-length'</span>]);
      });
      value.resume();

    <span class="comment">// something else</span>
    } <span class="keyword">else</span> {
      next(<span class="string">'Unknown stream'</span>);
    }
  });
};

FormData.prototype._multiPartHeader = <span class="keyword">function</span>(field, value) {
  <span class="keyword">var</span> boundary = <span class="keyword">this</span>.getBoundary();
  <span class="keyword">var</span> header =
    <span class="string">'--'</span> + boundary + FormData.LINE_BREAK +
    <span class="string">'Content-Disposition: form-data; name="'</span> + field + <span class="string">'"'</span>;

  <span class="comment">// fs- and request- streams have path property</span>
  <span class="comment">// TODO: Use request's response mime-type</span>
  <span class="keyword">if</span> (value.path) {
    header +=
      <span class="string">'; filename="'</span> + path.basename(value.path) + <span class="string">'"'</span> + FormData.LINE_BREAK +
      <span class="string">'Content-Type: '</span> + mime.lookup(value.path);

  <span class="comment">// http response has not</span>
  } <span class="keyword">else</span> <span class="keyword">if</span> (value.readable &amp;&amp; value.hasOwnProperty(<span class="string">'httpVersion'</span>)) {
    header +=
      <span class="string">'; filename="'</span> + path.basename(value.client._httpMessage.path) + <span class="string">'"'</span> + FormData.LINE_BREAK +
      <span class="string">'Content-Type: '</span> + value.headers[<span class="string">'content-type'</span>];
  }

  header += FormData.LINE_BREAK + FormData.LINE_BREAK;
  <span class="keyword">return</span> header;
};

FormData.prototype._multiPartFooter = <span class="keyword">function</span>(field, value) {
  <span class="keyword">return</span> <span class="keyword">function</span>(next) {
    <span class="keyword">var</span> footer = FormData.LINE_BREAK;

    <span class="keyword">var</span> lastPart = (<span class="keyword">this</span>._streams.length === <span class="number">0</span>);
    <span class="keyword">if</span> (lastPart) {
      footer += <span class="keyword">this</span>._lastBoundary();
    }

    next(footer);
  }.bind(<span class="keyword">this</span>);
};

FormData.prototype._lastBoundary = <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="string">'--'</span> + <span class="keyword">this</span>.getBoundary() + <span class="string">'--'</span>;
};

FormData.prototype.getHeaders = <span class="keyword">function</span>(userHeaders) {
  <span class="keyword">var</span> formHeaders = {
    <span class="string">'content-type'</span>: <span class="string">'multipart/form-data; boundary='</span> + <span class="keyword">this</span>.getBoundary()
  };

  <span class="keyword">for</span> (<span class="keyword">var</span> header <span class="keyword">in</span> userHeaders) {
    formHeaders[header.toLowerCase()] = userHeaders[header];
  }

  <span class="keyword">return</span> formHeaders;
}

FormData.prototype.getCustomHeaders = <span class="keyword">function</span>(contentType) {
    contentType = contentType ? contentType : <span class="string">'multipart/form-data'</span>;

    <span class="keyword">var</span> formHeaders = {
        <span class="string">'content-type'</span>: contentType + <span class="string">'; boundary='</span> + <span class="keyword">this</span>.getBoundary(),
        <span class="string">'content-length'</span>: <span class="keyword">this</span>.getLengthSync()
    };

    <span class="keyword">return</span> formHeaders;
}

FormData.prototype.getBoundary = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (!<span class="keyword">this</span>._boundary) {
    <span class="keyword">this</span>._generateBoundary();
  }

  <span class="keyword">return</span> <span class="keyword">this</span>._boundary;
};

FormData.prototype._generateBoundary = <span class="keyword">function</span>() {
  <span class="comment">// This generates a 50 character boundary similar to those used by Firefox.</span>
  <span class="comment">// They are optimized for boyer-moore parsing.</span>
  <span class="keyword">var</span> boundary = <span class="string">'--------------------------'</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">24</span>; i++) {
    boundary += Math.floor(Math.random() * <span class="number">10</span>).toString(<span class="number">16</span>);
  }

  <span class="keyword">this</span>._boundary = boundary;
};

FormData.prototype.getLengthSync = <span class="keyword">function</span>() {
    <span class="keyword">var</span> knownLength = <span class="keyword">this</span>._overheadLength + <span class="keyword">this</span>._valueLength;

    <span class="keyword">if</span> (<span class="keyword">this</span>._streams.length) {
        knownLength += <span class="keyword">this</span>._lastBoundary().length;
    }

    <span class="keyword">return</span> knownLength;
};

FormData.prototype.getLength = <span class="keyword">function</span>(cb) {
  <span class="keyword">var</span> knownLength = <span class="keyword">this</span>._overheadLength + <span class="keyword">this</span>._valueLength;

  <span class="keyword">if</span> (<span class="keyword">this</span>._streams.length) {
    knownLength += <span class="keyword">this</span>._lastBoundary().length;
  }

  <span class="keyword">if</span> (!<span class="keyword">this</span>._lengthRetrievers.length) {
    process.nextTick(cb.bind(<span class="keyword">this</span>, <span class="literal">null</span>, knownLength));
    <span class="keyword">return</span>;
  }

  async.parallel(<span class="keyword">this</span>._lengthRetrievers, <span class="keyword">function</span>(err, values) {
    <span class="keyword">if</span> (err) {
      cb(err);
      <span class="keyword">return</span>;
    }

    values.forEach(<span class="keyword">function</span>(length) {
      knownLength += length;
    });

    cb(<span class="literal">null</span>, knownLength);
  });
};

FormData.prototype.submit = <span class="keyword">function</span>(url, cb) {
  <span class="keyword">this</span>.getLength(<span class="keyword">function</span>(err, length) {
    <span class="keyword">var</span> request
      , parsedUrl = parseUrl(url)
      , options = {
          method: <span class="string">'post'</span>,
          port: parsedUrl.port || <span class="number">80</span>,
          path: parsedUrl.pathname,
          headers: <span class="keyword">this</span>.getHeaders({<span class="string">'Content-Length'</span>: length}),
          host: parsedUrl.hostname
        };

    <span class="keyword">if</span> (parsedUrl.protocol == <span class="string">'https:'</span>) {
      <span class="comment">// override default port</span>
      <span class="keyword">if</span> (!parsedUrl.port) options.port = <span class="number">443</span>;
      request = https.request(options);
    } <span class="keyword">else</span> {
      request = http.request(options);
    }

    <span class="keyword">this</span>.pipe(request);
    <span class="keyword">if</span> (cb) {
      request.on(<span class="string">'error'</span>, cb);
      request.on(<span class="string">'response'</span>, cb.bind(<span class="keyword">this</span>, <span class="literal">null</span>));
    }

    <span class="keyword">return</span> request;
  }.bind(<span class="keyword">this</span>));
};
</code></pre>