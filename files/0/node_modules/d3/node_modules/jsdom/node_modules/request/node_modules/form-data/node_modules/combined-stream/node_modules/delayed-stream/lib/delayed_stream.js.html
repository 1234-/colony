<h1>delayed-stream</h1>
<pre><code class="lang-js"><span class="keyword">var</span> Stream = require(<span class="string">'stream'</span>).Stream;
<span class="keyword">var</span> util = require(<span class="string">'util'</span>);

module.exports = DelayedStream;
<span class="function"><span class="keyword">function</span> <span class="title">DelayedStream</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>.source = <span class="literal">null</span>;
  <span class="keyword">this</span>.dataSize = <span class="number">0</span>;
  <span class="keyword">this</span>.maxDataSize = <span class="number">1024</span> * <span class="number">1024</span>;
  <span class="keyword">this</span>.pauseStream = <span class="literal">true</span>;

  <span class="keyword">this</span>._maxDataSizeExceeded = <span class="literal">false</span>;
  <span class="keyword">this</span>._released = <span class="literal">false</span>;
  <span class="keyword">this</span>._bufferedEvents = [];
}
util.inherits(DelayedStream, Stream);

DelayedStream.create = <span class="keyword">function</span>(source, options) {
  <span class="keyword">var</span> delayedStream = <span class="keyword">new</span> <span class="keyword">this</span>();

  options = options || {};
  <span class="keyword">for</span> (<span class="keyword">var</span> option <span class="keyword">in</span> options) {
    delayedStream[option] = options[option];
  }

  delayedStream.source = source;

  <span class="keyword">var</span> realEmit = source.emit;
  source.emit = <span class="keyword">function</span>() {
    delayedStream._handleEmit(arguments);
    <span class="keyword">return</span> realEmit.apply(source, arguments);
  };

  source.on(<span class="string">'error'</span>, <span class="keyword">function</span>() {});
  <span class="keyword">if</span> (delayedStream.pauseStream) {
    source.pause();
  }

  <span class="keyword">return</span> delayedStream;
};

DelayedStream.prototype.__defineGetter__(<span class="string">'readable'</span>, <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="keyword">this</span>.source.readable;
});

DelayedStream.prototype.resume = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (!<span class="keyword">this</span>._released) {
    <span class="keyword">this</span>.release();
  }

  <span class="keyword">this</span>.source.resume();
};

DelayedStream.prototype.pause = <span class="keyword">function</span>() {
  <span class="keyword">this</span>.source.pause();
};

DelayedStream.prototype.release = <span class="keyword">function</span>() {
  <span class="keyword">this</span>._released = <span class="literal">true</span>;

  <span class="keyword">this</span>._bufferedEvents.forEach(<span class="keyword">function</span>(args) {
    <span class="keyword">this</span>.emit.apply(<span class="keyword">this</span>, args);
  }.bind(<span class="keyword">this</span>));
  <span class="keyword">this</span>._bufferedEvents = [];
};

DelayedStream.prototype.pipe = <span class="keyword">function</span>() {
  <span class="keyword">var</span> r = Stream.prototype.pipe.apply(<span class="keyword">this</span>, arguments);
  <span class="keyword">this</span>.resume();
  <span class="keyword">return</span> r;
};

DelayedStream.prototype._handleEmit = <span class="keyword">function</span>(args) {
  <span class="keyword">if</span> (<span class="keyword">this</span>._released) {
    <span class="keyword">this</span>.emit.apply(<span class="keyword">this</span>, args);
    <span class="keyword">return</span>;
  }

  <span class="keyword">if</span> (args[<span class="number">0</span>] === <span class="string">'data'</span>) {
    <span class="keyword">this</span>.dataSize += args[<span class="number">1</span>].length;
    <span class="keyword">this</span>._checkIfMaxDataSizeExceeded();
  }

  <span class="keyword">this</span>._bufferedEvents.push(args);
};

DelayedStream.prototype._checkIfMaxDataSizeExceeded = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (<span class="keyword">this</span>._maxDataSizeExceeded) {
    <span class="keyword">return</span>;
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>.dataSize &lt;= <span class="keyword">this</span>.maxDataSize) {
    <span class="keyword">return</span>;
  }

  <span class="keyword">this</span>._maxDataSizeExceeded = <span class="literal">true</span>;
  <span class="keyword">var</span> message =
    <span class="string">'DelayedStream#maxDataSize of '</span> + <span class="keyword">this</span>.maxDataSize + <span class="string">' bytes exceeded.'</span>
  <span class="keyword">this</span>.emit(<span class="string">'error'</span>, <span class="keyword">new</span> Error(message));
};
</code></pre>