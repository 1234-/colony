<h1>parse.js</h1>
<pre><code class="lang-js"><span class="comment">//.CommonJS</span>
<span class="keyword">var</span> CSSOM = {};
<span class="comment">///CommonJS</span>


<span class="comment">/**
 * @param {string} token
 */</span>
CSSOM.parse = <span class="function"><span class="keyword">function</span> <span class="title">parse</span><span class="params">(token)</span> {</span>

	<span class="keyword">var</span> i = <span class="number">0</span>;

	<span class="comment">/**
	  "before-selector" or
	  "selector" or
	  "atRule" or
	  "atBlock" or
	  "before-name" or
	  "name" or
	  "before-value" or
	  "value"
	*/</span>
	<span class="keyword">var</span> state = <span class="string">"before-selector"</span>;

	<span class="keyword">var</span> index;
	<span class="keyword">var</span> buffer = <span class="string">""</span>;

	<span class="keyword">var</span> SIGNIFICANT_WHITESPACE = {
		<span class="string">"selector"</span>: <span class="literal">true</span>,
		<span class="string">"value"</span>: <span class="literal">true</span>,
		<span class="string">"atRule"</span>: <span class="literal">true</span>,
		<span class="string">"importRule-begin"</span>: <span class="literal">true</span>,
		<span class="string">"importRule"</span>: <span class="literal">true</span>,
		<span class="string">"atBlock"</span>: <span class="literal">true</span>
	};

	<span class="keyword">var</span> styleSheet = <span class="keyword">new</span> CSSOM.CSSStyleSheet;

	<span class="comment">// @type CSSStyleSheet|CSSMediaRule|CSSFontFaceRule|CSSKeyframesRule</span>
	<span class="keyword">var</span> currentScope = styleSheet;

	<span class="comment">// @type CSSMediaRule|CSSKeyframesRule</span>
	<span class="keyword">var</span> parentRule;

	<span class="keyword">var</span> selector, name, value, priority=<span class="string">""</span>, styleRule, mediaRule, importRule, fontFaceRule, keyframesRule, keyframeRule;

	<span class="keyword">var</span> atKeyframesRegExp = <span class="regexp">/@(-(?:\w+-)+)?keyframes/g</span>;

	<span class="keyword">var</span> parseError = <span class="keyword">function</span>(message) {
		<span class="keyword">var</span> lines = token.substring(<span class="number">0</span>, i).split(<span class="string">'\n'</span>);
		<span class="keyword">var</span> lineCount = lines.length;
		<span class="keyword">var</span> charCount = lines.pop().length + <span class="number">1</span>;
		<span class="keyword">var</span> error = <span class="keyword">new</span> Error(message + <span class="string">' (line '</span> + lineCount + <span class="string">', char '</span> + charCount + <span class="string">')'</span>);
		error.line = lineCount;
		error.char = charCount;
		error.styleSheet = styleSheet;
		<span class="keyword">throw</span> error;
	};

	<span class="keyword">for</span> (<span class="keyword">var</span> character; character = token.charAt(i); i++) {

		<span class="keyword">switch</span> (character) {

		<span class="keyword">case</span> <span class="string">" "</span>:
		<span class="keyword">case</span> <span class="string">"\t"</span>:
		<span class="keyword">case</span> <span class="string">"\r"</span>:
		<span class="keyword">case</span> <span class="string">"\n"</span>:
		<span class="keyword">case</span> <span class="string">"\f"</span>:
			<span class="keyword">if</span> (SIGNIFICANT_WHITESPACE[state]) {
				buffer += character;
			}
			<span class="keyword">break</span>;

		<span class="comment">// String</span>
		<span class="keyword">case</span> <span class="string">'"'</span>:
			index = token.indexOf(<span class="string">'"'</span>, i + <span class="number">1</span>) + <span class="number">1</span>;
			<span class="keyword">if</span> (!index) {
				parseError(<span class="string">'Unmatched "'</span>);
			}
			buffer += token.slice(i, index);
			i = index - <span class="number">1</span>;
			<span class="keyword">switch</span> (state) {
				<span class="keyword">case</span> <span class="string">'before-value'</span>:
					state = <span class="string">'value'</span>;
					<span class="keyword">break</span>;
				<span class="keyword">case</span> <span class="string">'importRule-begin'</span>:
					state = <span class="string">'importRule'</span>;
					<span class="keyword">break</span>;
			}
			<span class="keyword">break</span>;

		<span class="keyword">case</span> <span class="string">"'"</span>:
			index = token.indexOf(<span class="string">"'"</span>, i + <span class="number">1</span>) + <span class="number">1</span>;
			<span class="keyword">if</span> (!index) {
				parseError(<span class="string">"Unmatched '"</span>);
			}
			buffer += token.slice(i, index);
			i = index - <span class="number">1</span>;
			<span class="keyword">switch</span> (state) {
				<span class="keyword">case</span> <span class="string">'before-value'</span>:
					state = <span class="string">'value'</span>;
					<span class="keyword">break</span>;
				<span class="keyword">case</span> <span class="string">'importRule-begin'</span>:
					state = <span class="string">'importRule'</span>;
					<span class="keyword">break</span>;
			}
			<span class="keyword">break</span>;

		<span class="comment">// Comment</span>
		<span class="keyword">case</span> <span class="string">"/"</span>:
			<span class="keyword">if</span> (token.charAt(i + <span class="number">1</span>) === <span class="string">"*"</span>) {
				i += <span class="number">2</span>;
				index = token.indexOf(<span class="string">"*/"</span>, i);
				<span class="keyword">if</span> (index === -<span class="number">1</span>) {
					parseError(<span class="string">"Missing */"</span>);
				} <span class="keyword">else</span> {
					i = index + <span class="number">1</span>;
				}
			} <span class="keyword">else</span> {
				buffer += character;
			}
			<span class="keyword">if</span> (state === <span class="string">"importRule-begin"</span>) {
				buffer += <span class="string">" "</span>;
				state = <span class="string">"importRule"</span>;
			}
			<span class="keyword">break</span>;

		<span class="comment">// At-rule</span>
		<span class="keyword">case</span> <span class="string">"@"</span>:
			<span class="keyword">if</span> (token.indexOf(<span class="string">"@media"</span>, i) === i) {
				state = <span class="string">"atBlock"</span>;
				mediaRule = <span class="keyword">new</span> CSSOM.CSSMediaRule;
				mediaRule.__starts = i;
				i += <span class="string">"media"</span>.length;
				buffer = <span class="string">""</span>;
				<span class="keyword">break</span>;
			} <span class="keyword">else</span> <span class="keyword">if</span> (token.indexOf(<span class="string">"@import"</span>, i) === i) {
				state = <span class="string">"importRule-begin"</span>;
				i += <span class="string">"import"</span>.length;
				buffer += <span class="string">"@import"</span>;
				<span class="keyword">break</span>;
			} <span class="keyword">else</span> <span class="keyword">if</span> (token.indexOf(<span class="string">"@font-face"</span>, i) === i) {
				state = <span class="string">"fontFaceRule-begin"</span>;
				i += <span class="string">"font-face"</span>.length;
				fontFaceRule = <span class="keyword">new</span> CSSOM.CSSFontFaceRule;
				fontFaceRule.__starts = i;
				buffer = <span class="string">""</span>;
				<span class="keyword">break</span>;
			} <span class="keyword">else</span> {
				atKeyframesRegExp.lastIndex = i;
				<span class="keyword">var</span> matchKeyframes = atKeyframesRegExp.exec(token);
				<span class="keyword">if</span> (matchKeyframes &amp;&amp; matchKeyframes.index === i) {
					state = <span class="string">"keyframesRule-begin"</span>;
					keyframesRule = <span class="keyword">new</span> CSSOM.CSSKeyframesRule;
					keyframesRule.__starts = i;
					keyframesRule._vendorPrefix = matchKeyframes[<span class="number">1</span>]; <span class="comment">// Will come out as undefined if no prefix was found</span>
					i += matchKeyframes[<span class="number">0</span>].length - <span class="number">1</span>;
					buffer = <span class="string">""</span>;
					<span class="keyword">break</span>;
				} <span class="keyword">else</span> <span class="keyword">if</span> (state == <span class="string">"selector"</span>) {
					state = <span class="string">"atRule"</span>;
				}
			}
			buffer += character;
			<span class="keyword">break</span>;

		<span class="keyword">case</span> <span class="string">"{"</span>:
			<span class="keyword">if</span> (state === <span class="string">"selector"</span> || state === <span class="string">"atRule"</span>) {
				styleRule.selectorText = buffer.trim();
				styleRule.style.__starts = i;
				buffer = <span class="string">""</span>;
				state = <span class="string">"before-name"</span>;
			} <span class="keyword">else</span> <span class="keyword">if</span> (state === <span class="string">"atBlock"</span>) {
				mediaRule.media.mediaText = buffer.trim();
				currentScope = parentRule = mediaRule;
				mediaRule.parentStyleSheet = styleSheet;
				buffer = <span class="string">""</span>;
				state = <span class="string">"before-selector"</span>;
			} <span class="keyword">else</span> <span class="keyword">if</span> (state === <span class="string">"fontFaceRule-begin"</span>) {
				<span class="keyword">if</span> (parentRule) {
					fontFaceRule.parentRule = parentRule;
				}
				fontFaceRule.parentStyleSheet = styleSheet;
				styleRule = fontFaceRule;
				buffer = <span class="string">""</span>;
				state = <span class="string">"before-name"</span>;
			} <span class="keyword">else</span> <span class="keyword">if</span> (state === <span class="string">"keyframesRule-begin"</span>) {
				keyframesRule.name = buffer.trim();
				<span class="keyword">if</span> (parentRule) {
					keyframesRule.parentRule = parentRule;
				}
				keyframesRule.parentStyleSheet = styleSheet;
				currentScope = parentRule = keyframesRule;
				buffer = <span class="string">""</span>;
				state = <span class="string">"keyframeRule-begin"</span>;
			} <span class="keyword">else</span> <span class="keyword">if</span> (state === <span class="string">"keyframeRule-begin"</span>) {
				styleRule = <span class="keyword">new</span> CSSOM.CSSKeyframeRule;
				styleRule.keyText = buffer.trim();
				styleRule.__starts = i;
				buffer = <span class="string">""</span>;
				state = <span class="string">"before-name"</span>;
			}
			<span class="keyword">break</span>;

		<span class="keyword">case</span> <span class="string">":"</span>:
			<span class="keyword">if</span> (state === <span class="string">"name"</span>) {
				name = buffer.trim();
				buffer = <span class="string">""</span>;
				state = <span class="string">"before-value"</span>;
			} <span class="keyword">else</span> {
				buffer += character;
			}
			<span class="keyword">break</span>;

		<span class="keyword">case</span> <span class="string">'('</span>:
			<span class="keyword">if</span> (state === <span class="string">'value'</span>) {
				index = token.indexOf(<span class="string">')'</span>, i + <span class="number">1</span>);
				<span class="keyword">if</span> (index === -<span class="number">1</span>) {
					parseError(<span class="string">'Unmatched "("'</span>);
				}
				buffer += token.slice(i, index + <span class="number">1</span>);
				i = index;
			} <span class="keyword">else</span> {
				buffer += character;
			}
			<span class="keyword">break</span>;

		<span class="keyword">case</span> <span class="string">"!"</span>:
			<span class="keyword">if</span> (state === <span class="string">"value"</span> &amp;&amp; token.indexOf(<span class="string">"!important"</span>, i) === i) {
				priority = <span class="string">"important"</span>;
				i += <span class="string">"important"</span>.length;
			} <span class="keyword">else</span> {
				buffer += character;
			}
			<span class="keyword">break</span>;

		<span class="keyword">case</span> <span class="string">";"</span>:
			<span class="keyword">switch</span> (state) {
				<span class="keyword">case</span> <span class="string">"value"</span>:
					styleRule.style.setProperty(name, buffer.trim(), priority);
					priority = <span class="string">""</span>;
					buffer = <span class="string">""</span>;
					state = <span class="string">"before-name"</span>;
					<span class="keyword">break</span>;
				<span class="keyword">case</span> <span class="string">"atRule"</span>:
					buffer = <span class="string">""</span>;
					state = <span class="string">"before-selector"</span>;
					<span class="keyword">break</span>;
				<span class="keyword">case</span> <span class="string">"importRule"</span>:
					importRule = <span class="keyword">new</span> CSSOM.CSSImportRule;
					importRule.parentStyleSheet = importRule.styleSheet.parentStyleSheet = styleSheet;
					importRule.cssText = buffer + character;
					styleSheet.cssRules.push(importRule);
					buffer = <span class="string">""</span>;
					state = <span class="string">"before-selector"</span>;
					<span class="keyword">break</span>;
				<span class="keyword">default</span>:
					buffer += character;
					<span class="keyword">break</span>;
			}
			<span class="keyword">break</span>;

		<span class="keyword">case</span> <span class="string">"}"</span>:
			<span class="keyword">switch</span> (state) {
				<span class="keyword">case</span> <span class="string">"value"</span>:
					styleRule.style.setProperty(name, buffer.trim(), priority);
					priority = <span class="string">""</span>;
				<span class="keyword">case</span> <span class="string">"before-name"</span>:
				<span class="keyword">case</span> <span class="string">"name"</span>:
					styleRule.__ends = i + <span class="number">1</span>;
					<span class="keyword">if</span> (parentRule) {
						styleRule.parentRule = parentRule;
					}
					styleRule.parentStyleSheet = styleSheet;
					currentScope.cssRules.push(styleRule);
					buffer = <span class="string">""</span>;
					<span class="keyword">if</span> (currentScope.constructor === CSSOM.CSSKeyframesRule) {
						state = <span class="string">"keyframeRule-begin"</span>;
					} <span class="keyword">else</span> {
						state = <span class="string">"before-selector"</span>;
					}
					<span class="keyword">break</span>;
				<span class="keyword">case</span> <span class="string">"keyframeRule-begin"</span>:
				<span class="keyword">case</span> <span class="string">"before-selector"</span>:
				<span class="keyword">case</span> <span class="string">"selector"</span>:
					<span class="comment">// End of media rule.</span>
					<span class="keyword">if</span> (!parentRule) {
						parseError(<span class="string">"Unexpected }"</span>);
					}
					currentScope.__ends = i + <span class="number">1</span>;
					<span class="comment">// Nesting rules aren't supported yet</span>
					styleSheet.cssRules.push(currentScope);
					currentScope = styleSheet;
					parentRule = <span class="literal">null</span>;
					buffer = <span class="string">""</span>;
					state = <span class="string">"before-selector"</span>;
					<span class="keyword">break</span>;
			}
			<span class="keyword">break</span>;

		<span class="keyword">default</span>:
			<span class="keyword">switch</span> (state) {
				<span class="keyword">case</span> <span class="string">"before-selector"</span>:
					state = <span class="string">"selector"</span>;
					styleRule = <span class="keyword">new</span> CSSOM.CSSStyleRule;
					styleRule.__starts = i;
					<span class="keyword">break</span>;
				<span class="keyword">case</span> <span class="string">"before-name"</span>:
					state = <span class="string">"name"</span>;
					<span class="keyword">break</span>;
				<span class="keyword">case</span> <span class="string">"before-value"</span>:
					state = <span class="string">"value"</span>;
					<span class="keyword">break</span>;
				<span class="keyword">case</span> <span class="string">"importRule-begin"</span>:
					state = <span class="string">"importRule"</span>;
					<span class="keyword">break</span>;
			}
			buffer += character;
			<span class="keyword">break</span>;
		}
	}

	<span class="keyword">return</span> styleSheet;
};


<span class="comment">//.CommonJS</span>
exports.parse = CSSOM.parse;
<span class="comment">// The following modules cannot be included sooner due to the mutual dependency with parse.js</span>
CSSOM.CSSStyleSheet = require(<span class="string">"./CSSStyleSheet"</span>).CSSStyleSheet;
CSSOM.CSSStyleRule = require(<span class="string">"./CSSStyleRule"</span>).CSSStyleRule;
CSSOM.CSSImportRule = require(<span class="string">"./CSSImportRule"</span>).CSSImportRule;
CSSOM.CSSMediaRule = require(<span class="string">"./CSSMediaRule"</span>).CSSMediaRule;
CSSOM.CSSFontFaceRule = require(<span class="string">"./CSSFontFaceRule"</span>).CSSFontFaceRule;
CSSOM.CSSStyleDeclaration = require(<span class="string">'./CSSStyleDeclaration'</span>).CSSStyleDeclaration;
CSSOM.CSSKeyframeRule = require(<span class="string">'./CSSKeyframeRule'</span>).CSSKeyframeRule;
CSSOM.CSSKeyframesRule = require(<span class="string">'./CSSKeyframesRule'</span>).CSSKeyframesRule;
<span class="comment">///CommonJS</span>
</code></pre>